<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cheapest Flights Within K Stops - è¦–è¦ºåŒ–</title>
    <link rel="stylesheet" href="../assets/visualizer/style.css">
    <style>
        .custom-input-section { background: var(--viz-card-bg); border-radius: 8px; padding: 15px; margin-bottom: 15px; border: 1px solid var(--viz-border); }
        .input-row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .input-row button { padding: 8px 16px; border-radius: 6px; background: var(--viz-primary); color: white; border: none; cursor: pointer; }

        .graph-container { display: flex; gap: 20px; justify-content: center; flex-wrap: wrap; margin: 20px 0; }
        .city-node { 
            width: 70px; padding: 15px 10px; text-align: center; border-radius: 10px; 
            background: var(--viz-primary); color: white; transition: all 0.3s;
        }
        .city-node .name { font-weight: bold; font-size: 1.2rem; }
        .city-node .cost { font-size: 0.85rem; opacity: 0.9; margin-top: 5px; }
        .city-node.start { background: var(--viz-success); color: #0f172a; }
        .city-node.end { background: var(--viz-warning); color: #0f172a; }
        .city-node.updated { animation: pulse 0.4s; border: 2px solid white; }
        @keyframes pulse { 0%,100% { transform: scale(1); } 50% { transform: scale(1.05); } }

        .flights-container { 
            display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; 
            margin: 15px 0; padding: 12px; background: var(--viz-bg-secondary); border-radius: 8px;
        }
        .flight-item { 
            padding: 6px 12px; border-radius: 4px; font-size: 0.85rem;
            background: var(--viz-bg-primary);
        }
        .flight-item.processing { background: var(--viz-warning); color: #0f172a; }

        .round-display {
            display: flex; align-items: center; justify-content: center; gap: 20px;
            margin: 15px 0; padding: 15px; background: var(--viz-bg-secondary); border-radius: 8px;
        }
        .round-label { font-size: 0.9rem; }
        .round-value { font-size: 1.5rem; font-weight: bold; color: var(--viz-primary); }

        .dist-table {
            display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;
            margin: 10px 0; padding: 10px; background: var(--viz-bg-secondary); border-radius: 8px;
        }
        .dist-item { 
            padding: 8px 12px; border-radius: 6px; background: var(--viz-bg-primary); text-align: center;
        }
        .dist-item .city { font-weight: bold; }
        .dist-item .value { font-size: 0.85rem; color: var(--viz-text-muted); }
        .dist-item.updated { background: var(--viz-warning); color: #0f172a; }
        .dist-item.updated .value { color: #0f172a; }
    </style>
</head>
<body>
    <button class="theme-toggle" onclick="AlgorithmVisualizer.toggleTheme()" title="åˆ‡æ›ä¸»é¡Œ">ğŸŒ“</button>
    <div class="main-layout">
        <div class="canvas-area">
            <div class="viz-card">
                <div class="viz-title">K ç«™ä¸­è½‰æœ€ä¾¿å®œæ©Ÿç¥¨ (Cheapest Flights)</div>
                <div class="custom-input-section">
                    <div style="font-weight:bold; margin-bottom:5px;">ğŸ® è‡ªè¨‚æ¸¬è©¦</div>
                    <div class="input-row">
                        <button onclick="setExample(1)">ç¯„ä¾‹1 (k=1)</button>
                        <button onclick="setExample(2)">ç¯„ä¾‹2 (k=2)</button>
                        <button onclick="resetVisualization()">â†» é‡ç½®</button>
                    </div>
                </div>
                
                <div class="graph-container" id="graphDisplay"></div>
                
                <div style="text-align: center; color: var(--viz-text-muted); font-size: 0.85rem;">èˆªç­ (èµ·é», çµ‚é», åƒ¹æ ¼)</div>
                <div class="flights-container" id="flightsDisplay"></div>
                
                <div class="round-display">
                    <div>
                        <span class="round-label">ç•¶å‰è¼ªæ•¸:</span>
                        <span class="round-value" id="roundDisplay">0</span>
                    </div>
                    <div>
                        <span class="round-label">æœ€å¤šä¸­è½‰:</span>
                        <span class="round-value" id="kDisplay">-</span>
                    </div>
                </div>

                <div style="text-align: center; color: var(--viz-text-muted); font-size: 0.85rem;">è·é›¢è¡¨</div>
                <div class="dist-table" id="distDisplay"></div>

                <div class="controls" style="margin-top: 15px;">
                    <button class="viz-btn" id="prevBtn">â† ä¸Šä¸€æ­¥</button>
                    <div class="step-indicator">æ­¥é©Ÿ <span id="currentStep">0</span> / <span id="totalSteps">0</span></div>
                    <button class="viz-btn primary" id="nextBtn">ä¸‹ä¸€æ­¥ â†’</button>
                    <div class="speed-control">
                        <label>é€Ÿåº¦:</label>
                        <select id="speedSelect" onchange="viz.setSpeed(Number(this.value))">
                            <option value="1500">1x</option>
                            <option value="800">2x</option>
                        </select>
                    </div>
                </div>
                
                <div class="complexity-badge">
                    <span class="label">Time:</span> O(k Ã— E)
                    <span class="label" style="margin-left: 12px;">Space:</span> O(n)
                </div>
                <div class="state-grid">
                    <div class="state-item"><div class="state-label">èµ·é»</div><div class="state-value" id="srcDisplay">-</div></div>
                    <div class="state-item"><div class="state-label">çµ‚é»</div><div class="state-value" id="dstDisplay">-</div></div>
                    <div class="state-item"><div class="state-label">æœ€ä½åƒ¹æ ¼</div><div class="state-value" id="priceDisplay">-</div></div>
                </div>
            </div>
            <div class="viz-card"><div class="viz-title">æ¼”ç®—æ³•èªªæ˜</div><div class="explanation" id="explanation"></div></div>
        </div>
        <div class="code-area">
            <div class="viz-card" style="height: 100%;">
                <div class="viz-title">Bellman-Ford è®Šé«” (C++)</div>
                <div class="code-panel" id="codeDisplay"></div>
            </div>
        </div>
    </div>
    <script src="../assets/visualizer/core.js"></script>
    <script>
        const codeStructure = [
            { line: 'int findCheapestPrice(int n, flights, src, dst, k) {', id: 0 },
            { line: '    vector<int> dist(n, INT_MAX);', id: 1 },
            { line: '    dist[src] = 0;', id: 2 },
            { line: '    for (int i = 0; i <= k; i++) {  // k+1 è¼ª', id: 3 },
            { line: '        vector<int> temp = dist;  // é˜²æ­¢åŒè¼ªæ›´æ–°å½±éŸ¿', id: 4 },
            { line: '        for (auto& [u, v, price] : flights) {', id: 5 },
            { line: '            if (dist[u] != INT_MAX) {', id: 6 },
            { line: '                temp[v] = min(temp[v], dist[u] + price);', id: 7 },
            { line: '            }', id: 8 },
            { line: '        }', id: 9 },
            { line: '        dist = temp;', id: 10 },
            { line: '    }', id: 11 },
            { line: '    return dist[dst] == INT_MAX ? -1 : dist[dst];', id: 12 },
            { line: '}', id: 13 },
        ];
        
        const examples = {
            1: { n: 4, flights: [[0,1,100],[1,2,100],[2,3,100],[0,3,500]], src: 0, dst: 3, k: 1 },
            2: { n: 4, flights: [[0,1,100],[1,2,100],[2,3,100],[0,3,500]], src: 0, dst: 3, k: 2 }
        };
        
        let currentExample = examples[1];

        function setExample(exNum) {
            currentExample = examples[exNum];
            init();
        }

        function generateAlgorithmSteps(n, flights, src, dst, k) {
            const steps = [];
            const INF = Infinity;
            let dist = Array(n).fill(INF);
            dist[src] = 0;
            
            steps.push({
                dist: dist.map(d => d === INF ? 'âˆ' : d),
                round: 0, updated: [], n, src, dst, k,
                highlightLines: [0, 1, 2],
                explanation: { 
                    title: 'åˆå§‹åŒ–', 
                    text: `${n} å€‹åŸå¸‚, src=${src}, dst=${dst}<br>æœ€å¤š ${k} æ¬¡ä¸­è½‰ (${k+1} è¼ªè¿­ä»£)<br><br>Bellman-Ford: æ¯è¼ªæ”¾é¬†æ‰€æœ‰é‚Š`,
                    formula: 'setup'
                }
            });

            for (let round = 0; round <= k; round++) {
                const temp = [...dist];
                const updated = [];
                
                for (const [u, v, price] of flights) {
                    if (dist[u] !== INF && dist[u] + price < temp[v]) {
                        temp[v] = dist[u] + price;
                        updated.push(v);
                    }
                }
                
                dist = temp;
                
                steps.push({
                    dist: dist.map(d => d === INF ? 'âˆ' : d),
                    round: round + 1, updated, n, src, dst, k,
                    highlightLines: [3, 4, 5, 6, 7, 10],
                    explanation: { 
                        title: `ç¬¬ ${round + 1} è¼ª`, 
                        text: updated.length > 0 
                            ? `æ›´æ–°åŸå¸‚: ${[...new Set(updated)].join(', ')}<br>åˆ°çµ‚é» ${dst} çš„æœ€ä½åƒ¹: ${dist[dst] === INF ? 'âˆ' : dist[dst]}`
                            : 'æ²’æœ‰æ›´æ–°',
                        formula: `round ${round + 1}/${k + 1}`
                    }
                });
            }

            const result = dist[dst] === INF ? -1 : dist[dst];
            steps.push({
                dist: dist.map(d => d === INF ? 'âˆ' : d),
                round: k + 1, updated: [], n, src, dst, k,
                result, final: true,
                highlightLines: [12],
                explanation: { 
                    title: 'å®Œæˆ!', 
                    text: result === -1 
                        ? `ç„¡æ³•åœ¨ ${k} æ¬¡ä¸­è½‰å…§åˆ°é” ${dst}`
                        : `æœ€ä¾¿å®œåƒ¹æ ¼: $${result}`,
                    formula: `return ${result}`
                }
            });

            return steps;
        }

        let viz;
        function init() {
            const { n, flights, src, dst, k } = currentExample;
            
            viz = new AlgorithmVisualizer({
                codeLines: codeStructure,
                onStepChange: (step) => {
                    const cities = Array.from({length: step.n}, (_, i) => {
                        let name = String.fromCharCode(65 + i); // A, B, C, ...
                        if (i === step.src) name += ' (èµ·)';
                        if (i === step.dst) name += ' (çµ‚)';
                        return { id: i, name, cost: step.dist?.[i] ?? 'âˆ' };
                    });
                    
                    // Cities
                    document.getElementById('graphDisplay').innerHTML = cities.map(c => {
                        let cls = 'city-node';
                        if (c.id === step.src) cls += ' start';
                        if (c.id === step.dst) cls += ' end';
                        if (step.updated?.includes(c.id)) cls += ' updated';
                        return `<div class="${cls}"><div class="name">${c.name}</div><div class="cost">$${c.cost}</div></div>`;
                    }).join('');
                    
                    // Flights
                    document.getElementById('flightsDisplay').innerHTML = 
                        flights.map(f => `<span class="flight-item">${f[0]}â†’${f[1]}: $${f[2]}</span>`).join('');
                    
                    // Dist table
                    document.getElementById('distDisplay').innerHTML = 
                        (step.dist || []).map((d, i) => {
                            const cls = step.updated?.includes(i) ? 'dist-item updated' : 'dist-item';
                            return `<div class="${cls}"><div class="city">${i}</div><div class="value">$${d}</div></div>`;
                        }).join('');
                    
                    document.getElementById('roundDisplay').textContent = step.round ?? 0;
                    document.getElementById('kDisplay').textContent = step.k ?? '-';
                    document.getElementById('srcDisplay').textContent = step.src ?? '-';
                    document.getElementById('dstDisplay').textContent = step.dst ?? '-';
                    
                    if (step.result !== undefined) {
                        document.getElementById('priceDisplay').textContent = step.result === -1 ? 'ç„¡æ³•åˆ°é”' : `$${step.result}`;
                        document.getElementById('priceDisplay').style.color = step.result === -1 ? 'var(--viz-error)' : 'var(--viz-success)';
                    } else {
                        document.getElementById('priceDisplay').textContent = '-';
                        document.getElementById('priceDisplay').style.color = 'inherit';
                    }
                }
            });
            viz.setSteps(generateAlgorithmSteps(n, flights, src, dst, k));
        }
        
        function resetVisualization() { init(); }
        window.addEventListener('load', init);
    </script>
</body>
</html>
