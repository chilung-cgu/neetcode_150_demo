<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hand of Straights - D3 Dynamic Viz</title>
    <link rel="stylesheet" href="../assets/visualizer/style.css">
    <style>
        .visualization-area {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 50%, #1e293b 100%);
            border-radius: 16px;
            padding: 20px;
            margin: 15px 0;
            display: flex;
            flex-direction: column;
            gap: 20px;
            align-items: center;
            min-height: 550px;
        }

        /* D3 Viewport */
        .stage-viewport {
            width: 100%; height: 400px;
            background: rgba(30, 41, 59, 0.4);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid rgba(148, 163, 184, 0.2);
            position: relative;
        }
        #viz-svg { width: 100%; height: 100%; }

        .card-rect { fill: #f8fafc; stroke: #cbd5e1; stroke-width: 1px; rx: 4; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3)); }
        .card-rect.used { opacity: 0.3; }
        .card-rect.active { stroke: #fbbf24; stroke-width: 2px; }
        .card-rect.group { fill: #e2e8f0; }

        .card-text { fill: #1e293b; font-family: monospace; font-size: 14px; font-weight: bold; text-anchor: middle; dominant-baseline: middle; pointer-events: none; }
        .count-badge { fill: #ef4444; stroke: #fff; stroke-width: 1px; }
        .count-text { fill: #fff; font-size: 10px; font-weight: bold; text-anchor: middle; dominant-baseline: middle; }
        
        .group-box { fill: none; stroke: #3b82f6; stroke-width: 2px; rx: 8; stroke-dasharray: 4,4; }

        /* Stats */
        .stats-panel {
            display: flex; gap: 30px; justify-content: center; width: 95%;
            background: rgba(15, 23, 42, 0.6); padding: 15px; border-radius: 12px; border: 1px solid #475569;
        }
        .stat-box { text-align: center; }
        .stat-val { font-size: 1.2rem; font-weight: bold; color: #3b82f6; font-family: monospace; }
        .stat-label { font-size: 0.75rem; color: #94a3b8; text-transform: uppercase; letter-spacing: 1px; }

        /* Controls */
        .custom-input-section { background: var(--viz-card-bg); border-radius: 8px; padding: 15px; border: 1px solid var(--viz-border); }
        .input-row { display: flex; gap: 10px; align-items: center; justify-content: center; }
        .input-group { display: flex; align-items: center; gap: 5px; }
        .input-group label { font-size: 0.9rem; color: #94a3b8; font-weight: bold; }
        
        .input-row input { padding: 8px; border-radius: 6px; border: 1px solid var(--viz-border); background: var(--viz-input-bg); color: var(--viz-text); font-family: monospace; width: 150px; text-align: center; }
        .input-row button { padding: 8px 20px; border-radius: 6px; background: var(--viz-primary); color: white; border: none; cursor: pointer; font-weight: 600; height: 38px; }

        .legend { display: flex; gap: 15px; font-size: 0.8rem; color: #cbd5e1; margin-bottom: 10px; justify-content: center; width: 100%; }
        .legend-item { display: flex; align-items: center; gap: 6px; }
        .legend-color { width: 12px; height: 12px; border-radius: 3px; }
    </style>
</head>
<body>
    <button class="theme-toggle" onclick="AlgorithmVisualizer.toggleTheme()" title="åˆ‡æ›ä¸»é¡Œ">ğŸŒ“</button>
    <div class="main-layout">
        <div class="canvas-area">
            <div class="viz-card">
                <div class="viz-title">Hand of Straights (Greedy)</div>
                <div class="custom-input-section">
                    <div class="input-row">
                        <div class="input-group">
                            <label>Cards:</label>
                            <input type="text" id="handInput" value="1, 2, 3, 6, 2, 3, 4, 7, 8">
                        </div>
                        <div class="input-group">
                            <label>Group Size (W):</label>
                            <input type="number" id="wInput" value="3" style="width:60px;">
                        </div>
                        <button onclick="runVisualizer()">Group</button>
                    </div>
                </div>

                <div class="visualization-area">
                    <div class="legend">
                       <div class="legend-item"><div class="legend-color" style="background:#f8fafc; border:1px solid #cbd5e1"></div>Available Card</div>
                       <div class="legend-item"><div class="legend-color" style="border:2px solid #3b82f6; border-style:dashed;"></div>Formed Group</div>
                    </div>

                    <div class="stage-viewport">
                        <svg id="viz-svg"></svg>
                    </div>
                    
                    <div class="stats-panel">
                        <div class="stat-box">
                            <div class="stat-label">Map Size</div>
                            <div class="stat-val" id="mapSizeDisplay">0</div>
                        </div>
                         <div class="stat-box">
                            <div class="stat-label">Min Card</div>
                            <div class="stat-val" id="minCardDisplay">-</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">Result</div>
                            <div class="stat-val" id="resDisplay">-</div>
                        </div>
                    </div>
                </div>

                <div class="step-breakdown">
                    <div style="font-size:0.75rem; font-weight:bold; color:#64748b;">ç•¶å‰æ­¥é©Ÿ</div>
                    <div id="stepText" style="font-size:0.95rem; font-family:monospace; color:#e2e8f0;">Ready.</div>
                </div>

                <div class="controls" style="margin-top: 15px;">
                    <button class="viz-btn" id="prevBtn">â† ä¸Šä¸€æ­¥</button>
                    <div class="step-indicator">æ­¥é©Ÿ <span id="currentStep">0</span> / <span id="totalSteps">0</span></div>
                    <button class="viz-btn primary" id="nextBtn">ä¸‹ä¸€æ­¥ â†’</button>
                    <button class="viz-btn" onclick="runVisualizer()">â†» é‡ç½®</button>
                    <button class="viz-btn play-btn" id="playBtn" onclick="viz.toggleAutoPlay()">â–¶ è‡ªå‹•æ’­æ”¾</button>
                    <div class="speed-control">
                        <label>é€Ÿåº¦:</label>
                        <select id="speedSelect" onchange="viz.setSpeed(Number(this.value))">
                            <option value="1500">0.5x</option>
                            <option value="1000" selected>1x</option>
                            <option value="500">1.5x</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="viz-card logic-card"><div class="viz-title">é‚è¼¯è§£é‡‹</div><div class="explanation" id="explanation"></div></div>
        </div>
        
        <div class="code-area">
            <div class="viz-card" style="height: 100%;">
                <div class="viz-title">C++ Code</div>
                <div class="code-panel" id="codeDisplay"></div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="../assets/visualizer/core.js"></script>
    <script>
        const codeStructure = [
            { line: 'bool isNStraightHand(vector<int>& hand, int groupSize) {', id: 0 },
            { line: '    if (hand.size() % groupSize != 0) return false;', id: 1 },
            { line: '    map<int, int> count;', id: 2 },
            { line: '    for (int n : hand) count[n]++;', id: 3 },
            { line: '    while (!count.empty()) {', id: 4 },
            { line: '        int first = count.begin()->first;', id: 5 },
            { line: '        for (int i = 0; i < groupSize; i++) {', id: 6 },
            { line: '            if (count[first + i] == 0) return false;', id: 7 },
            { line: '            count[first + i]--;', id: 8 },
            { line: '            if (count[first + i] == 0) count.erase(first + i);', id: 9 },
            { line: '        }', id: 10 },
            { line: '    }', id: 11 },
            { line: '    return true;', id: 12 },
            { line: '}', id: 13 }
        ];

        let viz;

        function simulate(hand, groupSize) {
            const steps = [];
            
            // Build map
            const count = {};
            for(let n of hand) count[n] = (count[n] || 0) + 1;
            // Sorted keys for iteration (min heap simulation)
            let sortedKeys = Object.keys(count).map(Number).sort((a,b)=>a-b);
            
            steps.push({
                count: {...count}, formedGroups: [],
                msg: `Count card frequencies. Total Cards: ${hand.length}. Group Size: ${groupSize}.`, highlightLines: [0, 1, 2, 3],
                explanation: {title: "åˆå§‹åŒ–", text: `çµ±è¨ˆæ¯å¼µç‰Œçš„æ•¸é‡ã€‚è‹¥ç¸½æ•¸ä¸èƒ½è¢« ${groupSize} æ•´é™¤å‰‡ç›´æ¥è¿”å› Falseã€‚`, formula: "count[n]++"}
            });
            
            if(hand.length % groupSize !== 0) {
                 steps.push({
                    count: {...count}, formedGroups: [], final: true, result: false,
                    msg: `Total cards ${hand.length} NOT divisible by ${groupSize}. Return False.`, highlightLines: [1],
                    explanation: {title: "æª¢æŸ¥ç¸½æ•¸", text: "ç„¡æ³•æ•´é™¤ï¼Œç„¡æ³•åˆ†çµ„ã€‚", formula: "return false"}
                });
                return steps;
            }
            
            const formedGroups = [];
            
            // We use a simulation of min-heap by always taking sortedKeys[0]
            while(sortedKeys.length > 0) {
                const first = sortedKeys[0];
                
                steps.push({
                    count: {...count}, formedGroups: [...formedGroups], minCard: first,
                    msg: `Min card is ${first}. Try to make a group starting at ${first}.`, highlightLines: [4, 5],
                    explanation: {title: "å°‹æ‰¾æœ€å°ç‰Œ", text: `ç•¶å‰æœ€å°çš„ç‰Œæ˜¯ ${first}ï¼Œå®ƒå¿…é ˆæ˜¯ä¸€å€‹ç¾¤çµ„çš„èµ·é»ã€‚`, formula: `first = ${first}`}
                });
                
                const currentGroup = [];
                for(let i=0; i<groupSize; i++) {
                    const target = first + i;
                    
                    if(!count[target] || count[target] <= 0) {
                         steps.push({
                            count: {...count}, formedGroups: [...formedGroups], minCard: first, failed: true,
                            target,
                            msg: `Need card ${target} but count is 0. Failed.`, highlightLines: [7],
                            explanation: {title: "å¤±æ•—", text: `éœ€è¦ç‰Œ ${target} ä½†å·²ç”¨å®Œæˆ–ä¸å­˜åœ¨ã€‚ç„¡æ³•çµ„æˆé€£çºŒç¾¤çµ„ã€‚`, formula: "return false"}
                        });
                        return steps;
                    }
                    
                    count[target]--;
                    currentGroup.push(target);
                    if(count[target] === 0) {
                        delete count[target];
                        sortedKeys = sortedKeys.filter(k => k !== target); // remove from keys
                    }
                    
                    steps.push({
                        count: {...count}, formedGroups: [...formedGroups], minCard: first, 
                        currentGroup: [...currentGroup], target,
                        msg: `Used card ${target}. Remaining: ${count[target] || 0}.`, highlightLines: [8, 9],
                        explanation: {title: "ä½¿ç”¨å¡ç‰Œ", text: `ä½¿ç”¨äº† ${target}ã€‚`, formula: `count[${target}]--`}
                    });
                }
                
                formedGroups.push(currentGroup);
            }
            
            steps.push({
                count: {...count}, formedGroups: [...formedGroups], final: true, result: true,
                msg: `All groups formed successfully. Return True.`, highlightLines: [12],
                explanation: {title: "å®Œæˆ", text: "æ‰€æœ‰ç‰Œéƒ½æˆåŠŸåˆ†çµ„ã€‚", formula: "return true"}
            });

            return steps;
        }

        // --- Render ---
        const svg = d3.select("#viz-svg");
        const width = 600;
        const height = 400;
        svg.attr("viewBox", `0 0 ${width} ${height}`);

        function render(step) {
            document.getElementById('stepText').textContent = step.msg;
            
            document.getElementById('mapSizeDisplay').textContent = Object.keys(step.count).length;
            document.getElementById('minCardDisplay').textContent = step.minCard !== undefined ? step.minCard : "-";
            if(step.final || step.failed) document.getElementById('resDisplay').textContent = step.failed ? "False" : (step.result ? "True" : "-");

            if (step.explanation) {
                document.getElementById('explanation').innerHTML = `
                    <div class="expl-title">${step.explanation.title}</div>
                    <div class="expl-text">${step.explanation.text}</div>
                    <div class="expl-formula">${step.explanation.formula}</div>
                `;
            }

            // Draw Frequency Map (Available Cards)
            const mapKeys = Object.keys(step.count).map(Number).sort((a,b)=>a-b);
            const cardW = 40;
            const cardH = 50;
            const cardGap = 10;
            
            const mapStartX = 30;
            const mapY = 50;
            
            const mapData = mapKeys.map((k, i) => ({k, count: step.count[k], i}));
            
            // Map Label
            svg.selectAll(".section-label").remove();
            svg.append("text").attr("class", "section-label")
                .attr("x", 30).attr("y", 30).attr("fill", "#94a3b8").attr("font-size", "12px").text("Available Cards (Map)");
            
            const gMap = svg.selectAll(".card-g").data(mapData, d => d.k);
            const gMapEnter = gMap.enter().append("g").attr("class", "card-g");
             gMapEnter.append("rect").attr("class", "card-rect").attr("width", cardW).attr("height", cardH);
            gMapEnter.append("text").attr("class", "card-text").attr("x", cardW/2).attr("y", cardH/2);
            // Count badge
            gMapEnter.append("circle").attr("class", "count-badge").attr("r", 8).attr("cx", cardW).attr("cy", 0);
            gMapEnter.append("text").attr("class", "count-text").attr("x", cardW).attr("y", 0);
            
            const gMapUpdate = gMap.merge(gMapEnter)
                 .transition().duration(300)
                .attr("transform", d => `translate(${mapStartX + d.i*(cardW+cardGap)}, ${mapY})`);
            
            gMapUpdate.select(".card-rect").attr("class", d => {
                let c = "card-rect";
                if(d.k === step.target) c += " active";
                return c;
            })
            
            gMapUpdate.select(".card-text").text(d => d.k);
            gMapUpdate.select(".count-text").text(d => d.count);
             gMapUpdate.select(".count-badge").attr("r", d => d.count > 0 ? 8 : 0); // Hide if 0 (should be removed from map, but just in case)
            
            gMap.exit().remove();
            
            // Draw Formed Groups
            const groupStartX = 30;
            const groupY = 150;
            const groupGap = 20;
            
            let currentX = groupStartX;
            
            svg.append("text").attr("class", "section-label")
            .attr("x", 30).attr("y", 140).attr("fill", "#94a3b8").attr("font-size", "12px").text("Formed Groups");
            
            // Previous groups
            step.formedGroups.forEach((group, idx) => {
                 const gW = group.length * (cardW + 5) + 10;
                 
                 const gG = svg.append("g").attr("class", "group-g").attr("transform", `translate(${currentX}, ${groupY})`);
                 
                 // Box
                 gG.append("rect").attr("class", "group-box").attr("width", gW).attr("height", cardH + 20);
                 
                 // Cards
                 group.forEach((val, i) => {
                     const cG = gG.append("g").attr("transform", `translate(${10 + i*(cardW+5)}, 10)`);
                     cG.append("rect").attr("class", "card-rect group").attr("width", cardW).attr("height", cardH);
                     cG.append("text").attr("class", "card-text").attr("x", cardW/2).attr("y", cardH/2).text(val);
                 });
                 
                 currentX += gW + groupGap;
            });
            
            // Current forming group
            if(step.currentGroup && step.currentGroup.length > 0) {
                 const group = step.currentGroup;
                 const gW = width - currentX - 20; // fill remaining for visual
                 const gG = svg.append("g").attr("class", "group-g active").attr("transform", `translate(${currentX}, ${groupY})`);
                 
                 // Box (Dashed/Active)
                  gG.append("rect").attr("class", "group-box").attr("width", group.length * (cardW + 5) + 20).attr("height", cardH + 20).attr("stroke", "#fbbf24");
                 
                 group.forEach((val, i) => {
                     const cG = gG.append("g").attr("transform", `translate(${10 + i*(cardW+5)}, 10)`);
                     cG.append("rect").attr("class", "card-rect group").attr("width", cardW).attr("height", cardH).attr("fill", "#fffbeb");
                     cG.append("text").attr("class", "card-text").attr("x", cardW/2).attr("y", cardH/2).text(val);
                 });
            }
        }

        function runVisualizer() {
            const handRaw = document.getElementById('handInput').value;
             const groupSize = parseInt(document.getElementById('wInput').value);
             const hand = handRaw.split(',').map(x=>parseInt(x.trim())).filter(n=>!isNaN(n));
             
             if(!hand.length || isNaN(groupSize)) return;
             
            viz = new AlgorithmVisualizer({
                codeLines: codeStructure,
                onStepChange: render
            });
            viz.setSteps(simulate(hand, groupSize));
        }

        window.addEventListener('load', runVisualizer);
    </script>
</body>
</html>
