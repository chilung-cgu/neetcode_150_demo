<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Max Product Subarray - D3 å‹•æ…‹è¦–è¦ºåŒ–</title>
    <link rel="stylesheet" href="../assets/visualizer/style.css">
    <style>
        .visualization-area {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 50%, #1e293b 100%);
            border-radius: 16px;
            padding: 20px;
            margin: 15px 0;
            display: flex;
            flex-direction: column;
            gap: 20px;
            align-items: center;
            min-height: 450px;
        }

        /* SVG */
        .stage-viewport {
            width: 100%; height: 300px;
            background: rgba(30, 41, 59, 0.4);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid rgba(148, 163, 184, 0.2);
            position: relative;
        }
        #viz-svg { width: 100%; height: 100%; }

        .num-group rect { fill: #334155; stroke: #475569; stroke-width: 2px; rx: 4; }
        .num-group text { fill: #fff; font-family: monospace; font-size: 16px; font-weight: bold; text-anchor: middle; pointer-events: none; }
        
        .num-group.active rect { stroke: #f59e0b; stroke-width: 3px; filter: drop-shadow(0 0 5px #f59e0b); }
        
        .track-line { stroke: #94a3b8; stroke-width: 2px; stroke-dasharray: 4; opacity: 0.3; }
        .val-point { r: 6; stroke: #fff; stroke-width: 2px; transition: all 0.3s; }
        .val-point.max { fill: #22c55e; }
        .val-point.min { fill: #ef4444; }
        
        .val-label { font-size: 10px; fill: #cbd5e1; text-anchor: middle; }

        /* Stats */
        .stats-panel {
            display: flex; gap: 30px; justify-content: center; width: 100%;
            background: rgba(15, 23, 42, 0.6); padding: 10px; border-radius: 12px;
        }
        .stat-box { display: flex; flex-direction: column; align-items: center; }
        .stat-val { font-size: 1.2rem; font-weight: bold; color: #22c55e; font-family: monospace; }
        .stat-label { font-size: 0.8rem; color: #94a3b8; text-transform: uppercase; }

        /* Controls */
        .custom-input-section { background: var(--viz-card-bg); border-radius: 8px; padding: 15px; border: 1px solid var(--viz-border); }
        .input-row { display: flex; gap: 10px; align-items: start; justify-content: center; }
        input[type=text] { padding: 8px; border-radius: 6px; border: 1px solid var(--viz-border); background: var(--viz-input-bg); color: var(--viz-text); font-family: monospace; width: 220px; }
        button { padding: 8px 16px; border-radius: 6px; background: var(--viz-primary); color: white; border: none; cursor: pointer; font-weight: 600; height: 40px; }

        .step-breakdown { background: rgba(30, 41, 59, 0.6); border-radius: 12px; border-left: 4px solid #3b82f6; padding: 15px 20px; width: 100%; box-sizing: border-box; }
        
        .legend { display: flex; gap: 15px; font-size: 0.8rem; color: #cbd5e1; margin-bottom: 5px; justify-content: center; }
        .legend-item { display: flex; align-items: center; gap: 5px; }
        .legend-color { width: 12px; height: 12px; border-radius: 2px; border: 1px solid #fff; }
    </style>
</head>
<body>
    <button class="theme-toggle" onclick="AlgorithmVisualizer.toggleTheme()" title="åˆ‡æ›ä¸»é¡Œ">ğŸŒ“</button>
    <div class="main-layout">
        <div class="canvas-area">
            <div class="viz-card">
                <div class="viz-title">Max Product Subarray</div>
                <div class="custom-input-section">
                    <div class="input-row">
                        <div>
                            <label style="font-size:0.8rem; color:#94a3b8;">Nums:</label>
                            <input type="text" id="numsInput" value="2, 3, -2, 4">
                        </div>
                        <div style="display:flex; flex-direction:column; gap:5px;">
                            <button onclick="runVisualizer()">Run</button>
                        </div>
                    </div>
                </div>

                <div class="visualization-area">
                    <div class="legend">
                       <div class="legend-item"><div class="legend-color" style="background:#22c55e"></div>Cur Max</div>
                       <div class="legend-item"><div class="legend-color" style="background:#ef4444"></div>Cur Min</div>
                    </div>
                    
                    <div class="stage-viewport">
                        <svg id="viz-svg"></svg>
                    </div>
                    
                    <div class="stats-panel">
                        <div class="stat-box">
                            <div class="stat-label">Result</div>
                            <div class="stat-val" id="resDisplay">-</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">Cur Max</div>
                            <div class="stat-val" id="maxDisplay" style="color:#22c55e">-</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">Cur Min</div>
                            <div class="stat-val" id="minDisplay" style="color:#ef4444">-</div>
                        </div>
                    </div>
                </div>

                <div class="step-breakdown">
                    <div style="font-size:0.75rem; font-weight:bold; color:#64748b;">ç•¶å‰æ­¥é©Ÿ</div>
                    <div id="stepText" style="font-size:0.95rem; font-family:monospace; color:#e2e8f0;">Ready.</div>
                </div>

                <div class="controls" style="margin-top: 15px;">
                    <button class="viz-btn" id="prevBtn">â† ä¸Šä¸€æ­¥</button>
                    <div class="step-indicator">æ­¥é©Ÿ <span id="currentStep">0</span> / <span id="totalSteps">0</span></div>
                    <button class="viz-btn primary" id="nextBtn">ä¸‹ä¸€æ­¥ â†’</button>
                    <button class="viz-btn" onclick="runVisualizer()">â†» é‡ç½®</button>
                    <button class="viz-btn play-btn" id="playBtn" onclick="viz.toggleAutoPlay()">â–¶ è‡ªå‹•æ’­æ”¾</button>
                    <div class="speed-control">
                        <label>é€Ÿåº¦:</label>
                        <select id="speedSelect" onchange="viz.setSpeed(Number(this.value))">
                            <option value="1500">0.5x</option>
                            <option value="1000" selected>1x</option>
                            <option value="500">2x</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="viz-card logic-card"><div class="viz-title">é‚è¼¯è§£é‡‹</div><div class="explanation" id="explanation"></div></div>
        </div>
        <div class="code-area">
            <div class="viz-card" style="height: 100%;">
                <div class="viz-title">C++ Code</div>
                <div class="code-panel" id="codeDisplay"></div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="../assets/visualizer/core.js"></script>
    <script>
        const codeStructure = [
            { line: 'int maxProduct(vector<int>& nums) {', id: 0 },
            { line: '    int res = nums[0];', id: 1 },
            { line: '    int curMax = 1, curMin = 1;', id: 2 },
            { line: '    for (int n : nums) {', id: 3 },
            { line: '        int tmp = curMax * n;', id: 4 },
            { line: '        curMax = max({n, n * curMax, n * curMin});', id: 5 },
            { line: '        curMin = min({n, tmp, n * curMin});', id: 6 },
            { line: '        res = max(res, curMax);', id: 7 },
            { line: '    }', id: 8 },
            { line: '    return res;', id: 9 },
            { line: '}', id: 10 }
        ];

        let viz;

        function simulate(nums) {
            const steps = [];
            // To visualize we need history of curMax/curMin
            // We'll plot them like a line chart above the array elements.
            
            let res = Math.max(...nums); // Initial estimate
            let curMax = 1;
            let curMin = 1;
            
            // To properly visualize, we need boundaries.
            // But max product can grow super large. We might need log scale or just dynamic text?
            // Let's store values and use dynamic scale in render.
            
            steps.push({
                idx: -1, nums, curMax, curMin, res,
                msg: "Init curMax=1, curMin=1", highlightLines: [0, 1, 2],
                explanation: {
                    title: "åˆå§‹åŒ–",
                    text: "ç¶­è­·å…©å€‹è®Šæ•¸ï¼šcurMax (ç•¶å‰é€£çºŒæœ€å¤§) å’Œ curMin (ç•¶å‰é€£çºŒæœ€å°)ã€‚",
                    formula: "curMax=1, curMin=1"
                }
            });

            for (let i = 0; i < nums.length; i++) {
                const n = nums[i];
                if (n === 0) {
                    curMax = 1; 
                    curMin = 1;
                    res = Math.max(res, 0); // 0 itself could be result
                    steps.push({
                        idx: i, nums, curMax, curMin, res, isZero: true,
                        msg: `Encounter 0. Reset to 1.`, highlightLines: [3],
                        explanation: {
                            title: "é‡åˆ° 0",
                            text: "0 æœƒä¸­æ–·ä¹˜ç©é€£çºŒæ€§ã€‚é‡ç½® curMax/curMin ç‚º 1ï¼Œé‡æ–°é–‹å§‹ã€‚",
                            formula: "Reset"
                        }
                    });
                    continue; 
                }
                
                const oldMax = curMax;
                const tmp = curMax * n;
                
                const opts = [n, oldMax * n, curMin * n];
                
                curMax = Math.max(n, oldMax * n, curMin * n);
                curMin = Math.min(n, tmp, curMin * n);
                res = Math.max(res, curMax);
                
                steps.push({
                    idx: i, nums, curMax, curMin, res,
                    opts,
                    msg: `n=${n}. New Max=${curMax}, New Min=${curMin}`, 
                    highlightLines: [5, 6, 7],
                    explanation: {
                        title: `è™•ç†æ•¸å€¼ ${n}`,
                        text: `æ¯”è¼ƒä¸‰ç¨®æƒ…æ³ï¼šè‡ªå·±(${n})ã€ä¹˜ä»¥å‰æœ€å¤§(${oldMax * n})ã€ä¹˜ä»¥å‰æœ€å°(${curMin * n})ã€‚<br>å‰æœ€å°è‹¥æ˜¯è² æ•¸ï¼Œä¹˜ä»¥ç•¶å‰è² æ•¸å¯èƒ½è®Šæœ€å¤§ã€‚`,
                        formula: `Max = max(${opts.join(', ')})`
                    }
                });
            }
            
            steps.push({
                idx: nums.length, nums, curMax, curMin, res, final: true,
                msg: `Finished. Result: ${res}`, highlightLines: [9],
                explanation: { title: "å®Œæˆ", text: `æœ€å¤§ä¹˜ç©å­é™£åˆ—çµæœç‚º ${res}`, formula: `return ${res}` }
            });

            return steps;
        }

        // --- Render ---
        const svg = d3.select("#viz-svg");
        const width = 600;
        const height = 300;
        svg.attr("viewBox", `0 0 ${width} ${height}`);

        function render(step) {
            document.getElementById('stepText').textContent = step.msg;
            document.getElementById('maxDisplay').textContent = step.curMax;
            document.getElementById('minDisplay').textContent = step.curMin;
            document.getElementById('resDisplay').textContent = step.res;
            
            if (step.explanation) {
                document.getElementById('explanation').innerHTML = `
                    <div class="expl-title">${step.explanation.title}</div>
                    <div class="expl-text">${step.explanation.text}</div>
                    <div class="expl-formula">${step.explanation.formula}</div>
                `;
            }

            const nums = step.nums;
            const n = nums.length;
            
            const margin = {top: 50, right: 30, bottom: 80, left: 30};
            const innerW = width - margin.left - margin.right;
            const itemW = Math.min(50, innerW / n);
            const startX = (width - n * itemW) / 2;
            const centerY = height - 40; // Array at bottom

            // Draw Array
            const numData = nums.map((v, i) => ({v, i}));
            const groups = svg.selectAll(".num-group").data(numData);
            
            const enter = groups.enter().append("g").attr("class", "num-group");
            enter.append("rect").attr("width", itemW-4).attr("height", 40).attr("y", -20);
            enter.append("text").attr("x", itemW/2 - 2).attr("dy", 5);
            
            const merge = groups.merge(enter)
                .attr("transform", (d, i) => `translate(${startX + i*itemW}, ${centerY})`);
            
            merge.select("rect").attr("class", d => d.i === step.idx ? "active" : ""); // Highlight current
            
            merge.select("text").text(d => d.v);
            
            groups.exit().remove();

            // Visualize curMax/curMin as points above columns
            // Since values can be wildly different scales (e.g. 2 vs 1000), typical graph is hard.
            // We use simple markers + text label above the current index.
            
            // Markers Group
            let markersData = [];
            if (step.idx >= 0 && step.idx < n) {
                markersData = [
                    { type: 'max', val: step.curMax, i: step.idx, offset: -60 },
                    { type: 'min', val: step.curMin, i: step.idx, offset: -30 }
                ];
            }
            
            const points = svg.selectAll(".val-point").data(markersData, d => d.type);
            const pEnter = points.enter().append(step.idx >= 0 ? "circle" : "g"); // Handle init state
            
            // Actually better to just clear and redraw markers for simplicity in this case
            svg.selectAll(".marker-g").remove();
            
            if (markersData.length > 0) {
                const mg = svg.selectAll(".marker-g").data(markersData).enter().append("g").attr("class", "marker-g");
                
                mg.attr("transform", d => `translate(${startX + d.i * itemW + itemW/2 - 2}, ${centerY + d.offset})`);
                
                mg.append("circle").attr("r", 6)
                    .attr("fill", d => d.type === 'max' ? '#22c55e' : '#ef4444');
                
                mg.append("text").attr("text-anchor", "middle").attr("dy", -10).attr("fill", "#fff").style("font-size", "12px")
                    .text(d => `${d.type}: ${d.val}`);
                    
                // Connect lines
                mg.append("line").attr("y1", 0).attr("y2", -d => d.offset - 20) // down to box
                    .attr("stroke", d => d.type === 'max' ? '#22c55e' : '#ef4444')
                    .attr("stroke-dasharray", "2,2");
            }
        }

        function runVisualizer() {
            const raw = document.getElementById('numsInput').value;
            const nums = raw.split(',').map(x=>parseInt(x.trim())).filter(x=>!isNaN(x));
            if(nums.length === 0) return;
            
            viz = new AlgorithmVisualizer({
                codeLines: codeStructure,
                onStepChange: render
            });
            viz.setSteps(simulate(nums));
        }

        window.addEventListener('load', runVisualizer);
    </script>
</body>
</html>
