<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>House Robber - D3 ÂãïÊÖãË¶ñË¶∫Âåñ</title>
    <link rel="stylesheet" href="../assets/visualizer/style.css">
    <style>
        .visualization-area {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 50%, #1e293b 100%);
            border-radius: 16px;
            padding: 20px;
            margin: 15px 0;
            display: flex;
            flex-direction: column;
            gap: 20px;
            align-items: center;
            min-height: 450px;
        }

        /* SVG */
        .stage-viewport {
            width: 100%; height: 350px;
            background: rgba(30, 41, 59, 0.4);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid rgba(148, 163, 184, 0.2);
            position: relative;
        }
        #viz-svg { width: 100%; height: 100%; }

        .house-path { fill: #475569; stroke: #64748b; stroke-width: 2px; transition: fill 0.3s; }
        .house-path.focus { stroke: #f59e0b; stroke-width: 3px; }
        .house-path.robbed { fill: #22c55e; stroke: #86efac; filter: drop-shadow(0 0 5px #22c55e); }
        .house-path.skipped { fill: #ef4444; opacity: 0.3; }
        
        .house-label { fill: #fff; font-weight: bold; font-family: monospace; font-size: 14px; text-anchor: middle; }
        
        .robber { font-size: 40px; cursor: default; } /* Emoji */
        .money-bag { font-size: 24px; opacity: 0; transition: opacity 0.3s, transform 0.3s; }
        .money-bag.show { opacity: 1; transform: translateY(-30px); }

        /* Stats */
        .stats-panel {
            display: flex; gap: 30px; justify-content: center; width: 100%;
            background: rgba(15, 23, 42, 0.6); padding: 10px; border-radius: 12px;
        }
        .stat-val { font-size: 1.5rem; font-weight: bold; color: #22c55e; }
        .stat-label { font-size: 0.8rem; color: #94a3b8; text-transform: uppercase; }

        /* Controls */
        .custom-input-section { background: var(--viz-card-bg); border-radius: 8px; padding: 15px; border: 1px solid var(--viz-border); }
        .input-row { display: flex; gap: 10px; align-items: start; justify-content: center; }
        input[type=text] { padding: 8px; border-radius: 6px; border: 1px solid var(--viz-border); background: var(--viz-input-bg); color: var(--viz-text); font-family: monospace; width: 220px; }
        button { padding: 8px 16px; border-radius: 6px; background: var(--viz-primary); color: white; border: none; cursor: pointer; font-weight: 600; height: 40px; }

        .step-breakdown { background: rgba(30, 41, 59, 0.6); border-radius: 12px; border-left: 4px solid #3b82f6; padding: 15px 20px; width: 100%; box-sizing: border-box; }
    </style>
</head>
<body>
    <button class="theme-toggle" onclick="AlgorithmVisualizer.toggleTheme()" title="ÂàáÊèõ‰∏ªÈ°å">üåì</button>
    <div class="main-layout">
        <div class="canvas-area">
            <div class="viz-card">
                <div class="viz-title">ÊâìÂÆ∂Âä´Ëàç (House Robber)</div>
                <div class="custom-input-section">
                    <div class="input-row">
                        <div>
                            <label style="font-size:0.8rem; color:#94a3b8;">House Values:</label>
                            <input type="text" id="numsInput" value="2, 7, 9, 3, 1">
                        </div>
                        <div style="display:flex; flex-direction:column; gap:5px;">
                            <button onclick="runVisualizer()">Rob</button>
                        </div>
                    </div>
                </div>

                <div class="visualization-area">
                    <div class="stage-viewport">
                        <svg id="viz-svg"></svg>
                    </div>
                    
                    <div class="stats-panel">
                        <div class="stat-box">
                            <div class="stat-label">Max Profit</div>
                            <div class="stat-val" id="resultDisplay">0</div>
                        </div>
                    </div>
                </div>

                <div class="step-breakdown">
                    <div style="font-size:0.75rem; font-weight:bold; color:#64748b;">Áï∂ÂâçÊ≠•È©ü</div>
                    <div id="stepText" style="font-size:0.95rem; font-family:monospace; color:#e2e8f0;">Ready.</div>
                </div>

                <div class="controls" style="margin-top: 15px;">
                    <button class="viz-btn" id="prevBtn">‚Üê ‰∏ä‰∏ÄÊ≠•</button>
                    <div class="step-indicator">Ê≠•È©ü <span id="currentStep">0</span> / <span id="totalSteps">0</span></div>
                    <button class="viz-btn primary" id="nextBtn">‰∏ã‰∏ÄÊ≠• ‚Üí</button>
                    <button class="viz-btn" onclick="runVisualizer()">‚Üª ÈáçÁΩÆ</button>
                    <button class="viz-btn play-btn" id="playBtn" onclick="viz.toggleAutoPlay()">‚ñ∂ Ëá™ÂãïÊí≠Êîæ</button>
                    <div class="speed-control">
                        <label>ÈÄüÂ∫¶:</label>
                        <select id="speedSelect" onchange="viz.setSpeed(Number(this.value))">
                            <option value="1500">0.5x</option>
                            <option value="1000" selected>1x</option>
                            <option value="500">2x</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="viz-card"><div class="viz-title">ÈÇèËºØËß£Èáã</div><div class="explanation" id="explanation"></div></div>
        </div>
        <div class="code-area">
            <div class="viz-card" style="height: 100%;">
                <div class="viz-title">C++ Code</div>
                <div class="code-panel" id="codeDisplay"></div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="../assets/visualizer/core.js"></script>
    <script>
        const codeStructure = [
            { line: 'int rob(vector<int>& nums) {', id: 0 },
            { line: '    int n = nums.size();', id: 1 },
            { line: '    vector<int> dp(n + 1, 0);', id: 2 },
            { line: '    dp[1] = nums[0];', id: 3 },
            { line: '    for (int i = 2; i <= n; i++) {', id: 4 },
            { line: '        // rob current: nums[i-1] + dp[i-2]', id: 5 },
            { line: '        // skip current: dp[i-1]', id: 6 },
            { line: '        dp[i] = max(dp[i-1], nums[i-1] + dp[i-2]);', id: 7 },
            { line: '    }', id: 8 },
            { line: '    return dp[n];', id: 9 },
            { line: '}', id: 10 }
        ];

        let viz;

        function simulate(nums) {
            const steps = [];
            const n = nums.length;
            const dp = new Array(n + 1).fill(0);
            
            steps.push({
                idx: 0, dp: [...dp], nums,
                msg: "Init DP array.", highlightLines: [0, 1, 2]
            });

            if (n === 0) return steps;

            dp[1] = nums[0];
            steps.push({
                idx: 1, dp: [...dp], nums, robs: [0], // robs stores indices of robbed houses for optimal
                msg: `House 1: Only choice. Profit: ${nums[0]}`, highlightLines: [3]
            });

            // To track robbing decisions correctly for visualization, we need to store which path was taken.
            // Let's store decisions in an array 'decisions': 0=skip, 1=rob
            const decisions = new Array(n + 1).fill(0); 
            // For i=1, we robbed(1) implicitly
            decisions[1] = 1;

            for (let i = 2; i <= n; i++) {
                const val = nums[i-1];
                const skipVal = dp[i-1];
                const robVal = dp[i-2] + val;
                
                steps.push({
                    idx: i, dp: [...dp], nums, calculating: true,
                    vals: {skip: skipVal, rob: robVal, val},
                    msg: `Compare: Skip (${skipVal}) vs Rob (${dp[i-2]} + ${val} = ${robVal})`, highlightLines: [5, 6, 7]
                });
                
                if (robVal > skipVal) {
                    dp[i] = robVal;
                    decisions[i] = 1; // rob
                } else {
                    dp[i] = skipVal;
                    decisions[i] = 0; // skip
                }
                
                steps.push({
                    idx: i, dp: [...dp], nums,
                    decision: decisions[i] === 1 ? 'rob' : 'skip',
                    msg: `Decision: ${decisions[i]===1 ? 'Rob' : 'Skip'}. Max Profit: ${dp[i]}`, highlightLines: [7]
                });
            }
            
            // Backtrack to find actual robbed houses for final display
            const finalRobbed = [];
            let curr = n;
            while(curr >= 1) {
                // If decisions array is reliable?
                // Actually need to check values.
                // If dp[curr] == dp[curr-1], we skipped curr (house index curr-1)
                // Else we robbed house index curr-1 and came from curr-2
                if (curr === 1) {
                    finalRobbed.push(0);
                    curr -= 2;
                } else if (dp[curr] === dp[curr - 1]) {
                    // Skipped
                    curr -= 1;
                } else {
                    finalRobbed.push(curr - 1);
                    curr -= 2;
                }
            }
            
            steps.push({
                idx: n, dp: [...dp], nums, result: dp[n], finalRobbed, final: true,
                msg: `Done. Max Profit: ${dp[n]}`, highlightLines: [9]
            });

            return steps;
        }

        // --- Render ---
        const svg = d3.select("#viz-svg");
        const width = 600;
        const height = 350;
        svg.attr("viewBox", `0 0 ${width} ${height}`);

        function render(step) {
            document.getElementById('stepText').textContent = step.msg;
            document.getElementById('resultDisplay').textContent = step.result !== undefined ? step.result : step.dp[step.idx] || 0;

            const n = step.nums.length;
            const margin = {top: 50, right: 20, bottom: 50, left: 20};
            const innerW = width - margin.left - margin.right;
            const houseW = Math.min(60, innerW / n - 10);
            const gap = (innerW - n*houseW) / (n+1);

            // House shape path function
            const housePath = (x, y, w, h) => {
                const roofH = h * 0.4;
                return `M${x},${y+roofH} L${x+w/2},${y} L${x+w},${y+roofH} L${x+w},${y+h} L${x},${y+h} Z`;
            };

            const data = step.nums.map((val, i) => ({val, i}));

            const houses = svg.selectAll(".house-group").data(data, d => d.i);
            
            const enter = houses.enter().append("g").attr("class", "house-group");
            
            enter.append("path").attr("class", "house-path");
            enter.append("text").attr("class", "house-label");
            enter.append("text").attr("class", "money-bag").text("üí∞").attr("dy", -5); // Bag above

            const merge = houses.merge(enter)
                .attr("transform", (d, i) => `translate(${margin.left + gap + i*(houseW+gap)}, ${height/2 - 30})`);

            merge.select(".house-path")
                .attr("d", d => housePath(0, 0, houseW, 60))
                .attr("class", d => {
                    let c = "house-path";
                    // Status logic
                    // If final state, use finalRobbed
                    if (step.finalRobbed && step.finalRobbed.includes(d.i)) return c + " robbed";
                    if (step.finalRobbed && !step.finalRobbed.includes(d.i)) return c + " skipped";
                    
                    // Intermediate
                    // Hard to know exact status without full history replay in steps.
                    // Simplified: highlight current focus
                    if (step.idx === d.i + 1) c += " focus";
                    if (step.idx > d.i + 1) {
                        // Past history check from dp values?
                        // Just leave neutral or deduce
                    }
                    return c;
                });

            merge.select(".house-label")
                .attr("x", houseW/2).attr("y", 40)
                .text(d => d.val);
            
            merge.select(".money-bag")
                .attr("x", houseW/2 - 12)
                .attr("y", 0)
                .attr("class", d => {
                    // Show bag if robbed
                    const isRobbed = step.finalRobbed?.includes(d.i) || (step.decision === 'rob' && step.idx === d.i+1);
                    return isRobbed ? "money-bag show" : "money-bag";
                });

            houses.exit().remove();

            // Robber Character
            const robber = svg.selectAll(".robber-char").data([1]);
            robber.enter().append("text").attr("class", "robber-char robber").text("ü¶π")
                .merge(robber)
                .transition().duration(400)
                .attr("x", () => {
                    let i = step.idx > 0 ? step.idx - 1 : 0; // current house index
                    if(i >= n) i = n - 1;
                    return margin.left + gap + i*(houseW+gap) + houseW/2 - 20;
                })
                .attr("y", height/2 + 80);
        }

        function runVisualizer() {
            const raw = document.getElementById('numsInput').value;
            const nums = raw.split(',').map(x=>parseInt(x.trim())).filter(x=>!isNaN(x));
            if(nums.length === 0) { alert('Input numbers'); return; }
            
            viz = new AlgorithmVisualizer({
                codeLines: codeStructure,
                onStepChange: render
            });
            viz.setSteps(simulate(nums));
        }

        window.addEventListener('load', runVisualizer);
    </script>
</body>
</html>
