<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detect Squares - è¦–è¦ºåŒ–</title>
    <link rel="stylesheet" href="../assets/visualizer/style.css">
    <style>
        .custom-input-section { background: var(--viz-card-bg); border-radius: 8px; padding: 15px; margin-bottom: 15px; border: 1px solid var(--viz-border); }
        .input-row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .input-row button { padding: 8px 16px; border-radius: 6px; background: var(--viz-primary); color: white; border: none; cursor: pointer; }

        .grid-container { 
            position: relative; width: 280px; height: 280px; margin: 20px auto; 
            background: var(--viz-bg-secondary); border-radius: 10px; overflow: hidden;
        }
        .grid-line { position: absolute; background: var(--viz-border); opacity: 0.3; }
        .grid-line.h { width: 100%; height: 1px; }
        .grid-line.v { width: 1px; height: 100%; }
        
        .point { 
            position: absolute; width: 16px; height: 16px; border-radius: 50%; 
            background: var(--viz-primary); transform: translate(-50%, -50%);
            transition: all 0.3s; z-index: 2;
        }
        .point.query { background: var(--viz-warning); width: 20px; height: 20px; z-index: 3; }
        .point.square-point { background: var(--viz-success); }
        .point.diagonal { background: var(--viz-secondary); }
        
        .square-outline { 
            position: absolute; border: 3px dashed var(--viz-success); 
            z-index: 1; border-radius: 4px;
        }

        .points-list {
            display: flex; gap: 8px; flex-wrap: wrap; justify-content: center;
            padding: 10px; background: var(--viz-bg-secondary); border-radius: 8px; margin: 10px 0;
        }
        .point-tag { padding: 5px 10px; border-radius: 4px; background: var(--viz-primary); color: white; font-size: 0.85rem; }
    </style>
</head>
<body>
    <button class="theme-toggle" onclick="AlgorithmVisualizer.toggleTheme()" title="åˆ‡æ›ä¸»é¡Œ">ğŸŒ“</button>
    <div class="main-layout">
        <div class="canvas-area">
            <div class="viz-card">
                <div class="viz-title">æª¢æ¸¬æ­£æ–¹å½¢ (Detect Squares)</div>
                <div class="custom-input-section">
                    <div style="font-weight:bold; margin-bottom:5px;">ğŸ® æ“ä½œç¯„ä¾‹</div>
                    <div class="input-row">
                        <button onclick="resetVisualization()">â†» é‡ç½®</button>
                    </div>
                </div>
                
                <div class="grid-container" id="gridContainer"></div>
                
                <div style="text-align: center; color: var(--viz-text-muted); font-size: 0.85rem;">å·²åŠ å…¥çš„é»</div>
                <div class="points-list" id="pointsList"></div>

                <div class="controls" style="margin-top: 15px;">
                    <button class="viz-btn" id="prevBtn">â† ä¸Šä¸€æ­¥</button>
                    <div class="step-indicator">æ­¥é©Ÿ <span id="currentStep">0</span> / <span id="totalSteps">0</span></div>
                    <button class="viz-btn primary" id="nextBtn">ä¸‹ä¸€æ­¥ â†’</button>
                    <div class="speed-control">
                        <label>é€Ÿåº¦:</label>
                        <select id="speedSelect" onchange="viz.setSpeed(Number(this.value))">
                            <option value="1500">1x</option>
                            <option value="800">2x</option>
                        </select>
                    </div>
                </div>
                
                <div class="complexity-badge">
                    <span class="label">add:</span> O(1)
                    <span class="label" style="margin-left: 12px;">count:</span> O(n)
                </div>
                <div class="state-grid">
                    <div class="state-item"><div class="state-label">æ­£æ–¹å½¢æ•¸</div><div class="state-value" id="countDisplay">0</div></div>
                </div>
            </div>
            <div class="viz-card"><div class="viz-title">æ¼”ç®—æ³•èªªæ˜</div><div class="explanation" id="explanation"></div></div>
        </div>
        <div class="code-area">
            <div class="viz-card" style="height: 100%;">
                <div class="viz-title">æ¼”ç®—æ³• (C++)</div>
                <div class="code-panel" id="codeDisplay"></div>
            </div>
        </div>
    </div>
    <script src="../assets/visualizer/core.js"></script>
    <script>
        const codeStructure = [
            { line: 'class DetectSquares {', id: 0 },
            { line: '    unordered_map<string, int> points;', id: 1 },
            { line: 'public:', id: 2 },
            { line: '    void add(vector<int> p) {', id: 3 },
            { line: '        points[to_string(p[0])+","+to_string(p[1])]++;', id: 4 },
            { line: '    }', id: 5 },
            { line: '    int count(vector<int> p) {', id: 6 },
            { line: '        int px = p[0], py = p[1], result = 0;', id: 7 },
            { line: '        for (auto& [key, cnt] : points) {', id: 8 },
            { line: '            // æ‰¾å°è§’ç·šé»: |dx| == |dy| && dx != 0', id: 9 },
            { line: '            int x = ..., y = ...;', id: 10 },
            { line: '            if (abs(x-px) == abs(y-py) && x != px) {', id: 11 },
            { line: '                // æª¢æŸ¥å¦å¤–å…©å€‹è§’', id: 12 },
            { line: '                result += cnt * count(px,y) * count(x,py);', id: 13 },
            { line: '            }', id: 14 },
            { line: '        }', id: 15 },
            { line: '        return result;', id: 16 },
            { line: '    }', id: 17 },
            { line: '};', id: 18 },
        ];

        // Scale factor and offset for visualization
        const SCALE = 20;
        const OFFSET = 20;

        function toScreen(x, y) {
            return [OFFSET + x * SCALE, 280 - OFFSET - y * SCALE];
        }

        function generateAlgorithmSteps() {
            const steps = [];
            const points = [];
            
            steps.push({
                points: [], query: null, squares: [],
                highlightLines: [0, 1, 2],
                explanation: { 
                    title: 'åˆå§‹åŒ–', 
                    text: `DetectSquares é¡åˆ¥<br><br>ç”¨ HashMap å­˜å„²é»åŠå…¶å‡ºç¾æ¬¡æ•¸<br>add: åŠ å…¥é» O(1)<br>count: çµ±è¨ˆæ­£æ–¹å½¢æ•¸ O(n)`,
                    formula: 'setup'
                }
            });

            // Add points
            const addPoints = [[3, 10], [11, 2], [3, 2], [11, 10]];
            for (const p of addPoints) {
                points.push(p);
                steps.push({
                    points: points.map(pp => [...pp]), query: null, squares: [],
                    highlightLines: [3, 4, 5],
                    explanation: { 
                        title: `add([${p[0]}, ${p[1]}])`, 
                        text: `åŠ å…¥é» (${p[0]}, ${p[1]})<br>ç›®å‰å…± ${points.length} å€‹é»`,
                        formula: `add(${p[0]},${p[1]})`
                    }
                });
            }

            // Query
            const queryPoint = [11, 10];
            
            steps.push({
                points: points.map(pp => [...pp]), query: queryPoint, squares: [],
                highlightLines: [6, 7, 8],
                explanation: { 
                    title: `count([${queryPoint[0]}, ${queryPoint[1]}])`, 
                    text: `æŸ¥è©¢é» (${queryPoint[0]}, ${queryPoint[1]})<br>éæ­·æ‰€æœ‰é»æ‰¾å°è§’ç·šé»`,
                    formula: 'start query'
                }
            });

            // Find diagonal - (3, 2) is diagonal to (11, 10)
            const diagonal = [3, 2];
            steps.push({
                points: points.map(pp => [...pp]), query: queryPoint, 
                diagonal: diagonal, squares: [],
                highlightLines: [9, 10, 11],
                explanation: { 
                    title: `æ‰¾åˆ°å°è§’ç·šé» (${diagonal[0]}, ${diagonal[1]})`, 
                    text: `|${diagonal[0]} - ${queryPoint[0]}| = |${diagonal[1]} - ${queryPoint[1]}| = 8<br>é€™æ˜¯å°è§’ç·šé—œä¿‚!`,
                    formula: `|dx| = |dy| = 8`
                }
            });

            // Check other corners
            const corners = [[queryPoint[0], diagonal[1]], [diagonal[0], queryPoint[1]]];
            steps.push({
                points: points.map(pp => [...pp]), query: queryPoint, 
                diagonal: diagonal, checkCorners: corners, squares: [],
                highlightLines: [12, 13],
                explanation: { 
                    title: `æª¢æŸ¥å¦å¤–å…©è§’`, 
                    text: `(${corners[0][0]}, ${corners[0][1]}) å’Œ (${corners[1][0]}, ${corners[1][1]})<br>éƒ½å­˜åœ¨!`,
                    formula: 'check corners'
                }
            });

            // Found square
            steps.push({
                points: points.map(pp => [...pp]), query: queryPoint,
                squares: [[diagonal, queryPoint]], count: 1,
                highlightLines: [13],
                explanation: { 
                    title: `æ‰¾åˆ°æ­£æ–¹å½¢!`, 
                    text: `å››å€‹è§’: (3,2), (3,10), (11,2), (11,10)<br>é‚Šé•· = 8`,
                    formula: 'result += 1'
                }
            });

            steps.push({
                points: points.map(pp => [...pp]), query: queryPoint,
                squares: [[diagonal, queryPoint]], count: 1, final: true,
                highlightLines: [16],
                explanation: { 
                    title: 'å®Œæˆ!', 
                    text: `å…±æ‰¾åˆ° 1 å€‹æ­£æ–¹å½¢`,
                    formula: 'return 1'
                }
            });

            return steps;
        }

        let viz;
        function init() {
            // Draw grid lines
            const container = document.getElementById('gridContainer');
            let gridHtml = '';
            for (let i = 0; i <= 14; i++) {
                gridHtml += `<div class="grid-line h" style="top: ${i * SCALE}px;"></div>`;
                gridHtml += `<div class="grid-line v" style="left: ${i * SCALE}px;"></div>`;
            }
            container.innerHTML = gridHtml;
            
            viz = new AlgorithmVisualizer({
                codeLines: codeStructure,
                onStepChange: (step) => {
                    let html = '';
                    
                    // Draw squares
                    for (const sq of (step.squares || [])) {
                        const [p1, p2] = sq;
                        const [x1, y1] = toScreen(Math.min(p1[0], p2[0]), Math.max(p1[1], p2[1]));
                        const size = Math.abs(p2[0] - p1[0]) * SCALE;
                        html += `<div class="square-outline" style="left:${x1}px;top:${y1}px;width:${size}px;height:${size}px;"></div>`;
                    }
                    
                    // Draw points
                    for (const p of (step.points || [])) {
                        const [sx, sy] = toScreen(p[0], p[1]);
                        let cls = 'point';
                        if (step.diagonal && p[0] === step.diagonal[0] && p[1] === step.diagonal[1]) cls += ' diagonal';
                        if (step.squares?.length > 0) cls += ' square-point';
                        html += `<div class="${cls}" style="left:${sx}px;top:${sy}px;"></div>`;
                    }
                    
                    // Draw query point
                    if (step.query) {
                        const [sx, sy] = toScreen(step.query[0], step.query[1]);
                        html += `<div class="point query" style="left:${sx}px;top:${sy}px;"></div>`;
                    }
                    
                    // Append to grid lines
                    const gridLines = Array.from(container.querySelectorAll('.grid-line'));
                    container.innerHTML = gridLines.map(el => el.outerHTML).join('') + html;
                    
                    // Points list
                    document.getElementById('pointsList').innerHTML = 
                        (step.points || []).length > 0
                            ? step.points.map(p => `<span class="point-tag">(${p[0]}, ${p[1]})</span>`).join('')
                            : '<span style="color: var(--viz-text-muted)">ç„¡</span>';
                    
                    document.getElementById('countDisplay').textContent = step.count ?? 0;
                }
            });
            viz.setSteps(generateAlgorithmSteps());
        }
        
        function resetVisualization() { init(); }
        window.addEventListener('load', init);
    </script>
</body>
</html>
