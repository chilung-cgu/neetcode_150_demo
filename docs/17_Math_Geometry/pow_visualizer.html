<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pow(x, n) - è¦–è¦ºåŒ–</title>
    <link rel="stylesheet" href="../assets/visualizer/style.css">
    <style>
        .custom-input-section { background: var(--viz-card-bg); border-radius: 8px; padding: 15px; margin-bottom: 15px; border: 1px solid var(--viz-border); }
        .input-row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .input-row button { padding: 8px 16px; border-radius: 6px; background: var(--viz-primary); color: white; border: none; cursor: pointer; }

        .expression-display { 
            text-align: center; margin: 20px 0; padding: 20px;
            background: var(--viz-bg-secondary); border-radius: 10px;
        }
        .expression { font-size: 2.5rem; font-weight: bold; color: var(--viz-secondary); }
        .result { font-size: 1.5rem; color: var(--viz-success); margin-top: 10px; }

        .recursion-tree {
            display: flex; flex-direction: column; gap: 8px; margin: 20px 0; 
            padding: 15px; background: var(--viz-bg-secondary); border-radius: 10px;
        }
        .tree-level { 
            display: flex; align-items: center; gap: 10px; padding: 10px 15px; 
            border-radius: 8px; font-family: monospace; transition: all 0.3s;
        }
        .tree-level.current { background: var(--viz-warning); color: #0f172a; }
        .tree-level.computed { background: var(--viz-success); color: #0f172a; }
        .tree-level.pending { background: var(--viz-bg-primary); }
        .tree-level .n-value { font-weight: bold; min-width: 50px; }
        .tree-level .formula { flex: 1; }
        .tree-level .result { font-weight: bold; color: var(--viz-success); }
    </style>
</head>
<body>
    <button class="theme-toggle" onclick="AlgorithmVisualizer.toggleTheme()" title="åˆ‡æ›ä¸»é¡Œ">ğŸŒ“</button>
    <div class="main-layout">
        <div class="canvas-area">
            <div class="viz-card">
                <div class="viz-title">å¿«é€Ÿå†ª Pow(x, n)</div>
                <div class="custom-input-section">
                    <div style="font-weight:bold; margin-bottom:5px;">ğŸ® è‡ªè¨‚æ¸¬è©¦</div>
                    <div class="input-row">
                        <button onclick="setExample(1)">2^10 = 1024</button>
                        <button onclick="setExample(2)">3^5 = 243</button>
                        <button onclick="setExample(3)">2^(-3) = 0.125</button>
                        <button onclick="resetVisualization()">â†» é‡ç½®</button>
                    </div>
                </div>
                
                <div class="expression-display">
                    <div class="expression" id="expressionDisplay">-</div>
                    <div class="result" id="resultDisplay">= ?</div>
                </div>
                
                <div style="text-align: center; color: var(--viz-text-muted); font-size: 0.85rem;">éè¿´æ¨¹ (åˆ†æ²»æ³•)</div>
                <div class="recursion-tree" id="treeDisplay"></div>

                <div class="controls" style="margin-top: 15px;">
                    <button class="viz-btn" id="prevBtn">â† ä¸Šä¸€æ­¥</button>
                    <div class="step-indicator">æ­¥é©Ÿ <span id="currentStep">0</span> / <span id="totalSteps">0</span></div>
                    <button class="viz-btn primary" id="nextBtn">ä¸‹ä¸€æ­¥ â†’</button>
                    <div class="speed-control">
                        <label>é€Ÿåº¦:</label>
                        <select id="speedSelect" onchange="viz.setSpeed(Number(this.value))">
                            <option value="1500">1x</option>
                            <option value="800">2x</option>
                        </select>
                    </div>
                </div>
                
                <div class="complexity-badge">
                    <span class="label">Time:</span> O(log n)
                    <span class="label" style="margin-left: 12px;">Space:</span> O(log n) éè¿´
                </div>
            </div>
            <div class="viz-card"><div class="viz-title">æ¼”ç®—æ³•èªªæ˜</div><div class="explanation" id="explanation"></div></div>
        </div>
        <div class="code-area">
            <div class="viz-card" style="height: 100%;">
                <div class="viz-title">åˆ†æ²»æ³• (C++)</div>
                <div class="code-panel" id="codeDisplay"></div>
            </div>
        </div>
    </div>
    <script src="../assets/visualizer/core.js"></script>
    <script>
        const codeStructure = [
            { line: 'double myPow(double x, int n) {', id: 0 },
            { line: '    if (n == 0) return 1;', id: 1 },
            { line: '    if (n < 0) {', id: 2 },
            { line: '        x = 1 / x;', id: 3 },
            { line: '        n = -n;', id: 4 },
            { line: '    }', id: 5 },
            { line: '    double half = myPow(x, n / 2);', id: 6 },
            { line: '    if (n % 2 == 0)', id: 7 },
            { line: '        return half * half;', id: 8 },
            { line: '    else', id: 9 },
            { line: '        return half * half * x;', id: 10 },
            { line: '}', id: 11 },
        ];
        
        const examples = {
            1: { x: 2, n: 10 },
            2: { x: 3, n: 5 },
            3: { x: 2, n: -3 }
        };
        
        let currentExample = examples[1];

        function setExample(num) {
            currentExample = examples[num];
            init();
        }

        function generateAlgorithmSteps(x, n) {
            const steps = [];
            const originalN = n;
            const isNegative = n < 0;
            
            if (isNegative) {
                x = 1 / x;
                n = -n;
            }

            // Build recursion tree
            const tree = [];
            let tempN = n;
            while (tempN > 0) {
                tree.push({ n: tempN, isOdd: tempN % 2 === 1, result: null });
                tempN = Math.floor(tempN / 2);
            }
            tree.push({ n: 0, isOdd: false, result: 1 });
            tree.reverse();

            steps.push({
                x, n: originalN, tree: tree.map(t => ({...t})), currentLevel: -1, finalResult: null,
                highlightLines: [0, 1, 2, 3, 4, 5],
                explanation: { 
                    title: 'åˆå§‹åŒ–', 
                    text: `è¨ˆç®— ${currentExample.x}^${originalN}<br>${isNegative ? `è² æŒ‡æ•¸: x = 1/${currentExample.x}, n = ${n}` : ''}<br><br>é—œéµ: x^n = (x^(n/2))Â²<br>æ™‚é–“ O(log n) è€Œé O(n)`,
                    formula: 'setup'
                }
            });

            // Forward recursion (descending)
            for (let i = 1; i < tree.length; i++) {
                const level = tree[i];
                steps.push({
                    x, n: originalN, tree: tree.map(t => ({...t})), currentLevel: i, finalResult: null,
                    highlightLines: [6],
                    explanation: { 
                        title: `éè¿´ n = ${level.n}`, 
                        text: `n = ${level.n}${level.isOdd ? ' (å¥‡æ•¸)' : ' (å¶æ•¸)'}<br>è¨ˆç®— pow(x, ${Math.floor(level.n / 2)})`,
                        formula: `n / 2 = ${Math.floor(level.n / 2)}`
                    }
                });
            }

            // Backward computation (ascending)
            let result = 1;  // pow(x, 0) = 1
            tree[0].result = 1;
            
            for (let i = 1; i < tree.length; i++) {
                const level = tree[i];
                const half = result;
                result = half * half;
                if (level.isOdd) result *= x;
                tree[i].result = result;
                
                steps.push({
                    x, n: originalN, tree: tree.map(t => ({...t})), currentLevel: i, computingBack: true,
                    finalResult: null,
                    highlightLines: level.isOdd ? [9, 10] : [7, 8],
                    explanation: { 
                        title: `å›æº¯ n = ${level.n}`, 
                        text: level.isOdd 
                            ? `${half}Â² Ã— ${x} = ${result.toFixed(4)}`
                            : `${half}Â² = ${result.toFixed(4)}`,
                        formula: level.isOdd ? 'halfÂ² Ã— x' : 'halfÂ²'
                    }
                });
            }

            const finalResult = isNegative ? result : result;
            steps.push({
                x, n: originalN, tree: tree.map(t => ({...t})), currentLevel: -1,
                finalResult, final: true,
                highlightLines: [8, 10],
                explanation: { 
                    title: 'å®Œæˆ!', 
                    text: `${currentExample.x}^${originalN} = ${Number.isInteger(finalResult) ? finalResult : finalResult.toFixed(6)}<br><br>åªç”¨äº† ${tree.length - 1} æ¬¡ä¹˜æ³•!`,
                    formula: 'done'
                }
            });

            return steps;
        }

        let viz;
        function init() {
            const { x, n } = currentExample;
            
            viz = new AlgorithmVisualizer({
                codeLines: codeStructure,
                onStepChange: (step) => {
                    // Expression
                    document.getElementById('expressionDisplay').textContent = 
                        `${currentExample.x}^${currentExample.n}`;
                    
                    // Result
                    if (step.finalResult !== null) {
                        const r = step.finalResult;
                        document.getElementById('resultDisplay').textContent = 
                            `= ${Number.isInteger(r) ? r : r.toFixed(6)}`;
                    } else {
                        document.getElementById('resultDisplay').textContent = '= ?';
                    }
                    
                    // Tree
                    const tree = step.tree || [];
                    document.getElementById('treeDisplay').innerHTML = tree.map((level, i) => {
                        let cls = 'tree-level';
                        if (i === step.currentLevel) cls += step.computingBack ? ' computed' : ' current';
                        else if (level.result !== null) cls += ' computed';
                        else cls += ' pending';
                        
                        const formula = level.n === 0 
                            ? 'base case' 
                            : (level.isOdd ? `(x^${Math.floor(level.n/2)})Â² Ã— x` : `(x^${Math.floor(level.n/2)})Â²`);
                        
                        return `
                            <div class="${cls}">
                                <span class="n-value">n = ${level.n}</span>
                                <span class="formula">${formula}</span>
                                <span class="result">${level.result !== null ? '= ' + (Number.isInteger(level.result) ? level.result : level.result.toFixed(4)) : ''}</span>
                            </div>
                        `;
                    }).join('');
                }
            });
            viz.setSteps(generateAlgorithmSteps(x, n));
        }
        
        function resetVisualization() { init(); }
        window.addEventListener('load', init);
    </script>
</body>
</html>
