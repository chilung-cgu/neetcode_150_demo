<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evaluate Reverse Polish Notation - è¦–è¦ºåŒ–</title>
    <link rel="stylesheet" href="../assets/visualizer/style.css">
    <style>
        .tokens { display: flex; gap: 6px; justify-content: center; margin: 20px 0; flex-wrap: wrap; }
        .token { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-weight: bold; border-radius: 6px; background: var(--viz-bg-secondary); transition: all 0.3s; }
        .token.current { background: var(--viz-secondary); color: #0f172a; transform: scale(1.1); }
        .token.processed { opacity: 0.4; }
        .token.op { color: var(--viz-error); }
        .stack { display: flex; flex-direction: column-reverse; gap: 4px; min-height: 120px; padding: 10px; background: var(--viz-bg-secondary); border-radius: 8px; width: 100px; margin: 0 auto; align-items: center; }
        .stack-item { width: 80px; height: 35px; display: flex; align-items: center; justify-content: center; font-weight: bold; border-radius: 6px; background: var(--viz-primary); color: white; }
        .calc-display { text-align: center; margin: 10px 0; padding: 10px; background: var(--viz-bg-secondary); border-radius: 6px; font-size: 1.1rem; color: var(--viz-secondary); }
        .custom-input-section { margin-top: 16px; padding: 16px; background: var(--viz-bg-secondary); border-radius: 10px; border: 1px dashed var(--viz-primary); }
        .input-title { font-weight: 600; margin-bottom: 10px; color: var(--viz-primary); }
        .input-row { display: flex; gap: 10px; align-items: center; }
        .input-row input { flex: 1; min-width: 150px; padding: 8px 12px; border-radius: 6px; border: 1px solid var(--viz-bg-secondary); background: var(--viz-bg); color: var(--viz-text-main); font-family: 'Consolas', monospace; }
        .input-row button { padding: 8px 16px; background: var(--viz-primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; }
    </style>
</head>
<body>
    <button class="theme-toggle" onclick="AlgorithmVisualizer.toggleTheme()" title="åˆ‡æ›ä¸»é¡Œ">ğŸŒ“</button>
    <div class="main-layout">
        <div class="canvas-area">
            <div class="viz-card">
                <div class="viz-title">é€†æ³¢è˜­è¡¨ç¤ºæ³•è¨ˆç®—ï¼ˆRPNï¼‰</div>
                <div class="tokens" id="tokensDisplay"></div>
                <div class="calc-display" id="calcDisplay">-</div>
                <div style="text-align: center; color: var(--text-muted);">Stack</div>
                <div class="stack" id="stackDisplay"></div>
                <div class="controls" style="margin-top: 15px;">
                    <button class="viz-btn" id="prevBtn">â† ä¸Šä¸€æ­¥</button>
                    <div class="step-indicator">æ­¥é©Ÿ <span id="currentStep">0</span> / <span id="totalSteps">0</span></div>
                    <button class="viz-btn primary" id="nextBtn">ä¸‹ä¸€æ­¥ â†’</button>
                    <button class="viz-btn" onclick="resetVisualization()">â†» é‡ç½®</button>
                    <button class="viz-btn play-btn" id="playBtn" onclick="viz.toggleAutoPlay()">â–¶ è‡ªå‹•æ’­æ”¾</button>
                    <div class="speed-control">
                        <label>é€Ÿåº¦:</label>
                        <select id="speedSelect" onchange="viz.setSpeed(Number(this.value))">
                            <option value="2000">0.5x</option>
                            <option value="1500" selected>1x</option>
                            <option value="1000">1.5x</option>
                            <option value="500">2x</option>
                        </select>
                    </div>
                </div>
                <div class="complexity-badge">
                    <span class="label">Time:</span> O(n)
                    <span class="label" style="margin-left: 12px;">Space:</span> O(n)
                </div>
                <div class="state-grid">
                    <div class="state-item"><div class="state-label">çµæœ</div><div class="state-value" id="resultDisplay" style="color: var(--viz-success);">?</div></div>
                </div>
                <div class="legend">
                    <div class="legend-item"><div class="legend-color" style="background: var(--viz-secondary);"></div>ç•¶å‰</div>
                    <div class="legend-item"><div class="legend-color" style="background: var(--viz-error);"></div>é‹ç®—å­</div>
                </div>
                <div class="custom-input-section">
                    <div class="input-title">ğŸ® è‡ªè¨‚æ¸¬è©¦</div>
                    <div class="input-row">
                        <input type="text" id="customTokens" placeholder="ç”¨ç©ºæ ¼åˆ†éš”" value="2 1 + 3 *">
                        <button onclick="runCustomInput()">åŸ·è¡Œ</button>
                    </div>
                </div>
            </div>
            <div class="viz-card"><div class="viz-title">æ¼”ç®—æ³•èªªæ˜</div><div class="explanation" id="explanation"></div></div>
        </div>
        <div class="code-area">
            <div class="viz-card" style="height: 100%;">
                <div class="viz-title">æ¼”ç®—æ³• (C++)</div>
                <div class="code-panel" id="codeDisplay"></div>
            </div>
        </div>
    </div>
    <script src="../assets/visualizer/core.js"></script>
    <script>
        const codeStructure = [
            { line: 'int evalRPN(vector<string>& tokens) {', id: 0 },
            { line: '    stack<int> st;', id: 1 },
            { line: '    for (string& t : tokens) {', id: 2 },
            { line: '        if (t == "+" || t == "-" || t == "*" || t == "/") {', id: 3 },
            { line: '            int b = st.top(); st.pop();', id: 4 },
            { line: '            int a = st.top(); st.pop();', id: 5 },
            { line: '            if (t == "+") st.push(a + b);', id: 6 },
            { line: '            else if (t == "-") st.push(a - b);', id: 7 },
            { line: '            else if (t == "*") st.push(a * b);', id: 8 },
            { line: '            else st.push(a / b);', id: 9 },
            { line: '        } else st.push(stoi(t));', id: 10 },
            { line: '    }', id: 11 },
            { line: '    return st.top();', id: 12 },
            { line: '}', id: 13 },
        ];
        const ops = ['+', '-', '*', '/'];
        let currentTokens = ["2", "1", "+", "3", "*"];
        function generateAlgorithmSteps(tokens) {
            const steps = [];
            const stack = [];
            steps.push({ current: -1, stack: [], processed: [], highlightLines: [0,1], explanation: { title: 'åˆå§‹åŒ–', text: `è¡¨é”å¼ï¼š[${tokens.map(t => `"${t}"`).join(', ')}]<br><br>é‡åˆ°æ•¸å­— â†’ Push<br>é‡åˆ°é‹ç®—å­ â†’ Pop å…©æ•¸è¨ˆç®—å¾Œ Push`, formula: `RPN ä¸éœ€è¦æ‹¬è™Ÿä¾†è¡¨ç¤ºå„ªå…ˆé †åº` } });
            for (let i = 0; i < tokens.length; i++) {
                const t = tokens[i];
                if (ops.includes(t)) {
                    if (stack.length < 2) { steps.push({ current: i, stack: [...stack], error: true, highlightLines: [4,5], explanation: { title: 'âŒ éŒ¯èª¤', text: 'Stack ä¸­å…ƒç´ ä¸è¶³' } }); return steps; }
                    const b = stack.pop(), a = stack.pop();
                    let result;
                    if (t === '+') result = a + b;
                    else if (t === '-') result = a - b;
                    else if (t === '*') result = a * b;
                    else result = Math.trunc(a / b);
                    stack.push(result);
                    steps.push({ current: i, stack: [...stack], processed: Array.from({length: i+1}, (_, j) => j), calc: `${a} ${t} ${b} = ${result}`, highlightLines: [3,4,5,6,7,8,9], explanation: { title: `è™•ç† "${t}"`, text: `Pop b=${b}, a=${a}<br>è¨ˆç®— ${a} ${t} ${b} = ${result}<br>Push ${result}`, formula: `${a} ${t} ${b} = ${result}` } });
                } else {
                    const num = parseInt(t);
                    if (isNaN(num)) { steps.push({ current: i, stack: [...stack], error: true, explanation: { title: 'âŒ éŒ¯èª¤', text: `ç„¡æ•ˆ token: "${t}"` } }); return steps; }
                    stack.push(num);
                    steps.push({ current: i, stack: [...stack], processed: Array.from({length: i+1}, (_, j) => j), calc: `Push ${num}`, highlightLines: [2,10], explanation: { title: `è™•ç† "${t}"`, text: `æ•¸å­— â†’ Push åˆ° Stack`, formula: `st.push(${num})` } });
                }
            }
            steps.push({ current: -1, stack: [...stack], processed: Array.from({length: tokens.length}, (_, j) => j), result: stack[0], highlightLines: [12], explanation: { title: 'ğŸ‰ å®Œæˆï¼', text: `çµæœ = ${stack[0]}`, formula: `return ${stack[0]}` } });
            return steps;
        }
        let viz;
        function init(tokens = currentTokens) {
            currentTokens = tokens;
            viz = new AlgorithmVisualizer({
                codeLines: codeStructure,
                onStepChange: (step) => {
                    document.getElementById('tokensDisplay').innerHTML = currentTokens.map((t, i) => {
                        let cls = 'token';
                        if (i === step.current) cls += ' current';
                        if (step.processed?.includes(i)) cls += ' processed';
                        if (ops.includes(t)) cls += ' op';
                        return `<div class="${cls}">${t}</div>`;
                    }).join('');
                    document.getElementById('stackDisplay').innerHTML = (step.stack || []).map(v => `<div class="stack-item">${v}</div>`).join('');
                    document.getElementById('calcDisplay').textContent = step.calc || '-';
                    document.getElementById('resultDisplay').textContent = step.result ?? '?';
                }
            });
            viz.setSteps(generateAlgorithmSteps(currentTokens));
        }
        function runCustomInput() {
            const input = document.getElementById('customTokens').value.trim();
            const tokens = input.split(/\s+/).filter(t => t.length > 0);
            if (tokens.length < 1 || tokens.length > 15) { alert('è«‹è¼¸å…¥ 1-15 å€‹ tokenï¼ˆç”¨ç©ºæ ¼åˆ†éš”ï¼‰'); return; }
            init(tokens);
        }
        function resetVisualization() { init(currentTokens); }
        window.addEventListener('load', () => init());
    </script>
</body>
</html>
