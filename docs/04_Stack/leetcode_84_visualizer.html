<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LeetCode 84 Visualization</title>
    <!-- å¼•å…¥å…±ç”¨æ¨£å¼ -->
    <link rel="stylesheet" href="../assets/visualizer/style.css">
</head>
<body>
    <button class="theme-toggle" onclick="AlgorithmVisualizer.toggleTheme()" title="åˆ‡æ›ä¸»é¡Œ">ğŸŒ“</button>
    <div class="main-layout">
        <!-- Left Column: Visualization -->
        <div class="canvas-area">
            <div class="viz-card">
                <div class="viz-title">HISTOGRAM VISUALIZATION</div>
                <div class="custom-input-section" style="margin-bottom: 15px; padding: 10px; background: var(--viz-bg-secondary); border-radius: 8px;">
                    <div style="font-weight:bold; margin-bottom:8px;">ğŸ® è‡ªè¨‚æ¸¬è©¦</div>
                    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                        <input type="text" id="heightsInput" value="2,1,5,6,2,3" style="padding: 8px; border-radius: 6px; border: 1px solid var(--viz-border); background: var(--viz-bg); color: var(--viz-text); width: 150px;">
                        <button onclick="runCustomInput()" style="padding: 8px 16px; background: var(--viz-primary); color: white; border: none; border-radius: 6px; cursor: pointer;">åŸ·è¡Œ</button>
                    </div>
                </div>
                <div class="chart-container" id="chartContainer">
                    <!-- Bars generated by JS -->
                </div>

                <div class="controls">
                    <button class="viz-btn" id="prevBtn">â† Prev</button>
                    <div class="step-indicator">
                        Step <span id="currentStep">0</span> / <span id="totalSteps">0</span>
                    </div>
                    <button class="viz-btn primary" id="nextBtn">Next â†’</button>
                    <button class="viz-btn" onclick="resetVisualization()">â†» Reset</button>
                </div>
                <div class="controls-row-2">
                    <button class="viz-btn play-btn" id="playBtn" onclick="viz.toggleAutoPlay()">â–¶ è‡ªå‹•æ’­æ”¾</button>
                    <div class="speed-control">
                        <label>é€Ÿåº¦:</label>
                        <select id="speedSelect" onchange="viz.setSpeed(Number(this.value))">
                            <option value="2000">0.5x</option>
                            <option value="1500" selected>1x</option>
                            <option value="1000">1.5x</option>
                            <option value="500">2x</option>
                        </select>
                    </div>
                </div>

                
                
                <div class="complexity-badge">
                    <span class="label">Time:</span> O(n)
                    <span class="label" style="margin-left: 12px;">Space:</span> O(n)
                </div>
                <div class="state-grid">
                    <div class="state-item">
                        <div class="state-label">Stack (Indices)</div>
                        <div class="state-value" id="stackDisplay" style="color: var(--viz-success);">[ ]</div>
                    </div>
                <div class="legend">
                    <div class="legend-item"><div class="legend-color normal"></div>ä¸€èˆ¬</div>
                    <div class="legend-item"><div class="legend-color current"></div>ç›®å‰è™•ç†</div>
                    <div class="legend-item"><div class="legend-color in-stack"></div>åœ¨å †ç–Šä¸­</div>
                </div>
                    <div class="state-item">
                        <div class="state-label">Max Area</div>
                        <div class="state-value" id="maxAreaDisplay" style="color: var(--viz-secondary);">0</div>
                    </div>
                </div>
            </div>

            <div class="viz-card">
                <div class="viz-title">EXPLANATION</div>
                <div class="explanation" id="explanation">
                    <!-- Dynamic text -->
                </div>
            </div>
        </div>

        <!-- Right Column: Code -->
        <div class="code-area">
            <div class="viz-card" style="height: 100%; box-sizing: border-box;">
                <div class="viz-title">ALGORITHM (C++)</div>
                <div class="code-panel" id="codeDisplay">
                    <!-- Code lines generated by JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- å¼•å…¥å…±ç”¨æ ¸å¿ƒé‚è¼¯ -->
    <script src="../assets/visualizer/core.js"></script>
    
    <!-- é¡Œç›®ç‰¹å®šé‚è¼¯ -->
    <script>
        // 1. å®šç¾©ç¨‹å¼ç¢¼
        const codeStructure = [
            { line: 'int largestRectangleArea(vector<int>& H) {', id: 0 },
            { line: '    stack<int> st;', id: 1 },
            { line: '    int maxArea = 0;', id: 2 },
            { line: '    H.push_back(0); // Sentinel', id: 3 },
            { line: '', id: 4 },
            { line: '    for (int i = 0; i < H.size(); i++) {', id: 5 },
            { line: '        while (!st.empty() && H[st.top()] > H[i]) {', id: 6 },
            { line: '            int h = H[st.top()]; st.pop();', id: 7 },
            { line: '            int w = st.empty() ? i : i - st.top() - 1;', id: 8 },
            { line: '            maxArea = max(maxArea, h * w);', id: 9 },
            { line: '        }', id: 10 },
            { line: '        st.push(i);', id: 11 },
            { line: '    }', id: 12 },
            { line: '    return maxArea;', id: 13 },
            { line: '}', id: 14 },
        ];

        // 2. å®šç¾©æ¼”ç®—æ³•ç”¢ç”Ÿæ­¥é©Ÿ
        function generateAlgorithmSteps(heightsOriginal) {
            // Copy to avoid mutation issues
            const heights = [...heightsOriginal];
            const steps = [];
            const stack = [];
            let maxArea = 0;
            
            // Add sentinel to data directly for simulation
            // In C++ code we showed push_back(0), so let's simulate that logic
            heights.push(0); 
            const n = heights.length;

            steps.push({
                stack: [...stack],
                maxArea,
                highlightLines: [0, 1, 2, 3],
                explanation: { 
                    title: 'Initialization', 
                    text: 'åˆå§‹åŒ–å †ç–Šèˆ‡æœ€å¤§é¢ç©è®Šæ•¸ã€‚æˆ‘å€‘åœ¨é™£åˆ—æœ«ç«¯åŠ å…¥é«˜åº¦ç‚º 0 çš„å“¨å…µ (Sentinel)ï¼Œç¢ºä¿æœ€å¾Œæ‰€æœ‰æŸ±å­éƒ½èƒ½è¢«çµç®—ã€‚' 
                },
                barStates: heights.map((h, i) => i === n-1 ? 'calculating' : 'normal')
            });

            for (let i = 0; i < n; i++) {
                const currentDiff = i === n-1 ? 'Sentinel (0)' : heights[i];
                
                let barStates = heights.map(h => 'normal');
                stack.forEach(idx => barStates[idx] = 'in-stack');
                barStates[i] = 'current';

                steps.push({
                    stack: [...stack],
                    maxArea,
                    highlightLines: [5, 6],
                    explanation: { 
                        title: `Iteration i = ${i}`, 
                        text: `ç›®å‰é«˜åº¦: <strong>${currentDiff}</strong>ã€‚æª¢æŸ¥å †ç–Šé ‚éƒ¨æ˜¯å¦å¤§æ–¼ç›®å‰é«˜åº¦ï¼Ÿ` 
                    },
                    barStates: [...barStates],
                    currIndex: i
                });

                while (stack.length > 0 && heights[stack[stack.length - 1]] > heights[i]) {
                    const topIdx = stack.pop();
                    const h = heights[topIdx];
                    const w = stack.length === 0 ? i : i - stack[stack.length - 1] - 1;
                    const area = h * w;
                    maxArea = Math.max(maxArea, area);

                    const popStates = heights.map(h => 'normal');
                    stack.forEach(idx => popStates[idx] = 'in-stack');
                    popStates[topIdx] = 'calculating'; // The one being popped
                    popStates[i] = 'current';          // The one forcing the pop

                    steps.push({
                        stack: [...stack],
                        maxArea,
                        highlightLines: [7, 8, 9],
                        explanation: { 
                            title: `Pop & Calculate`, 
                            text: `Index ${topIdx} (H=${h}) è¢« Index ${i} (H=${heights[i]}) æ“‹ä½ã€‚`,
                            formula: `Area = H(${h}) Ã— W(${w}) = ${area}` 
                        },
                        barStates: popStates,
                        currIndex: i
                    });
                }

                stack.push(i);
                
                // State after push
                const pushStates = heights.map(h => 'normal');
                stack.forEach(idx => pushStates[idx] = 'in-stack');
                
                steps.push({
                    stack: [...stack],
                    maxArea,
                    highlightLines: [11],
                    explanation: { 
                        title: `Push Index ${i}`, 
                        text: `å°‡ Index ${i} æ¨å…¥å †ç–Šï¼Œç¶­æŒå–®èª¿éå¢ç‰¹æ€§ã€‚` 
                    },
                    barStates: pushStates,
                    currIndex: i
                });
            }

            steps.push({
                stack: [...stack],
                maxArea,
                highlightLines: [13],
                explanation: { title: 'Finished', text: `æ¼”ç®—æ³•çµæŸï¼Œå›å‚³æœ€å¤§é¢ç©ï¼š${maxArea}` },
                barStates: heights.map(h => 'normal')
            });

            return steps;
        }

        let viz;
        let currentHeights = [2, 1, 5, 6, 2, 3];

        function runCustomInput() {
            const input = document.getElementById('heightsInput').value;
            currentHeights = input.split(',').map(s => parseInt(s.trim())).filter(n => !isNaN(n) && n >= 0);
            if (currentHeights.length === 0) currentHeights = [1];
            init();
        }

        function init() {
            viz = new AlgorithmVisualizer({
                codeLines: codeStructure,
                onStepChange: (step, data) => {
                    document.getElementById('stackDisplay').textContent = 
                        step.stack.length ? `[ ${step.stack.join(', ')} ]` : '[ ]';
                    document.getElementById('maxAreaDisplay').textContent = step.maxArea;
                    const displayHeights = [...currentHeights, 0];
                    AlgorithmVisualizer.renderBars(
                        document.getElementById('chartContainer'),
                        displayHeights,
                        step.barStates || [],
                        { height: 260 }
                    );
                }
            });
            viz.setSteps(generateAlgorithmSteps(currentHeights));
        }

        function resetVisualization() {
            init(); // Re-run logic
        }

        // Start
        window.addEventListener('load', init);

    </script>
</body>
</html>
