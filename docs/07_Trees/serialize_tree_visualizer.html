<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Serialize & Deserialize - D3 Á≤æÁ∑ªË¶ñË¶∫Âåñ</title>
    <link rel="stylesheet" href="../assets/visualizer/style.css">
    <style>
        .visualization-area {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 50%, #1e293b 100%);
            border-radius: 16px;
            padding: 20px;
            margin: 15px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 600px;
        }
        
        #viz-svg { width: 100%; height: 400px; }

        /* Tree Nodes */
        .node-circle { stroke-width: 3px; transition: all 0.3s; fill: #334155; stroke: #64748b; }
        .node-circle.active { stroke: #fbbf24; fill: rgba(251, 191, 36, 0.2); }
        .node-circle.processed { stroke: #22c55e; fill: #1e293b; }
        .node-circle.null { stroke-dasharray: 4; fill: transparent; }

        .node-text { fill: white; font-weight: bold; font-family: monospace; font-size: 14px; text-anchor: middle; dominant-baseline: middle; pointer-events: none; }
        
        .link { fill: none; stroke: #64748b; stroke-width: 2px; transition: all 0.5s; opacity: 0.6; }

        /* String / Queue Visualization */
        .data-panel {
            width: 90%;
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .data-row {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid #475569;
            border-radius: 8px;
            padding: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            overflow-x: auto;
        }
        .data-label { color: #94a3b8; font-size: 0.8rem; font-weight: bold; min-width: 80px; text-align: right; }
        
        .data-item {
            padding: 5px 10px;
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid #3b82f6;
            border-radius: 4px;
            color: #e2e8f0;
            font-family: monospace;
            white-space: nowrap;
            display: flex; align-items: center; justify-content: center;
        }
        .data-item.active { background: #fbbf24; color: #0f172a; border-color: #fbbf24; font-weight: bold; }
        .data-item.null { color: #94a3b8; border-color: #64748b; border-style: dashed; }

        /* Controls */
        .custom-input-section { background: var(--viz-card-bg); border-radius: 8px; padding: 15px; border: 1px solid var(--viz-border); }
        .mode-toggle { display: flex; gap: 10px; margin-bottom: 10px; justify-content: center; }
        .mode-btn { padding: 6px 12px; border-radius: 6px; border: 1px solid #475569; background: transparent; color: #94a3b8; cursor: pointer; }
        .mode-btn.active { background: #3b82f6; color: white; border-color: #3b82f6; }
        
        .input-row { display: flex; gap: 10px; align-items: center; justify-content: center; }
        .input-row input { padding: 8px; border-radius: 6px; border: 1px solid var(--viz-border); background: var(--viz-input-bg); color: var(--viz-text); font-family: monospace; width: 250px; }
        .input-row button { padding: 8px 16px; border-radius: 6px; background: var(--viz-primary); color: white; border: none; cursor: pointer; }

        .step-breakdown { background: rgba(30, 41, 59, 0.6); border-radius: 12px; border-left: 4px solid #3b82f6; padding: 15px 20px; margin-top: 15px; width: 100%; box-sizing: border-box; }
    </style>
</head>
<body>
    <button class="theme-toggle" onclick="AlgorithmVisualizer.toggleTheme()" title="ÂàáÊèõ‰∏ªÈ°å">üåì</button>
    <div class="main-layout">
        <div class="canvas-area">
            <div class="viz-card">
                <div class="viz-title">Serialize & Deserialize (BFS)</div>
                <div class="custom-input-section">
                    <div class="mode-toggle">
                        <button class="mode-btn active" id="btn-ser" onclick="setMode('serialize')">Serialize (Tree ‚Üí String)</button>
                        <button class="mode-btn" id="btn-des" onclick="setMode('deserialize')">Deserialize (String ‚Üí Tree)</button>
                    </div>
                    <div class="input-row">
                        <label id="inputLabel">Tree:</label>
                        <input type="text" id="dataInput" value="1,2,3,null,null,4,5">
                        <button onclick="runVisualizer()">Run</button>
                    </div>
                </div>

                <div class="visualization-area">
                    <svg id="viz-svg">
                        <g id="main-group" transform="translate(40, 40)"></g>
                    </svg>
                    
                    <div class="data-panel">
                        <div class="data-row">
                            <div class="data-label">Queue</div>
                            <div id="queueDisplay" style="display:flex; gap:5px;"></div>
                        </div>
                        <div class="data-row">
                            <div class="data-label">Result String</div>
                            <div id="stringDisplay" style="display:flex; gap:5px;"></div>
                        </div>
                    </div>
                </div>

                <div class="step-breakdown">
                    <div style="font-size:0.75rem; font-weight:bold; color:#64748b;">Áï∂ÂâçÊ≠•È©ü</div>
                    <div id="stepText" style="font-size:0.95rem; font-family:monospace; color:#e2e8f0;">Ready.</div>
                </div>

                <div class="controls" style="margin-top: 15px;">
                    <button class="viz-btn" id="prevBtn">‚Üê ‰∏ä‰∏ÄÊ≠•</button>
                    <div class="step-indicator">Ê≠•È©ü <span id="currentStep">0</span> / <span id="totalSteps">0</span></div>
                    <button class="viz-btn primary" id="nextBtn">‰∏ã‰∏ÄÊ≠• ‚Üí</button>
                    <button class="viz-btn" onclick="runVisualizer()">‚Üª ÈáçÁΩÆ</button>
                    <button class="viz-btn play-btn" id="playBtn" onclick="viz.toggleAutoPlay()">‚ñ∂ Ëá™ÂãïÊí≠Êîæ</button>
                    <div class="speed-control">
                        <label>ÈÄüÂ∫¶:</label>
                        <select id="speedSelect" onchange="viz.setSpeed(Number(this.value))">
                            <option value="1500">0.5x</option>
                            <option value="1000" selected>1x</option>
                            <option value="500">1.5x</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="viz-card"><div class="viz-title">ÈÇèËºØËß£Èáã</div><div class="explanation" id="explanation"></div></div>
        </div>
        <div class="code-area">
            <div class="viz-card" style="height: 100%;">
                <div class="viz-title">C++ Code</div>
                <div class="code-panel" id="codeDisplay"></div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="../assets/visualizer/core.js"></script>
    <script>
        const codeSerialize = [
            { line: 'string serialize(root) {', id: 0 },
            { line: '    if(!root) return "";', id: 1 },
            { line: '    string res = "";', id: 2 },
            { line: '    queue<Node*> q; q.push(root);', id: 3 },
            { line: '    while(!q.empty()) {', id: 4 },
            { line: '        Node* node = q.front(); q.pop();', id: 5 },
            { line: '        if(node) {', id: 6 },
            { line: '            res += to_string(node->val) + ",";', id: 7 },
            { line: '            q.push(node->left);', id: 8 },
            { line: '            q.push(node->right);', id: 9 },
            { line: '        } else {', id: 10 },
            { line: '            res += "null,";', id: 11 },
            { line: '        }', id: 12 },
            { line: '    }', id: 13 },
            { line: '    return res;', id: 14 },
            { line: '}', id: 15 }
        ];

        const codeDeserialize = [
            { line: 'Node* deserialize(data) {', id: 0 },
            { line: '    if(data.empty()) return nullptr;', id: 1 },
            { line: '    stringstream ss(data); string str;', id: 2 },
            { line: '    getline(ss, str, ",");', id: 3 },
            { line: '    Node* root = new Node(stoi(str));', id: 4 },
            { line: '    queue<Node*> q; q.push(root);', id: 5 },
            { line: '    while(!q.empty()) {', id: 6 },
            { line: '        Node* node = q.front(); q.pop();', id: 7 },
            { line: '        getline(ss, str, ",");', id: 8 },
            { line: '        if(str != "null") {', id: 9 },
            { line: '            node->left = new Node(stoi(str));', id: 10 },
            { line: '            q.push(node->left);', id: 11 },
            { line: '        }', id: 12 },
            { line: '        getline(ss, str, ",");', id: 13 },
            { line: '        if(str != "null") {', id: 14 },
            { line: '            node->right = new Node(stoi(str));', id: 15 },
            { line: '            q.push(node->right);', id: 16 },
            { line: '        }', id: 17 },
            { line: '    }', id: 18 },
            { line: '    return root;', id: 19 },
            { line: '}', id: 20 }
        ];

        let mode = 'serialize';
        let viz;

        function setMode(m) {
            mode = m;
            document.getElementById('btn-ser').classList.toggle('active', mode==='serialize');
            document.getElementById('btn-des').classList.toggle('active', mode==='deserialize');
            document.getElementById('inputLabel').textContent = mode === 'serialize' ? 'Tree:' : 'String:';
            // Swap placeholder content logic is handled but assume user changes input manually or keeps standard
            runVisualizer();
        }

        // Tree Helper
        function buildTree(arr) {
            if (!arr || arr.length === 0) return null;
            const root = { id: 0, val: arr[0], children: [] };
            const queue = [root];
            let i = 1;
            while (i < arr.length) {
                const parent = queue.shift();
                if (i < arr.length && arr[i] !== null) {
                    const left = { id: i, val: arr[i], children: [] };
                    parent.children[0] = left; 
                    queue.push(left);
                }
                i++;
                if (i < arr.length && arr[i] !== null) {
                    const right = { id: i, val: arr[i], children: [] };
                    parent.children[1] = right;
                    queue.push(right);
                }
                i++;
            }
            return root;
        }

        function cleanHierarchy(node) {
            if(!node) return null;
            const c = [];
            if(node.children[0]) c.push(cleanHierarchy(node.children[0]));
            if(node.children[1]) c.push(cleanHierarchy(node.children[1]));
            return { ...node, children: c };
        }

        // Simulation: Serialize
        function simulateSerialize(arr) {
            const steps = [];
            const root = buildTree(arr);
            if(!root) return []; 

            // Initialize
            const result = [];
            const queue = [root]; // contains node objects
            const queueVisual = [root.val]; // vals for display
            const processedIds = [];

            const pushState = (msg, hl, activeId=null, explanation=null) => {
                steps.push({
                    root: cleanHierarchy(root),
                    queueVisual: [...queueVisual],
                    resultString: [...result],
                    processedIds: [...processedIds],
                    activeId,
                    msg, highlightLines: hl,
                    explanation
                });
            };

            pushState("Init: Push root to queue", [3], root.id, {
                title: 'ÂàùÂßãÂåñ',
                text: 'Â∞áÊ†πÁØÄÈªûÂä†ÂÖ• Queue„ÄÇ',
                formula: 'q.push(root)'
            });

            while(queue.length > 0) {
                const node = queue.shift();
                queueVisual.shift(); // Remove from visual queue too
                
                if (node) {
                    processedIds.push(node.id);
                    result.push(node.val);
                    
                    pushState(`Pop ${node.val}, Add to Result`, [5, 6, 7], node.id, {
                        title: `ËôïÁêÜÁØÄÈªû ${node.val}`,
                        text: `Âæû Queue ÂèñÂá∫ ${node.val}ÔºåÂä†ÂÖ•ÁµêÊûúÂ≠ó‰∏≤„ÄÇÂêåÊôÇÂ∞áÂÖ∂Â∑¶Âè≥Â≠êÁØÄÈªûÔºàÂê´ nullÔºâÂä†ÂÖ• Queue„ÄÇ`,
                        formula: `res += "${node.val},"`
                    });

                    // Add children
                    if(node.children && node.children[0]) {
                        queue.push(node.children[0]);
                        queueVisual.push(node.children[0].val);
                    } else {
                        queue.push(null);
                        queueVisual.push("null");
                    }
                    
                    if(node.children && node.children[1]) {
                        queue.push(node.children[1]);
                        queueVisual.push(node.children[1].val);
                    } else {
                        queue.push(null);
                        queueVisual.push("null");
                    }
                } else {
                    result.push("null");
                    pushState(`Pop null, Add to Result`, [10, 11], null, {
                        title: 'ËôïÁêÜ null ÁØÄÈªû',
                        text: 'Queue ‰∏≠ÂèñÂá∫ nullÔºåÂ∞á "null" Âä†ÂÖ•ÁµêÊûúÂ≠ó‰∏≤‰ª•Ê®ôË®òÁ©∫‰Ωç„ÄÇ',
                        formula: 'res += "null,"'
                    });
                }
            }
            
            return steps;
        }

        // Simulation: Deserialize (simplified visual structure)
        function simulateDeserialize(str) {
            const steps = [];
            const vals = str.split(',').map(s => s.trim() === 'null' ? null : parseInt(s.trim()));
            if(vals.length === 0) return [];

            // We need to build the tree incrementally for visualization
            // But D3 needs structure. We can pre-build full tree and hide/show nodes.
            const fullTree = buildTree(vals);
            const visibleIds = [];
            const queueVisual = []; // Shows nodes currently in queue for child attachment
            
            const pushState = (msg, hl, activeId=null, explanation=null) => {
                steps.push({
                    root: cleanHierarchy(fullTree),
                    visibleIds: [...visibleIds], // Mask for rendering
                    queueVisual: [...queueVisual], // IDs
                    resultString: vals.map(v => v===null?'null':v), // Static input
                    processedIds: [], // Not really used in Deser
                    activeId,
                    msg, highlightLines: hl,
                    explanation
                });
            };

            // Start
            if(vals[0] === null) return steps;
            
            const rootId = 0; // Assuming 0 is root if constructed by buildTree logic
            visibleIds.push(rootId);
            queueVisual.push(fullTree.val); 
            
            // We need to match logic exactly.
            // Queue holds Nodes.
            const q = [fullTree]; // Objects
            let i = 1;

            pushState("Init: Create Root and Queue", [4, 5], rootId, {
                title: 'ÂàùÂßãÂåñ',
                text: `ËÆÄÂèñÁ¨¨‰∏ÄÂÄãÂÄº ${fullTree.val}ÔºåÂª∫Á´ãÊ†πÁØÄÈªû‰∏¶Âä†ÂÖ• Queue„ÄÇ`,
                formula: 'root = new Node(val)'
            });

            while(q.length > 0 && i < vals.length) {
                const parent = q.shift();
                queueVisual.shift(); // Visual align
                
                pushState(`Pop Parent ${parent.val}`, [7], parent.id, {
                    title: `ËôïÁêÜÁà∂ÁØÄÈªû ${parent.val}`,
                    text: `Âæû Queue ÂèñÂá∫ ${parent.val}ÔºåÊ∫ñÂÇôÁÇ∫ÂÖ∂Êé•‰∏äÂ∑¶Âè≥Â≠êÁØÄÈªû„ÄÇ`,
                    formula: 'node = q.pop()'
                });

                // Left
                if(i < vals.length) {
                    const lVal = vals[i];
                    if(lVal !== null) {
                        const lNode = parent.children[0];
                        visibleIds.push(lNode.id);
                        q.push(lNode);
                        queueVisual.push(lNode.val);
                        pushState(`Attach Left: ${lVal}`, [9, 10, 11], lNode.id, {
                            title: 'ÈÄ£Êé•Â∑¶Â≠êÁØÄÈªû',
                            text: `ËÆÄÂèñ‰∏ã‰∏ÄÂÄãÂÄº ${lVal}ÔºåÂª∫Á´ãÁØÄÈªû‰∏¶Êé•Âú® ${parent.val} ÁöÑÂ∑¶ÈÇä„ÄÇÂä†ÂÖ• Queue„ÄÇ`,
                            formula: 'node->left = new Node()'
                        });
                    } else {
                        pushState(`Left is null`, [9], parent.id, {
                            title: 'Â∑¶Â≠êÁØÄÈªûÁÇ∫Á©∫',
                            text: 'ËÆÄÂèñÂà∞ nullÔºåË∑≥ÈÅéÂª∫Á´ãÂ∑¶Â≠êÁØÄÈªû„ÄÇ',
                            formula: 'str == "null"'
                        });
                    }
                    i++;
                }

                // Right
                if(i < vals.length) {
                    const rVal = vals[i];
                    if(rVal !== null) {
                        const rNode = parent.children[1];
                        visibleIds.push(rNode.id);
                        q.push(rNode);
                        queueVisual.push(rNode.val);
                        pushState(`Attach Right: ${rVal}`, [14, 15, 16], rNode.id, {
                            title: 'ÈÄ£Êé•Âè≥Â≠êÁØÄÈªû',
                            text: `ËÆÄÂèñ‰∏ã‰∏ÄÂÄãÂÄº ${rVal}ÔºåÂª∫Á´ãÁØÄÈªû‰∏¶Êé•Âú® ${parent.val} ÁöÑÂè≥ÈÇä„ÄÇÂä†ÂÖ• Queue„ÄÇ`,
                            formula: 'node->right = new Node()'
                        });
                    } else {
                        pushState(`Right is null`, [14], parent.id, {
                            title: 'Âè≥Â≠êÁØÄÈªûÁÇ∫Á©∫',
                            text: 'ËÆÄÂèñÂà∞ nullÔºåË∑≥ÈÅéÂª∫Á´ãÂè≥Â≠êÁØÄÈªû„ÄÇ',
                            formula: 'str == "null"'
                        });
                    }
                    i++;
                }
            }
            
            pushState("Done", [19], null, {
                title: 'ÂÆåÊàê',
                text: 'Â≠ó‰∏≤Ëß£ÊûêÂÆåÁï¢ÔºåÊ®πÈáçÂª∫ÂÆåÊàê„ÄÇ',
                formula: 'return root'
            });

            return steps;
        }

        const width = 600;
        const height = 400;
        const treeLayout = d3.tree().size([width, height]);
        const gMain = d3.select("#main-group");

        function render(step) {
            document.getElementById('stepText').textContent = step.msg;

            // Render Queue
            const qContainer = document.getElementById('queueDisplay');
            qContainer.innerHTML = '';
            if(step.queueVisual.length === 0) {
                qContainer.innerHTML = '<span style="color:#64748b; font-size:0.8rem;">Empty</span>';
            } else {
                step.queueVisual.forEach(v => {
                    const dim = document.createElement('div');
                    dim.className = v === "null" || v === null ? 'data-item null' : 'data-item active';
                    dim.textContent = v;
                    qContainer.appendChild(dim);
                });
            }

            // Render Result String
            const sContainer = document.getElementById('stringDisplay');
            sContainer.innerHTML = '';
            if(step.resultString.length === 0) {
                sContainer.innerHTML = '<span style="color:#64748b; font-size:0.8rem;">Empty</span>';
            } else {
                step.resultString.forEach(v => {
                    const dim = document.createElement('div');
                    dim.className = v === "null" || v === null ? 'data-item null' : 'data-item';
                    dim.textContent = v;
                    sContainer.appendChild(dim);
                });
            }

            // Render Tree
            if(!step.root) return;
            
            const root = d3.hierarchy(step.root);
            treeLayout(root);

            // Links
            const links = gMain.selectAll(".link").data(root.links(), d => d.source.data.id + "-" + d.target.data.id);
            links.enter().append("path").attr("class", "link")
                .merge(links)
                .transition().duration(300)
                .attr("d", d3.linkVertical().x(d => d.x).y(d => d.y))
                .style("opacity", d => {
                    // In deserialize mode, hide invisible links
                    if(mode === 'deserialize') {
                        return step.visibleIds.includes(d.target.data.id) ? 0.6 : 0;
                    }
                    return 0.6;
                });
            links.exit().remove();

            // Nodes
            const nodes = gMain.selectAll(".node-g").data(root.descendants(), d => d.data.id);
            const nEnter = nodes.enter().append("g").attr("class", "node-g");
            nEnter.append("circle").attr("r", 20).attr("class", "node-circle");
            nEnter.append("text").attr("class", "node-text").attr("dy", 1);

            const nUpdate = nodes.merge(nEnter).transition().duration(300)
                .attr("transform", d => `translate(${d.x}, ${d.y})`)
                .style("opacity", d => {
                    if(mode === 'deserialize') {
                        return step.visibleIds.includes(d.data.id) ? 1 : 0;
                    }
                    return 1;
                });
            
            nUpdate.select("circle").attr("class", d => {
                let c = "node-circle";
                if(d.data.id === step.activeId) c += " active";
                else if(step.processedIds && step.processedIds.includes(d.data.id)) c += " processed";
                else if(mode === 'deserialize' && step.visibleIds.includes(d.data.id)) c+= " processed";
                return c;
            })
            .style("stroke-width", d => (d.data.id === step.activeId) ? 5 : 3);

            nUpdate.select("text").text(d => d.data.val);
            nodes.exit().remove();
        }

        function runVisualizer() {
            const inputVal = document.getElementById('dataInput').value;
            
            viz = new AlgorithmVisualizer({
                codeLines: mode === 'serialize' ? codeSerialize : codeDeserialize,
                onStepChange: render
            });

            if (mode === 'serialize') {
                const arr = inputVal.split(',').map(x => {
                    const t = x.trim();
                    return t === 'null' || t === '' ? null : parseInt(t);
                });
                viz.setSteps(simulateSerialize(arr));
            } else {
                viz.setSteps(simulateDeserialize(inputVal));
            }
        }

        window.addEventListener('load', runVisualizer);
    </script>
</body>
</html>
