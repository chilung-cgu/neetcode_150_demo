<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kth Largest Element in Array - è¦–è¦ºåŒ–</title>
    <link rel="stylesheet" href="../assets/visualizer/style.css">
    <style>
        .chart-container { 
            display: flex; align-items: flex-end; justify-content: center; 
            height: 200px; gap: 5px; margin: 20px 0; padding-bottom: 20px;
        }
        .bar-wrapper {
            display: flex; flex-direction: column; align-items: center; width: 40px;
            transition: all 0.3s;
        }
        .bar { 
            width: 100%; background: var(--viz-primary); 
            border-radius: 4px 4px 0 0; transition: height 0.3s, background 0.3s; 
        }
        .bar-label { margin-top: 5px; font-weight: bold; }
        .bar.pivot { background: var(--viz-warning); }
        .bar.left { background: #3b82f6; }
        .bar.right { background: #8b5cf6; }
        .bar.found { background: var(--viz-success); box-shadow: 0 0 10px var(--viz-success); }
        .bar.ignore { background: var(--viz-bg-secondary); opacity: 0.3; }
        
        .custom-input-section { background: var(--viz-card-bg); border-radius: 8px; padding: 15px; margin-bottom: 15px; border: 1px solid var(--viz-border); }
        .input-row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-bottom: 8px; }
        .input-row input { padding: 8px 12px; border-radius: 6px; border: 1px solid var(--viz-border); background: var(--viz-input-bg); color: var(--viz-text); font-family: monospace; }
        .input-row button { padding: 8px 16px; border-radius: 6px; background: var(--viz-primary); color: white; border: none; cursor: pointer; }
        
        .partition-info {
            display: flex; gap: 15px; justify-content: center; margin-bottom: 10px;
            font-size: 0.9rem; color: var(--viz-text-muted); padding: 8px; background: rgba(0,0,0,0.2); border-radius: 6px;
        }
    </style>
</head>
<body>
    <button class="theme-toggle" onclick="AlgorithmVisualizer.toggleTheme()" title="åˆ‡æ›ä¸»é¡Œ">ğŸŒ“</button>
    <div class="main-layout">
        <div class="canvas-area">
            <div class="viz-card">
                <div class="viz-title">æ•¸çµ„ä¸­çš„ç¬¬ K å€‹æœ€å¤§å…ƒç´  (QuickSelect)</div>
                <div class="custom-input-section">
                    <div style="font-weight:bold; margin-bottom:5px;">ğŸ® è‡ªè¨‚æ¸¬è©¦</div>
                    <div class="input-row">
                        <label>é™£åˆ—:</label>
                        <input type="text" id="arrayInput" value="3, 2, 1, 5, 6, 4" style="width: 200px;">
                        <label>K:</label>
                        <input type="number" id="kInput" value="2" style="width: 50px;" min="1">
                        <button onclick="runCustomInput()">åŸ·è¡Œ</button>
                    </div>
                </div>
                
                <div class="partition-info">
                    <div>Range: [<span id="rangeL">-</span>, <span id="rangeR">-</span>]</div>
                    <div>Target Index: <span id="targetIdxDisplay">-</span></div>
                    <div>Pivot: <span id="pivotValDisplay">-</span></div>
                </div>

                <div class="chart-container" id="chartContainer"></div>
                
                <div class="controls" style="margin-top: 15px;">
                    <button class="viz-btn" id="prevBtn">â† ä¸Šä¸€æ­¥</button>
                    <div class="step-indicator">æ­¥é©Ÿ <span id="currentStep">0</span> / <span id="totalSteps">0</span></div>
                    <button class="viz-btn primary" id="nextBtn">ä¸‹ä¸€æ­¥ â†’</button>
                    <button class="viz-btn" onclick="resetVisualization()">â†» é‡ç½®</button>
                    <div class="speed-control">
                        <label>é€Ÿåº¦:</label>
                        <select id="speedSelect" onchange="viz.setSpeed(Number(this.value))">
                            <option value="1500">1x</option>
                            <option value="500">2x</option>
                        </select>
                    </div>
                </div>
                
                <div class="complexity-badge">
                    <span class="label">Time:</span> Avg O(n), Worst O(nÂ²)
                    <span class="label" style="margin-left: 12px;">Space:</span> O(1)
                </div>
                <div class="state-grid">
                    <div class="state-item"><div class="state-label">ç¬¬ K å¤§</div><div class="state-value" id="resultDisplay" style="color: var(--viz-success);">?</div></div>
                </div>
                <div class="legend">
                    <div class="legend-item"><div class="legend-color pivot" style="background:var(--viz-warning)"></div>Pivot</div>
                    <div class="legend-item"><div class="legend-color left" style="background:#3b82f6"></div>&lt; Pivot</div>
                    <div class="legend-item"><div class="legend-color right" style="background:#8b5cf6"></div>&gt; Pivot</div>
                    <div class="legend-item"><div class="legend-color found" style="background:var(--viz-success)"></div>Found</div>
                </div>
            </div>
            <div class="viz-card"><div class="viz-title">æ¼”ç®—æ³•èªªæ˜</div><div class="explanation" id="explanation"></div></div>
        </div>
        <div class="code-area">
            <div class="viz-card" style="height: 100%;">
                <div class="viz-title">æ¼”ç®—æ³• (C++)</div>
                <div class="code-panel" id="codeDisplay"></div>
            </div>
        </div>
    </div>
    <script src="../assets/visualizer/core.js"></script>
    <script>
        const codeStructure = [
            { line: 'int findKthLargest(nums, k) {', id: 0 },
            { line: '    int target = nums.size() - k;', id: 1 },
            { line: '    return quickSelect(nums, 0, n-1, target);', id: 2 },
            { line: '}', id: 3 },
            { line: 'int quickSelect(nums, l, r, k) {', id: 4 },
            { line: '    int p = partition(nums, l, r);', id: 5 },
            { line: '    if (p == k) return nums[p];', id: 6 },
            { line: '    if (p < k) return quickSelect(nums, p+1, r, k);', id: 7 },
            { line: '    else return quickSelect(nums, l, p-1, k);', id: 8 },
            { line: '}', id: 9 },
        ];

        let currentNums = [3, 2, 1, 5, 6, 4];
        let currentK = 2;

        function parseArray(str) {
            return str.split(',').map(x => parseInt(x.trim())).filter(x => !isNaN(x));
        }

        // QuickSelect implementation with step generation
        function generateAlgorithmSteps(numsInput, k) {
            const steps = [];
            const nums = [...numsInput]; // Local copy to mutate
            const target = nums.length - k;
            
            steps.push({
                arr: [...nums],
                l: 0, r: nums.length - 1,
                target: target,
                pivotIdx: null,
                highlightLines: [0, 1, 2],
                explanation: {
                    title: 'åˆå§‹åŒ– QuickSelect',
                    text: `å°‹æ‰¾ç¬¬ ${k} å¤§å…ƒç´  = æ’åºå¾Œç¬¬ ${target} å°å…ƒç´  (index ${target})<br>ç¯„åœ: [0, ${nums.length-1}]`,
                    formula: `target = size - k = ${nums.length} - ${k} = ${target}`
                }
            });

            function partition(l, r) {
                const pivot = nums[r];
                let p = l;
                
                steps.push({
                    arr: [...nums], l, r, target,
                    pivotIdx: r, p: p,
                    highlightLines: [5],
                    explanation: {
                        title: `Partition [${l}, ${r}]`,
                        text: `é¸æ“‡ Pivot: ${pivot} (index ${r})<br>é–‹å§‹åˆ†å€...`,
                        formula: `pivot = nums[${r}]`
                    }
                });

                for (let i = l; i < r; i++) {
                    const isLess = nums[i] <= pivot;
                    steps.push({
                        arr: [...nums], l, r, target,
                        pivotIdx: r, p: p, currentIdx: i,
                        highlightLines: [5],
                        explanation: {
                            title: `æ¯”è¼ƒ ${nums[i]} vs ${pivot}`,
                            text: `${nums[i]} ${isLess ? '<=' : '>'} ${pivot}<br>${isLess ? 'äº¤æ›åˆ°å‰é¢' : 'ä¿ç•™'}`,
                            formula: `nums[${i}] <= ${pivot}`
                        }
                    });

                    if (isLess) {
                        [nums[i], nums[p]] = [nums[p], nums[i]];
                        p++;
                    }
                }

                [nums[p], nums[r]] = [nums[r], nums[p]];
                
                steps.push({
                    arr: [...nums], l, r, target,
                    pivotIdx: p, // Pivot is now at p
                    finalPivot: true,
                    highlightLines: [5],
                    explanation: {
                        title: 'Partition å®Œæˆ',
                        text: `Pivot ${pivot} æ”¾ç½®åœ¨ index ${p}<br>å·¦å´ <= ${pivot}ï¼Œå³å´ > ${pivot}`,
                        formula: `pivotIndex = ${p}`
                    }
                });

                return p;
            }

            function quickSelect(l, r) {
                if (l > r) return;

                const p = partition(l, r);

                if (p === target) {
                    steps.push({
                        arr: [...nums], l, r, target,
                        pivotIdx: p,
                        found: true,
                        highlightLines: [6],
                        explanation: {
                            title: 'æ‰¾åˆ°ç›®æ¨™ï¼',
                            text: `Pivot index ${p} ç­‰æ–¼ Target index ${target}<br>çµæœç‚º ${nums[p]}`,
                            formula: `return nums[${p}]`
                        }
                    });
                    return nums[p];
                } else if (p < target) {
                    steps.push({
                        arr: [...nums], l, r, target,
                        pivotIdx: p,
                        highlightLines: [7],
                        explanation: {
                            title: 'å¾€å³æœå°‹',
                            text: `Index ${p} < Target ${target}ï¼Œç›®æ¨™åœ¨å³å´ [${p+1}, ${r}]`,
                            formula: `quickSelect(p+1, r, k)`
                        }
                    });
                    return quickSelect(p + 1, r);
                } else {
                    steps.push({
                        arr: [...nums], l, r, target,
                        pivotIdx: p,
                        highlightLines: [8],
                        explanation: {
                            title: 'å¾€å·¦æœå°‹',
                            text: `Index ${p} > Target ${target}ï¼Œç›®æ¨™åœ¨å·¦å´ [${l}, ${p-1}]`,
                            formula: `quickSelect(l, p-1, k)`
                        }
                    });
                    return quickSelect(l, p - 1);
                }
            }

            quickSelect(0, nums.length - 1);
            return steps;
        }

        function runCustomInput() {
            const arrStr = document.getElementById('arrayInput').value;
            const kVal = parseInt(document.getElementById('kInput').value);
            const arr = parseArray(arrStr);
            if (arr.length === 0 || isNaN(kVal) || kVal < 1 || kVal > arr.length) {
                alert('è¼¸å…¥ç„¡æ•ˆ');
                return;
            }
            currentNums = arr;
            currentK = kVal;
            init();
        }

        let viz;
        function init() {
            // Determine max value for chart scaling
            const maxVal = Math.max(...currentNums, 1);
            
            viz = new AlgorithmVisualizer({
                codeLines: codeStructure,
                onStepChange: (step) => {
                    // Update Chart
                    const chart = document.getElementById('chartContainer');
                    chart.innerHTML = '';
                    
                    step.arr.forEach((val, idx) => {
                        const wrapper = document.createElement('div');
                        wrapper.className = 'bar-wrapper';
                        
                        const bar = document.createElement('div');
                        bar.className = 'bar';
                        bar.style.height = `${(val / maxVal) * 150}px`; // 150px max height
                        
                        // Apply styling
                        if (step.found && idx === step.target) bar.classList.add('found');
                        else if (idx === step.pivotIdx && (step.finalPivot || step.currentIdx !== undefined)) bar.classList.add('pivot');
                        else if (step.l <= idx && idx <= step.r) {
                            // In current range
                            if (step.pivotIdx !== undefined && step.pivotIdx !== null) {
                                if (step.finalPivot) {
                                     if (idx < step.pivotIdx) bar.classList.add('left');
                                     else if (idx > step.pivotIdx) bar.classList.add('right');
                                } else {
                                     // During partition
                                }
                            }
                        } else {
                            bar.classList.add('ignore');
                        }
                        
                        wrapper.appendChild(bar);
                        
                        const label = document.createElement('div');
                        label.className = 'bar-label';
                        label.textContent = val;
                        wrapper.appendChild(label);
                        
                        chart.appendChild(wrapper);
                    });

                    document.getElementById('rangeL').textContent = step.l ?? '-';
                    document.getElementById('rangeR').textContent = step.r ?? '-';
                    document.getElementById('targetIdxDisplay').textContent = step.target ?? '-';
                    document.getElementById('pivotValDisplay').textContent = (step.pivotIdx !== null && step.pivotIdx !== undefined) ? step.arr[step.pivotIdx] : '-';
                    document.getElementById('resultDisplay').textContent = step.found ? step.arr[step.target] : '?';
                }
            });
            viz.setSteps(generateAlgorithmSteps(currentNums, currentK));
        }
        function resetVisualization() { init(); }
        window.addEventListener('load', init);
    </script>
</body>
</html>
