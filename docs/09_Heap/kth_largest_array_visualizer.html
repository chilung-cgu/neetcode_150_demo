<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Kth Largest Element (QuickSelect) - Á≤æÁ∑ªË¶ñË¶∫Âåñ</title>
    <link rel="stylesheet" href="../assets/visualizer/style.css">
    <style>
        .visualization-area {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 50%, #1e293b 100%);
            border-radius: 16px;
            padding: 20px;
            margin: 15px 0;
            display: flex;
            flex-direction: column;
            gap: 20px;
            align-items: center;
        }

        .array-container {
            display: flex; gap: 12px; justify-content: center; align-items: flex-end;
            height: 250px; padding: 20px; width: 100%; position: relative;
        }

        .bar-group {
            display: flex; flex-direction: column; align-items: center;
            width: 50px; position: relative; transition: all 0.4s ease;
        }

        .bar {
            width: 100%; background: rgba(59, 130, 246, 0.3); border: 2px solid #3b82f6;
            border-radius: 8px 8px 0 0; transition: all 0.3s;
            display: flex; align-items: flex-end; justify-content: center;
            padding-bottom: 5px; color: white; font-weight: bold; font-family: monospace;
        }

        /* States */
        .bar-group.dimmed .bar { opacity: 0.2; border-color: #475569; background: #1e293b; }
        .bar-group.pivot .bar { background: #fbbf24; border-color: #f59e0b; box-shadow: 0 0 15px rgba(251, 191, 36, 0.4); color: #451a03; }
        .bar-group.less .bar { background: #3b82f6; border-color: #60a5fa; }
        .bar-group.greater .bar { background: #8b5cf6; border-color: #a78bfa; }
        .bar-group.found .bar { background: #22c55e; border-color: #4ade80; box-shadow: 0 0 20px rgba(34, 197, 94, 0.5); transform: scale(1.1); z-index: 10; }

        .idx-label { font-size: 0.7rem; color: #64748b; margin-top: 5px; }

        /* Pointers */
        .pointer {
            position: absolute; font-size: 0.8rem; font-weight: bold;
            display: flex; flex-direction: column; align-items: center; transition: left 0.3s;
            width: 50px; /* same as bar width */
            text-align: center;
        }
        .pointer-p { color: #fbbf24; top: -30px; } /* Store Index */
        .pointer.scan { bottom: -30px; color: #cbd5e1; } /* Scanner */

        .stats-panel {
            display: flex; gap: 20px; background: rgba(15, 23, 42, 0.6); padding: 10px 20px; border-radius: 12px;
        }
        .stat-item { text-align: center; }
        .stat-label { font-size: 0.75rem; color: #94a3b8; margin-bottom: 2px; }
        .stat-val { font-size: 1.1rem; color: #e2e8f0; font-weight: bold; }

        /* Controls */
        .custom-input-section { background: var(--viz-card-bg); border-radius: 8px; padding: 15px; border: 1px solid var(--viz-border); }
        .input-row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .input-row input { padding: 8px; border-radius: 6px; border: 1px solid var(--viz-border); background: var(--viz-input-bg); color: var(--viz-text); font-family: monospace; width: 120px; }
        .input-row button { padding: 8px 16px; border-radius: 6px; background: var(--viz-primary); color: white; border: none; cursor: pointer; }

        .step-breakdown {
            background: rgba(30, 41, 59, 0.6); border-radius: 12px; border-left: 4px solid #3b82f6; padding: 15px 20px;
        }
    </style>
</head>
<body>
    <button class="theme-toggle" onclick="AlgorithmVisualizer.toggleTheme()" title="ÂàáÊèõ‰∏ªÈ°å">üåì</button>
    <div class="main-layout">
        <div class="canvas-area">
            <div class="viz-card">
                <div class="viz-title">Kth Largest Element (QuickSelect)</div>
                <div class="custom-input-section">
                    <div class="input-row">
                        <label>Êï∏ÁµÑ (CSV):</label>
                        <input type="text" id="arrInput" value="3,2,1,5,6,4">
                        <label>K:</label>
                        <input type="number" id="kInput" value="2" style="width:50px">
                        <button onclick="runVisualizer()">Âü∑Ë°å</button>
                    </div>
                </div>

                <div class="visualization-area">
                    <div class="stats-panel">
                        <div class="stat-item"><div class="stat-val" id="targetK">2</div><div class="stat-label">K</div></div>
                        <div class="stat-item"><div class="stat-val" id="targetIdx">4</div><div class="stat-label">Target Index (N-K)</div></div>
                        <div class="stat-item"><div class="stat-val" id="rangeDisplay">[0, 5]</div><div class="stat-label">Current Range</div></div>
                    </div>
                    
                    <div class="array-container" id="arrayDisplay"></div>
                </div>

                <div class="step-breakdown">
                    <div style="font-size:0.75rem; font-weight:bold; color:#64748b;">Áï∂ÂâçÊ≠•È©ü</div>
                    <div id="stepText" style="font-size:0.95rem; font-family:monospace; color:#e2e8f0;">Ready.</div>
                </div>

                <div class="controls" style="margin-top: 15px;">
                    <button class="viz-btn" id="prevBtn">‚Üê ‰∏ä‰∏ÄÊ≠•</button>
                    <div class="step-indicator">Ê≠•È©ü <span id="currentStep">0</span> / <span id="totalSteps">0</span></div>
                    <button class="viz-btn primary" id="nextBtn">‰∏ã‰∏ÄÊ≠• ‚Üí</button>
                    <button class="viz-btn" onclick="runVisualizer()">‚Üª ÈáçÁΩÆ</button>
                    <button class="viz-btn play-btn" id="playBtn" onclick="viz.toggleAutoPlay()">‚ñ∂ Ëá™ÂãïÊí≠Êîæ</button>
                    <div class="speed-control">
                        <label>ÈÄüÂ∫¶:</label>
                        <select id="speedSelect" onchange="viz.setSpeed(Number(this.value))">
                            <option value="1500">0.5x</option>
                            <option value="1000" selected>1x</option>
                            <option value="500">1.5x</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="viz-card"><div class="viz-title">ÈÇèËºØËß£Èáã</div><div class="explanation" id="explanation"></div></div>
        </div>
        <div class="code-area">
            <div class="viz-card" style="height: 100%;">
                <div class="viz-title">C++ Code</div>
                <div class="code-panel" id="codeDisplay"></div>
            </div>
        </div>
    </div>

    <script src="../assets/visualizer/core.js"></script>
    <script>
        const codeStructure = [
            { line: 'int quickSelect(nums, k) {', id: 0 },
            { line: '    int p = partition(nums, l, r);', id: 1 },
            { line: '    if (p > k) return quickSelect(l, p - 1);', id: 2 },
            { line: '    else if (p < k) return quickSelect(p + 1, r);', id: 3 },
            { line: '    else return nums[p];', id: 4 },
            { line: '}', id: 5 },
            { line: 'int partition(nums, l, r) {', id: 6 },
            { line: '    int pivot = nums[r], p = l;', id: 7 },
            { line: '    for (int i = l; i < r; i++) {', id: 8 },
            { line: '        if (nums[i] <= pivot) {', id: 9 },
            { line: '            swap(nums[i], nums[p]);', id: 10 },
            { line: '            p++;', id: 11 },
            { line: '        }', id: 12 },
            { line: '    }', id: 13 },
            { line: '    swap(nums[p], nums[r]);', id: 14 },
            { line: '    return p;', id: 15 },
            { line: '}', id: 16 }
        ];

        let viz;

        function simulate(numsInput, k) {
            const steps = [];
            const nums = [...numsInput];
            // Problem: Find Kth Largest. This corresponds to index N - K in sorted array.
            const targetIndex = nums.length - k; 
            
            steps.push({
                nums: [...nums],
                left: 0, right: nums.length - 1,
                targetIndex: targetIndex,
                msg: `Â∞ãÊâæÁ¨¨ ${k} Â§ßÂÖÉÁ¥† (ÊéíÂ∫èÂæåÁ¥¢Âºï ${targetIndex})`,
                highlightLines: [0]
            });

            const swap = (i, j) => [nums[i], nums[j]] = [nums[j], nums[i]];

            function quickSelect(l, r) {
                if (l > r) return; // Should not happen if k is valid

                steps.push({
                    nums: [...nums], l, r, targetIndex,
                    msg: `Partition ÁØÑÂúç [${l}, ${r}]`,
                    highlightLines: [1]
                });

                const pivot = nums[r];
                let p = l;
                
                steps.push({
                    nums: [...nums], l, r, pivotIdx: r, p, i: l, targetIndex,
                    msg: `ÈÅ∏Êìá Pivot: ${pivot} (Index ${r}), ÂàùÂßã p = ${l}`,
                    highlightLines: [7]
                });

                for (let i = l; i < r; i++) {
                    steps.push({
                        nums: [...nums], l, r, pivotIdx: r, p, i, targetIndex,
                        msg: `ÊØîËºÉ nums[${i}] (${nums[i]}) <= Pivot (${pivot})?`,
                        highlightLines: [8]
                    });

                    if (nums[i] <= pivot) {
                        swap(i, p);
                        steps.push({
                            nums: [...nums], l, r, pivotIdx: r, p, i, targetIndex,
                            msg: `‰∫§Êèõ nums[${i}] Ëàá nums[${p}] (Â∞èÊñºÁ≠âÊñº Pivot)`,
                            highlightLines: [9, 10]
                        });
                        p++;
                    }
                }

                swap(p, r);
                steps.push({
                    nums: [...nums], l, r, pivotIdx: p, p: null, i: null, targetIndex,
                    msg: `Â∞á Pivot ÁßªËá≥Ê≠£Á¢∫‰ΩçÁΩÆ ${p}`,
                    highlightLines: [14, 15]
                });

                if (p > targetIndex) {
                    steps.push({
                        nums: [...nums], l, r, pivotIdx: p, targetIndex,
                        msg: `Pivot Index ${p} > Target ${targetIndex}, ÂêëÂ∑¶Â∞ãÊâæ`,
                        highlightLines: [2]
                    });
                    quickSelect(l, p - 1);
                } else if (p < targetIndex) {
                    steps.push({
                        nums: [...nums], l, r, pivotIdx: p, targetIndex,
                        msg: `Pivot Index ${p} < Target ${targetIndex}, ÂêëÂè≥Â∞ãÊâæ`,
                        highlightLines: [3]
                    });
                    quickSelect(p + 1, r);
                } else {
                    steps.push({
                        nums: [...nums], l, r, pivotIdx: p, found: true, targetIndex,
                        msg: `Pivot Index ${p} == TargetÔºÅÊâæÂà∞Á≠îÊ°à: ${nums[p]}`,
                        highlightLines: [4],
                        final: true
                    });
                }
            }

            quickSelect(0, nums.length - 1);
            return steps;
        }

        function render(step) {
            document.getElementById('stepText').textContent = step.msg;
            document.getElementById('targetK').textContent = document.getElementById('kInput').value;
            document.getElementById('targetIdx').textContent = step.targetIndex;
            document.getElementById('rangeDisplay').textContent = step.l !== undefined ? `[${step.l}, ${step.r}]` : '-';

            const container = document.getElementById('arrayDisplay');
            container.innerHTML = '';
            
            // Find max for height scaling
            const maxVal = Math.max(...step.nums, 1);
            const heightScale = 150 / maxVal;

            step.nums.forEach((val, i) => {
                const group = document.createElement('div');
                let cls = 'bar-group';
                
                // Dim logic: outside current L, R range?
                if (step.l !== undefined && (i < step.l || i > step.r)) {
                    cls += ' dimmed';
                }
                
                // Color logic
                if (step.pivotIdx === i) cls += ' pivot';
                if (step.found && i === step.pivotIdx) cls += ' found';
                // During partition
                if (step.pivotIdx !== undefined && step.p !== undefined && step.i !== undefined) {
                    // Left of P is <= pivot (excluding pivot itself which is at r)
                    if (i >= step.l && i < step.p) cls += ' less';
                    // Between P and I is > pivot
                    if (i >= step.p && i < step.i) cls += ' greater';
                }

                group.className = cls;
                
                // Bar
                const bar = document.createElement('div');
                bar.className = 'bar';
                bar.style.height = `${Math.max(val * heightScale, 30)}px`;
                bar.textContent = val;
                
                // Index
                const idx = document.createElement('div');
                idx.className = 'idx-label';
                idx.textContent = i;
                
                group.appendChild(bar);
                group.appendChild(idx);

                // Pointers
                if (step.p === i) {
                    const ptr = document.createElement('div');
                    ptr.className = 'pointer pointer-p';
                    ptr.textContent = 'P';
                    group.appendChild(ptr);
                }
                if (step.i === i) {
                    const ptr = document.createElement('div');
                    ptr.className = 'pointer scan';
                    ptr.textContent = 'i';
                    group.appendChild(ptr);
                }

                container.appendChild(group);
            });
        }

        function runVisualizer() {
            const arrStr = document.getElementById('arrInput').value;
            const k = parseInt(document.getElementById('kInput').value);
            const nums = arrStr.split(',').map(x=>parseInt(x.trim())).filter(x=>!isNaN(x));
            
            if(nums.length === 0 || isNaN(k) || k < 1 || k > nums.length) return alert('Ëº∏ÂÖ•ÁÑ°Êïà');

            viz = new AlgorithmVisualizer({
                codeLines: codeStructure,
                onStepChange: render
            });
            viz.setSteps(simulate(nums, k));
        }

        window.addEventListener('load', runVisualizer);
    </script>
</body>
</html>
