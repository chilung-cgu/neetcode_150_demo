<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kth Largest Element in Stream - è¦–è¦ºåŒ–</title>
    <link rel="stylesheet" href="../assets/visualizer/style.css">
    <style>
        .heap { display: flex; flex-direction: column; align-items: center; margin: 20px 0; min-height: 120px; }
        .heap-level { display: flex; gap: 10px; margin: 5px 0; justify-content: center; }
        .heap-node { width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; font-weight: bold; border-radius: 50%; background: var(--viz-primary); color: white; font-size: 1.1rem; transition: all 0.3s; }
        .heap-node.root { background: var(--viz-success); color: #0f172a; }
        .heap-node.new { animation: popIn 0.5s; border: 3px solid var(--viz-warning); }
        .heap-node.pop { opacity: 0.5; transform: scale(0.8); background: var(--viz-error); }
        @keyframes popIn { 0% { transform: scale(0); } 70% { transform: scale(1.2); } 100% { transform: scale(1); } }
        
        .stream { display: flex; gap: 8px; justify-content: center; margin: 15px 0; flex-wrap: wrap; }
        .stream-item { padding: 8px 15px; background: var(--viz-bg-secondary); border-radius: 6px; font-weight: bold; font-family: monospace; }
        .stream-item.added { background: var(--viz-warning); color: #0f172a; }
        
        .custom-input-section { background: var(--viz-card-bg); border-radius: 8px; padding: 15px; margin-bottom: 15px; border: 1px solid var(--viz-border); }
        .input-title { font-weight: bold; margin-bottom: 10px; color: var(--viz-text); }
        .input-row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-bottom: 8px; }
        .input-row input { padding: 8px 12px; border-radius: 6px; border: 1px solid var(--viz-border); background: var(--viz-input-bg); color: var(--viz-text); font-family: monospace; }
        .input-row button { padding: 8px 16px; border-radius: 6px; background: var(--viz-primary); color: white; border: none; cursor: pointer; }
    </style>
</head>
<body>
    <button class="theme-toggle" onclick="AlgorithmVisualizer.toggleTheme()" title="åˆ‡æ›ä¸»é¡Œ">ğŸŒ“</button>
    <div class="main-layout">
        <div class="canvas-area">
            <div class="viz-card">
                <div class="viz-title">æ•¸æ“šæµä¸­ç¬¬ K å¤§å…ƒç´ ï¼ˆMIN HEAPï¼‰</div>
                <div class="custom-input-section">
                    <div class="input-title">ğŸ® è‡ªè¨‚æ¸¬è©¦</div>
                    <div class="input-row">
                        <label>åˆå§‹æµ:</label>
                        <input type="text" id="initialStream" value="4, 5, 8, 2" style="width: 150px;">
                        <label>K:</label>
                        <input type="number" id="kValue" value="3" style="width: 50px;" min="1">
                        <button onclick="resetWithCustom()">é‡ç½®</button>
                    </div>
                    <div class="input-row">
                        <label>Add:</label>
                        <input type="number" id="addValue" value="3" style="width: 60px;">
                        <button onclick="addSingleValue()">åŠ å…¥</button>
                    </div>
                </div>
                
                <div style="text-align: center; color: var(--text-muted); margin-top: 10px;">Min Heap (Size â‰¤ K)</div>
                <div class="heap" id="heapDisplay"></div>
                
                <div style="text-align: center; color: var(--text-muted);">æ­·å²æ•¸æ“šæµ</div>
                <div class="stream" id="streamDisplay"></div>
                
                <div class="controls" style="margin-top: 15px;">
                    <button class="viz-btn" id="prevBtn">â† ä¸Šä¸€æ­¥</button>
                    <div class="step-indicator">æ­¥é©Ÿ <span id="currentStep">0</span> / <span id="totalSteps">0</span></div>
                    <button class="viz-btn primary" id="nextBtn">ä¸‹ä¸€æ­¥ â†’</button>
                    <button class="viz-btn" onclick="resetVisualization()">â†» é‡ç½®</button>
                    <button class="viz-btn play-btn" id="playBtn" onclick="viz.toggleAutoPlay()">â–¶ è‡ªå‹•æ’­æ”¾</button>
                    <div class="speed-control">
                        <label>é€Ÿåº¦:</label>
                        <select id="speedSelect" onchange="viz.setSpeed(Number(this.value))">
                            <option value="2000">0.5x</option>
                            <option value="1500" selected>1x</option>
                            <option value="1000">1.5x</option>
                            <option value="500">2x</option>
                        </select>
                    </div>
                </div>
                
                <div class="complexity-badge">
                    <span class="label">Time:</span> O(log k) add
                    <span class="label" style="margin-left: 12px;">Space:</span> O(k)
                </div>
                
                <div class="state-grid">
                    <div class="state-item"><div class="state-label">K</div><div class="state-value" id="kDisplay">3</div></div>
                    <div class="state-item"><div class="state-label">ç¬¬ K å¤§</div><div class="state-value" id="kthDisplay" style="color: var(--viz-success);">?</div></div>
                </div>
                <div class="legend">
                    <div class="legend-item"><div class="legend-color root"></div>å †é ‚ (ç¬¬ K å¤§)</div>
                    <div class="legend-item"><div class="legend-color new"></div>æ–°åŠ å…¥</div>
                    <div class="legend-item"><div class="legend-color pop"></div>ç§»é™¤</div>
                </div>
            </div>
            <div class="viz-card"><div class="viz-title">æ¼”ç®—æ³•èªªæ˜</div><div class="explanation" id="explanation"></div></div>
        </div>
        <div class="code-area">
            <div class="viz-card" style="height: 100%;">
                <div class="viz-title">æ¼”ç®—æ³• (C++)</div>
                <div class="code-panel" id="codeDisplay"></div>
            </div>
        </div>
    </div>
    <script src="../assets/visualizer/core.js"></script>
    <script>
        const codeStructure = [
            { line: 'class KthLargest {', id: 0 },
            { line: '    priority_queue<int, vector<int>, greater<int>> minHeap;', id: 1 },
            { line: '    int k;', id: 2 },
            { line: 'public:', id: 3 },
            { line: '    KthLargest(int k, vector<int>& nums) : k(k) {', id: 4 },
            { line: '        for (int n : nums) add(n);', id: 5 },
            { line: '    }', id: 6 },
            { line: '    int add(int val) {', id: 7 },
            { line: '        minHeap.push(val);', id: 8 },
            { line: '        if (minHeap.size() > k) minHeap.pop();', id: 9 },
            { line: '        return minHeap.top(); // ç¬¬ k å¤§', id: 10 },
            { line: '    }', id: 11 },
            { line: '};', id: 12 },
        ];

        let currentK = 3;
        let currentStream = [4, 5, 8, 2];
        let addedValues = [];

        function parseStream(input) {
            return input.split(',').map(x => parseInt(x.trim())).filter(x => !isNaN(x));
        }

        // Min Heap Implementation
        class MinHeap {
            constructor() { this.heap = []; }
            push(val) {
                this.heap.push(val);
                this.bubbleUp(this.heap.length - 1);
            }
            pop() {
                if (this.heap.length === 0) return null;
                const min = this.heap[0];
                const last = this.heap.pop();
                if (this.heap.length > 0) {
                    this.heap[0] = last;
                    this.bubbleDown(0);
                }
                return min;
            }
            peek() { return this.heap[0]; }
            size() { return this.heap.length; }
            bubbleUp(idx) {
                while (idx > 0) {
                    let pIdx = Math.floor((idx - 1) / 2);
                    if (this.heap[idx] >= this.heap[pIdx]) break;
                    [this.heap[idx], this.heap[pIdx]] = [this.heap[pIdx], this.heap[idx]];
                    idx = pIdx;
                }
            }
            bubbleDown(idx) {
                while (true) {
                    let left = 2 * idx + 1, right = 2 * idx + 2, swap = idx;
                    if (left < this.heap.length && this.heap[left] < this.heap[swap]) swap = left;
                    if (right < this.heap.length && this.heap[right] < this.heap[swap]) swap = right;
                    if (swap === idx) break;
                    [this.heap[idx], this.heap[swap]] = [this.heap[swap], this.heap[idx]];
                    idx = swap;
                }
            }
        }

        function generateAlgorithmSteps(k, initialNums, adds) {
            const steps = [];
            const mh = new MinHeap();
            const fullStream = [...initialNums];
            
            steps.push({
                heap: [],
                stream: [...initialNums],
                k: k,
                kth: null,
                highlightLines: [0, 1, 2, 4],
                explanation: {
                    title: 'åˆå§‹åŒ–',
                    text: `K = ${k}<br>åˆå§‹æ•¸æ“šæµ: [${initialNums.join(', ')}]<br>æº–å‚™å»ºç«‹ Min Heap`,
                    formula: 'priority_queue<int, vector<int>, greater<int>> minHeap'
                }
            });

            // Process initial stream
            for (const n of initialNums) {
                mh.push(n);
                const popped = mh.size() > k ? mh.pop() : null;
                
                steps.push({
                    heap: [...mh.heap],
                    stream: [...initialNums],
                    addedVal: n,
                    poppedVal: popped,
                    k: k,
                    kth: mh.size() === k ? mh.peek() : null,
                    highlightLines: [5, 8, 9],
                    explanation: {
                        title: `åˆå§‹åŒ–: åŠ å…¥ ${n}`,
                        text: `åŠ å…¥ ${n}${popped !== null ? `ï¼ŒHeap å¤§å° > Kï¼Œç§»é™¤æœ€å°å…ƒç´  ${popped}` : ''}<br>ç›®å‰å †é ‚(ç¬¬ ${k} å¤§): ${mh.size() === k ? mh.peek() : 'ä¸è¶³ K å€‹'}`,
                        formula: `minHeap.push(${n})` + (popped ? `; minHeap.pop()` : '')
                    }
                });
            }

            // Process added values
            for (const val of adds) {
                fullStream.push(val);
                mh.push(val);
                const popped = mh.size() > k ? mh.pop() : null;
                const kth = mh.peek();

                steps.push({
                    heap: [...mh.heap],
                    stream: [...fullStream],
                    addedVal: val,
                    poppedVal: popped,
                    k: k,
                    kth: kth,
                    highlightLines: [7, 8, 9, 10],
                    explanation: {
                        title: `Add(${val})`,
                        text: `åŠ å…¥ ${val}${popped !== null ? `ï¼ŒHeap > Kï¼Œç§»é™¤ ${popped}` : ''}<br>æ›´æ–°å¾Œå †é ‚ = ${kth} (å³ç¬¬ ${k} å¤§)`,
                        formula: `return ${kth}`
                    }
                });
            }

            return steps;
        }

        function resetWithCustom() {
            const streamStr = document.getElementById('initialStream').value;
            const kVal = parseInt(document.getElementById('kValue').value);
            if (isNaN(kVal) || kVal < 1) { alert('K å¿…é ˆ >= 1'); return; }
            
            currentStream = parseStream(streamStr);
            currentK = kVal;
            addedValues = [];
            init();
        }

        function addSingleValue() {
            const val = parseInt(document.getElementById('addValue').value);
            if (isNaN(val)) return;
            addedValues.push(val);
            init(); // Re-run visually with new history
        }

        let viz;
        function init() {
            viz = new AlgorithmVisualizer({
                codeLines: codeStructure,
                onStepChange: (step) => {
                    document.getElementById('kDisplay').textContent = step.k;
                    document.getElementById('kthDisplay').textContent = step.kth !== null ? step.kth : '-';
                    
                    // Render Heap
                    let heapHtml = '';
                    const heap = step.heap || [];
                    if (heap.length === 0) heapHtml = '<div style="color:var(--text-muted)">ç©º</div>';
                    else {
                        // Simple level rendering logic
                        let idx = 0;
                        let levelSize = 1;
                        while (idx < heap.length) {
                            heapHtml += '<div class="heap-level">';
                            for (let i = 0; i < levelSize && idx < heap.length; i++) {
                                const val = heap[idx];
                                let cls = 'heap-node';
                                if (idx === 0) cls += ' root';
                                if (val === step.addedVal && step.poppedVal === undefined) cls += ' new'; 
                                heapHtml += `<div class="${cls}">${val}</div>`;
                                idx++;
                            }
                            heapHtml += '</div>';
                            levelSize *= 2;
                        }
                    }
                    document.getElementById('heapDisplay').innerHTML = heapHtml;
                    
                    // Render Stream
                    document.getElementById('streamDisplay').innerHTML = (step.stream || []).map(n => {
                        let cls = 'stream-item';
                        if (n === step.addedVal) cls += ' added';
                        return `<span class="${cls}">${n}</span>`;
                    }).join('');
                }
            });
            viz.setSteps(generateAlgorithmSteps(currentK, currentStream, addedValues));
        }
        function resetVisualization() { 
            addedValues = [];
            init(); 
        }
        window.addEventListener('load', init);
    </script>
</body>
</html>
