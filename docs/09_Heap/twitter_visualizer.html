<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Design Twitter (Merge K Lists) - Á≤æÁ∑ªË¶ñË¶∫Âåñ</title>
    <link rel="stylesheet" href="../assets/visualizer/style.css">
    <style>
        .visualization-area {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 50%, #1e293b 100%);
            border-radius: 16px;
            padding: 20px;
            margin: 15px 0;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .dashboard {
            display: flex; gap: 20px; flex-wrap: wrap; justify-content: center;
        }

        /* User Lists Panel */
        .users-panel {
            flex: 1; min-width: 300px;
            background: rgba(30, 41, 59, 0.4); border-radius: 12px; padding: 15px;
            border: 1px solid rgba(148, 163, 184, 0.2);
        }
        .user-row {
            display: flex; align-items: center; gap: 10px; margin-bottom: 12px;
        }
        .user-avatar {
            width: 40px; height: 40px; border-radius: 50%; background: #475569;
            display: flex; align-items: center; justify-content: center; font-weight: bold; color: white;
            border: 2px solid #64748b;
        }
        .tweet-list {
            display: flex; gap: 5px; flex-wrap: wrap; align-items: center;
        }
        .tweet {
            padding: 4px 8px; background: rgba(59, 130, 246, 0.2); border: 1px solid #3b82f6;
            border-radius: 4px; font-size: 0.8rem; color: #93c5fd;
            transition: all 0.3s;
        }
        .tweet.active { background: #fbbf24; color: #0f172a; transform: scale(1.1); }
        .tweet.picked { opacity: 0.5; text-decoration: line-through; }

        /* Heap Panel */
        .heap-panel {
            width: 250px;
            background: rgba(15, 23, 42, 0.5); border-radius: 12px; padding: 10px;
            display: flex; flex-direction: column; align-items: center;
        }
        #heap-svg { width: 100%; height: 200px; }
        
        .node-rect { fill: #3b82f6; stroke: none; rx: 4; }
        .node-rect.max { fill: #ef4444; }
        .node-text { fill: white; font-size: 10px; text-anchor: middle; dominant-baseline: middle; pointer-events: none; }

        /* Feed Screen */
        .feed-panel {
            width: 200px; 
            background: #0f172a; border-radius: 12px; padding: 10px; border: 4px solid #334155;
            display: flex; flex-direction: column; gap: 8px; max-height: 400px; overflow-y: auto;
        }
        .feed-item {
            background: #1e293b; padding: 8px; border-radius: 6px; border-left: 3px solid #22c55e;
            font-size: 0.8rem; color: #e2e8f0; animation: slideIn 0.3s;
        }
        @keyframes slideIn { from { transform: translateX(20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* Controls */
        .custom-input-section { background: var(--viz-card-bg); border-radius: 8px; padding: 15px; border: 1px solid var(--viz-border); }
        .input-row { display: flex; gap: 10px; align-items: center; margin-bottom: 5px; }
        .input-row input { padding: 8px; border-radius: 6px; border: 1px solid var(--viz-border); background: var(--viz-input-bg); color: var(--viz-text); font-family: monospace; width: 60px; }
        .input-row button { padding: 8px 16px; border-radius: 6px; background: var(--viz-primary); color: white; border: none; cursor: pointer; }

        .viz-title { margin-bottom: 20px; font-size: 1.2rem; font-weight: bold; color: #e2e8f0; border-left: 4px solid #3b82f6; padding-left: 10px; }
        .section-title { font-size: 0.9rem; color: #94a3b8; font-weight: bold; margin-bottom: 8px; text-align: center; }

        .step-breakdown { background: rgba(30, 41, 59, 0.6); border-radius: 12px; border-left: 4px solid #3b82f6; padding: 15px 20px; margin-top: 15px;}
    </style>
</head>
<body>
    <button class="theme-toggle" onclick="AlgorithmVisualizer.toggleTheme()" title="ÂàáÊèõ‰∏ªÈ°å">üåì</button>
    <div class="main-layout">
        <div class="canvas-area">
            <div class="viz-card">
                <div class="viz-title">Design Twitter (News Feed)</div>
                <div class="custom-input-section">
                    <div class="input-row">
                        <label>User ID:</label>
                        <input type="number" id="uidInput" value="1" min="1" max="3">
                        <label>Post:</label>
                        <input type="text" id="tweetInput" value="Hello" style="width:100px">
                        <button onclick="handlePost()">ÁôºÂ∏É (Post)</button>
                        <button onclick="handleGetFeed()" style="background:#22c55e;">Áç≤Âèñ Feed</button>
                    </div>
                </div>

                <div class="visualization-area">
                    <div class="dashboard">
                        <div class="users-panel" id="usersPanel">
                            <div class="section-title">Users & Tweets (Sorted by Time)</div>
                            <!-- Rendered by JS -->
                        </div>
                        
                        <div class="heap-panel">
                            <div class="section-title">Max Heap (Sorted by Time)</div>
                            <svg id="heap-svg"><g id="heap-g"></g></svg>
                        </div>
                        
                        <div class="feed-panel" id="feedPanel">
                            <div class="section-title">News Feed</div>
                            <!-- Feed Items -->
                        </div>
                    </div>
                </div>

                <div class="step-breakdown">
                    <div style="font-size:0.75rem; font-weight:bold; color:#64748b;">Áï∂ÂâçÊ≠•È©ü</div>
                    <div id="stepText" style="font-size:0.95rem; font-family:monospace; color:#e2e8f0;">Ready.</div>
                </div>

                <div class="controls" style="margin-top: 15px;">
                    <button class="viz-btn" id="prevBtn">‚Üê ‰∏ä‰∏ÄÊ≠•</button>
                    <div class="step-indicator">Ê≠•È©ü <span id="currentStep">0</span> / <span id="totalSteps">0</span></div>
                    <button class="viz-btn primary" id="nextBtn">‰∏ã‰∏ÄÊ≠• ‚Üí</button>
                    <button class="viz-btn" onclick="runSimulation()">‚Üª ÈáçÊºî Feed</button>
                    <button class="viz-btn play-btn" id="playBtn" onclick="viz.toggleAutoPlay()">‚ñ∂ Ëá™ÂãïÊí≠Êîæ</button>
                    <div class="speed-control">
                        <label>ÈÄüÂ∫¶:</label>
                        <select id="speedSelect" onchange="viz.setSpeed(Number(this.value))">
                            <option value="1500">0.5x</option>
                            <option value="800" selected>1x</option>
                            <option value="300">1.5x</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="viz-card"><div class="viz-title">ÈÇèËºØËß£Èáã</div><div class="explanation" id="explanation"></div></div>
        </div>
        <div class="code-area">
            <div class="viz-card" style="height: 100%;">
                <div class="viz-title">C++ Code</div>
                <div class="code-panel" id="codeDisplay"></div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="../assets/visualizer/core.js"></script>
    <script>
        const codeStructure = [
            { line: 'vector<int> getNewsFeed(userId) {', id: 0 },
            { line: '    priority_queue<Tweet> maxHeap;', id: 1 },
            { line: '    for (int followeeId : following[userId]) {', id: 2 },
            { line: '        if (!tweets[followeeId].empty())', id: 3 },
            { line: '            maxHeap.push(tweets[followeeId].back());', id: 4 },
            { line: '    }', id: 5 },
            { line: '    vector<int> feed;', id: 6 },
            { line: '    while (!maxHeap.empty() && feed.size() < 10) {', id: 7 },
            { line: '        Tweet t = maxHeap.top(); maxHeap.pop();', id: 8 },
            { line: '        feed.push_back(t.id);', id: 9 },
            { line: '        if (t.prevIndex >= 0) {', id: 10 },
            { line: '            maxHeap.push(tweets[t.uid][t.prevIndex]);', id: 11 },
            { line: '        }', id: 12 },
            { line: '    }', id: 13 },
            { line: '    return feed;', id: 14 },
            { line: '}', id: 15 }
        ];

        let viz;
        let globalTime = 0;
        // Data structure
        const users = {
            1: { id:1, tweets:[], following: new Set([1, 2, 3]) }, // Assume following all for demo
            2: { id:2, tweets:[], following: new Set() },
            3: { id:3, tweets:[], following: new Set() }
        };

        // Initialize with some data
        function initData() {
            addTweet(1, "Post 1");
            addTweet(2, "Post 2");
            addTweet(3, "Post 3");
            addTweet(1, "Post 4");
            addTweet(2, "Post 5");
        }

        function addTweet(uid, text) {
            globalTime++;
            if(!users[uid]) users[uid] = {id:uid, tweets:[], following:new Set([uid])};
            users[uid].tweets.push({ id: globalTime, text, time: globalTime, uid });
        }

        function handlePost() {
            const uid = parseInt(document.getElementById('uidInput').value);
            const text = document.getElementById('tweetInput').value;
            if(!users[uid]) { alert("User not exist"); return; }
            addTweet(uid, text || `Post ${globalTime+1}`);
            renderStatic(); // update UI immediately
        }

        function renderStatic() {
            const container = document.getElementById('usersPanel');
            // Assuming container has title, remove users
            // Simpler: clear and append
            let html = '<div class="section-title">Users & Tweets (Sorted by Time)</div>';
            
            Object.values(users).forEach(u => {
                html += `
                    <div class="user-row">
                        <div class="user-avatar" style="background:${u.id===1?'#3b82f6':u.id===2?'#a855f7':'#22c55e'}">U${u.id}</div>
                        <div class="tweet-list">
                            ${u.tweets.map(t => `<div class="tweet" id="t-${t.id}">T${t.time}</div>`).join('')}
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function handleGetFeed() {
            runSimulation();
            viz.startAutoPlay();
        }

        function generateFeedSteps(userId) {
            const steps = [];
            
            // Build Heap from followers
            let heap = [];
            // followers: assume user 1 follows 1, 2, 3
            const followees = [1, 2, 3];
            
            steps.push({
                users: JSON.parse(JSON.stringify(users)),
                heap: [], feed: [],
                msg: `‰ΩøÁî®ËÄÖ 1 Áç≤Âèñ Feed: Ê™¢Êü•ÈóúÊ≥®Â∞çË±° ${followees.join(', ')}`,
                highlightLines: [2]
            });

            for(let fid of followees) {
                 const u = users[fid];
                 if(u && u.tweets.length > 0) {
                     const lastTweet = u.tweets[u.tweets.length-1];
                     // Store { tweet, index }
                     heap.push({ ...lastTweet, idx: u.tweets.length-1 });
                     
                     steps.push({
                         users: JSON.parse(JSON.stringify(users)),
                         heap: JSON.parse(JSON.stringify(heap)), feed: [],
                         activeT: lastTweet.id,
                         msg: `Â∞á U${fid} ÊúÄÊñ∞Êé®Êñá T${lastTweet.time} Âä†ÂÖ• Heap`,
                         highlightLines: [3, 4]
                     });
                 }
            }
            // Sort heap (max time)
            heap.sort((a,b) => b.time - a.time);

            while(heap.length > 0 && steps[steps.length-1].feed.length < 10) { // Should use feed.length from last step? No, local var
                const feed = (steps.length > 0 && steps[steps.length-1].feed) ? [...steps[steps.length-1].feed] : [];
                if(feed.length >= 10) break;

                // Pop Max
                const top = heap.shift();
                feed.push(top);
                
                steps.push({
                    users: JSON.parse(JSON.stringify(users)),
                    heap: JSON.parse(JSON.stringify(heap)), feed: [...feed],
                    activeT: top.id, // for highlighting in list
                    msg: `Âæû Heap ÂèñÂá∫ÊúÄÊñ∞ T${top.time} (U${top.uid}) Âä†ÂÖ• Feed`,
                    highlightLines: [8, 9]
                });

                // Push next
                if (top.idx > 0) {
                    const nextIdx = top.idx - 1;
                    const nextTweet = users[top.uid].tweets[nextIdx];
                    heap.push({ ...nextTweet, idx: nextIdx });
                    heap.sort((a,b) => b.time - a.time); // re-heapify
                    
                    steps.push({
                        users: JSON.parse(JSON.stringify(users)),
                        heap: JSON.parse(JSON.stringify(heap)), feed: [...feed],
                        activeT: nextTweet.id,
                        msg: `Â∞á U${top.uid} ÁöÑ‰∏ä‰∏ÄÊ¢ùÊé®Êñá T${nextTweet.time} Âä†ÂÖ• Heap`,
                        highlightLines: [11]
                    });
                } else {
                     steps.push({
                        users: JSON.parse(JSON.stringify(users)),
                        heap: JSON.parse(JSON.stringify(heap)), feed: [...feed],
                        msg: `U${top.uid} ÁÑ°Êõ¥Â§öÊé®Êñá`,
                        highlightLines: [10]
                    });
                }
            }
            
             steps.push({
                users: JSON.parse(JSON.stringify(users)),
                heap: [], feed: (steps.length>0?steps[steps.length-1].feed:[]),
                msg: "Feed ÁîüÊàêÂÆåÁï¢",
                highlightLines: [14],
                final: true
            });

            return steps;
        }

        // --- Render ---
        const gHeap = d3.select("#heap-g");

        function render(step) {
            document.getElementById('stepText').textContent = step.msg;
            
            // Highlight Tweets in User Lists
            document.querySelectorAll('.tweet').forEach(el => {
                el.classList.remove('active');
                el.classList.remove('picked');
            });
            
            if (step.activeT) {
                const el = document.getElementById(`t-${step.activeT}`);
                if(el) el.classList.add('active');
            }
            if (step.feed) {
                step.feed.forEach(t => {
                   const el = document.getElementById(`t-${t.id}`);
                   if(el) el.classList.add('picked');
                });
            }

            // Render Feed
            const fd = document.getElementById('feedPanel');
            fd.innerHTML = '<div class="section-title">News Feed</div>' + 
                (step.feed||[]).map(t => `<div class="feed-item"><strong>U${t.uid}</strong>: T${t.time}</div>`).join('');

            // Render Heap (D3)
            if(!step.heap || step.heap.length === 0) {
                gHeap.selectAll("*").remove();
                return;
            }
            
            const stratify = (idx) => {
                if(idx >= step.heap.length) return null;
                const node = { id: idx, val: step.heap[idx], children: [] };
                const l = stratify(2*idx+1);
                const r = stratify(2*idx+2);
                if(l) node.children.push(l);
                if(r) node.children.push(r);
                return node;
            };
            const root = d3.hierarchy(stratify(0));
            const treeLayout = d3.tree().size([200, 150]);
            treeLayout(root);

            gHeap.attr("transform", "translate(25, 20)");

            const links = gHeap.selectAll(".link").data(root.links());
            links.enter().append("path").attr("class", "link")
                .merge(links).attr("d", d3.linkVertical().x(d=>d.x).y(d=>d.y))
                .style("stroke", "#64748b").style("fill", "none");
            links.exit().remove();

            const nodes = gHeap.selectAll(".node").data(root.descendants());
            const nEnter = nodes.enter().append("g").attr("class", "node");
            nEnter.append("rect").attr("width", 40).attr("height", 24).attr("x", -20).attr("y", -12).attr("class", "node-rect");
            nEnter.append("text").attr("class", "node-text").attr("dy", 1);
            
            const nUpdate = nodes.merge(nEnter).attr("transform", d=>`translate(${d.x},${d.y})`);
            nUpdate.select("rect").attr("class", d => d.data.id === 0 ? "node-rect max" : "node-rect");
            nUpdate.select("text").text(d => `T${d.data.val.time}`);
            
            nodes.exit().remove();
        }

        function runSimulation() {
            const steps = generateFeedSteps(1); // User 1
            viz = new AlgorithmVisualizer({
                codeLines: codeStructure,
                onStepChange: render
            });
            viz.setSteps(steps);
        }

        window.addEventListener('load', () => {
            initData();
            renderStatic();
            runSimulation();  
        });
    </script>
</body>
</html>
