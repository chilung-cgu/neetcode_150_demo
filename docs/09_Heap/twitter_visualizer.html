<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Design Twitter - D3 Dynamic Viz</title>
    <link rel="stylesheet" href="../assets/visualizer/style.css">
    <style>
        .visualization-area {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 50%, #1e293b 100%);
            border-radius: 16px;
            padding: 20px;
            margin: 15px 0;
            display: flex;
            flex-direction: column;
            gap: 20px;
            min-height: 600px;
        }

        .dashboard {
            display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; width: 100%;
        }

        /* Panels */
        .panel {
            background: rgba(30, 41, 59, 0.4); border-radius: 12px; padding: 15px;
            border: 1px solid rgba(148, 163, 184, 0.2); width: 300px;
            display: flex; flex-direction: column; gap: 10px;
        }
        .panel-title { font-size: 0.9rem; color: #94a3b8; font-weight: bold; text-transform: uppercase; text-align: center; border-bottom: 1px solid rgba(148, 163, 184, 0.2); padding-bottom: 8px; letter-spacing: 1px; }

        .user-list { display: flex; flex-direction: column; gap: 8px; max-height: 250px; overflow-y: auto; }
        .user-row {
            display: flex; align-items: start; gap: 10px; padding: 8px;
            background: rgba(59, 130, 246, 0.1); border-radius: 8px;
        }
        .avatar {
            width: 32px; height: 32px; background: #3b82f6; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 0.8rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .tweets-preview { flex: 1; display: flex; flex-wrap: wrap; gap: 4px; }
        .mini-tweet {
            font-size: 0.7rem; padding: 2px 6px; background: rgba(30, 41, 59, 0.8); border: 1px solid #475569; border-radius: 3px; color: #cbd5e1;
            transition: all 0.3s; cursor: default;
        }
        .mini-tweet.active { background: #fbbf24; color: #0f172a; border-color: #fbbf24; transform: scale(1.15); font-weight: bold; z-index: 10; }
        .mini-tweet.picked { opacity: 0.3; text-decoration: line-through; border-color: #22c55e; }

        /* Heap Panel */
        .heap-container { width: 100%; height: 250px; position: relative; overflow: hidden; }
        #heap-svg { width: 100%; height: 100%; cursor: grab; }
        #heap-svg:active { cursor: grabbing; }
        
        .node-circle { fill: #334155; stroke: #64748b; stroke-width: 2px; transition: all 0.3s; }
        .node-circle.max { stroke: #fbbf24; stroke-width: 3px; fill: rgba(251, 191, 36, 0.1); }
        .node-text { fill: white; font-size: 11px; text-anchor: middle; dominant-baseline: middle; pointer-events: none; font-weight: bold; }
        .link { stroke: #475569; stroke-width: 2px; opacity: 0.4; fill: none; }

        /* Feed */
        .feed-container {
            flex: 1; background: #0f172a; border-radius: 8px; padding: 10px;
            display: flex; flex-direction: column; gap: 8px; max-height: 400px; overflow-y: auto; border: 1px solid #334155;
        }
        .feed-item {
            display: flex; gap: 10px; padding: 8px 12px; background: #1e293b; border-radius: 6px; border-left: 4px solid #22c55e;
            align-items: center; animation: slideIn 0.3s ease-out; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .feed-time { font-size: 0.75rem; color: #94a3b8; margin-left: auto; font-family: monospace; }
        @keyframes slideIn { from { transform: translateX(20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* Controls */
        .custom-input-section { background: var(--viz-card-bg); border-radius: 8px; padding: 15px; border: 1px solid var(--viz-border); }
        .input-row { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; justify-content: center; }
        .input-group { display: flex; align-items: center; gap: 5px; }
        .input-group label { font-size: 0.9rem; color: #94a3b8; font-weight: bold; }
        
        input[type=number] { padding: 8px; border-radius: 6px; border: 1px solid var(--viz-border); background: var(--viz-input-bg); color: var(--viz-text); font-family: monospace; width: 60px; text-align: center; }
        button { padding: 8px 18px; border-radius: 6px; background: var(--viz-primary); color: white; border: none; cursor: pointer; font-weight: 600; height: 38px; transition: all 0.2s; }
        button:hover { filter: brightness(1.1); }

        .step-breakdown { background: rgba(30, 41, 59, 0.6); border-radius: 12px; border-left: 4px solid #3b82f6; padding: 15px 20px; width: 100%; box-sizing: border-box; }
        
        .legend { display: flex; gap: 15px; font-size: 0.8rem; color: #cbd5e1; margin-bottom: 10px; justify-content: center; width: 100%; }
        .legend-item { display: flex; align-items: center; gap: 6px; }
        .legend-color { width: 12px; height: 12px; border-radius: 3px; }
    </style>
</head>
<body>
    <button class="theme-toggle" onclick="AlgorithmVisualizer.toggleTheme()" title="ÂàáÊèõ‰∏ªÈ°å">üåì</button>
    <div class="main-layout">
        <div class="canvas-area">
            <div class="viz-card">
                <div class="viz-title">Design Twitter (Merge K Sorted Lists Algorithm)</div>
                <div class="custom-input-section">
                    <div class="input-row">
                        <div class="input-group">
                            <label>User ID:</label>
                            <input type="number" id="uidInput" value="1" min="1" max="3">
                        </div>
                        <div class="input-group">
                            <label>Post ID:</label>
                            <input type="number" id="tidInput" value="101" style="width:70px">
                        </div>
                        <button onclick="doPost()">Post Tweet</button>
                    </div>
                    <div class="input-row" style="margin-top:10px; padding-top:10px; border-top:1px solid #334155;">
                        <div class="input-group">
                            <label>Get Feed for User:</label>
                            <input type="number" id="feedUidInput" value="1" min="1" max="3">
                        </div>
                        <button onclick="doGetFeed()" style="background:#22c55e;">Generate Feed</button>
                        <button onclick="resetViz()" style="background:#ef4444;">Reset</button>
                    </div>
                    <div style="text-align:center; font-size:0.85rem; color:#64748b; margin-top:8px;">User 1 follows User 2 & 3. User 2 & 3 follow nobody.</div>
                </div>

                <div class="visualization-area">
                    <div class="legend">
                       <div class="legend-item"><div class="legend-color" style="background:#fbbf24"></div>Active Tweet</div>
                       <div class="legend-item"><div class="legend-color" style="border:2px solid #22c55e; background:transparent"></div>Added to Feed</div>
                       <div class="legend-item"><div class="legend-color" style="border:2px solid #fbbf24; background:transparent"></div>Heap Root (Max)</div>
                    </div>

                    <div class="dashboard">
                        <div class="panel">
                            <div class="panel-title">User Tweets (Sorted Lists)</div>
                            <div class="user-list" id="usersList"></div>
                        </div>
                        
                        <div class="panel">
                            <div class="panel-title">Max Heap (Merge Logic)</div>
                            <div class="heap-container">
                                <svg id="heap-svg"><g id="heap-g"></g></svg>
                            </div>
                        </div>
                        
                        <div class="panel">
                            <div class="panel-title">News Feed (Top 10)</div>
                            <div class="feed-container" id="feedList"></div>
                        </div>
                    </div>
                </div>

                <div class="step-breakdown">
                    <div style="font-size:0.75rem; font-weight:bold; color:#64748b;">Áï∂ÂâçÊ≠•È©ü</div>
                    <div id="stepText" style="font-size:0.95rem; font-family:monospace; color:#e2e8f0;">Ready.</div>
                </div>

                <div class="controls" style="margin-top: 15px;">
                    <button class="viz-btn" id="prevBtn">‚Üê ‰∏ä‰∏ÄÊ≠•</button>
                    <div class="step-indicator">Ê≠•È©ü <span id="currentStep">0</span> / <span id="totalSteps">0</span></div>
                    <button class="viz-btn primary" id="nextBtn">‰∏ã‰∏ÄÊ≠• ‚Üí</button>
                    <button class="viz-btn play-btn" id="playBtn" onclick="viz.toggleAutoPlay()">‚ñ∂ Ëá™ÂãïÊí≠Êîæ</button>
                    <div class="speed-control">
                        <label>ÈÄüÂ∫¶:</label>
                        <select id="speedSelect" onchange="viz.setSpeed(Number(this.value))">
                            <option value="1500">0.5x</option>
                            <option value="1000" selected>1x</option>
                            <option value="500">2x</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="viz-card logic-card"><div class="viz-title">ÈÇèËºØËß£Èáã</div><div class="explanation" id="explanation"></div></div>
        </div>
        <div class="code-area">
            <div class="viz-card" style="height: 100%;">
                <div class="viz-title">C++ Code</div>
                <div class="code-panel" id="codeDisplay"></div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="../assets/visualizer/core.js"></script>
    <script>
        const codeStructure = [
            { line: 'vector<int> getNewsFeed(userId) {', id: 0 },
            { line: '    priority_queue<Tweet> pq; // Max-Heap by time', id: 1 },
            { line: '    // 1. Push head of tweet list for self + followees', id: 2 },
            { line: '    for (int uid : followees[userId]) {', id: 3 },
            { line: '        if (!tweets[uid].empty())', id: 4 },
            { line: '            pq.push(tweets[uid].back()); // Push newest', id: 5 },
            { line: '    }', id: 6 },
            { line: '    vector<int> feed;', id: 7 },
            { line: '    // 2. Merge K Sorted Lists', id: 8 },
            { line: '    while (!pq.empty() && feed.size() < 10) {', id: 9 },
            { line: '        Tweet t = pq.top(); pq.pop();', id: 10 },
            { line: '        feed.push_back(t.id);', id: 11 },
            { line: '        if (t.next_index >= 0) ', id: 12 },
            { line: '            pq.push(tweets[t.uid][t.next_index]);', id: 13 },
            { line: '    }', id: 14 },
            { line: '    return feed;', id: 15 },
            { line: '}', id: 16 }
        ];

        let viz;
        let globalTime = 0;
        let users = {
            1: { id:1, tweets: [] },
            2: { id:2, tweets: [] },
            3: { id:3, tweets: [] }
        };
        const follows = { 1: [1, 2, 3], 2: [2], 3: [3] };

        function heapToHierarchy(arr) {
            if (arr.length === 0) return null;
            function build(idx) {
                if (idx >= arr.length) return null;
                const node = { ...arr[idx], children: [] };
                const left = build(2 * idx + 1);
                const right = build(2 * idx + 2);
                if (left) node.children.push(left);
                if (right) node.children.push(right);
                return node;
            }
            return build(0);
        }

        function simulateGetFeed(userId) {
            const steps = [];
            const followees = follows[userId] || [userId];
            const pq = []; 
            const feed = [];
            let processedTweets = []; // Array of IDs

            // Initial Push
            followees.forEach(uid => {
                const uTweets = users[uid].tweets;
                if(uTweets.length > 0) {
                    const t = uTweets[uTweets.length - 1]; // Newest
                    pq.push({ ...t, uid, idx: uTweets.length - 1 });
                }
            });
            pq.sort((a,b) => b.time - a.time);

            const pushState = (msg, hl, activeTid=null, info={}) => {
                steps.push({
                    users: JSON.parse(JSON.stringify(users)),
                    pq: JSON.parse(JSON.stringify(pq)),
                    feed: [...feed],
                    processedTweets: [...processedTweets], 
                    activeTid,
                    msg, highlightLines: hl, explanation: info
                });
            };
            
            pushState(`Init Heap with newest tweets`, [3, 4, 5], null, { title: "ÂàùÂßãÂåñ Heap", text: "Â∞áÊâÄÊúâÈóúÊ≥®ËÄÖÊúÄÊñ∞ÁöÑÊé®ÊñáÊîæÂÖ• Max-Heap„ÄÇ", formula: "pq.push(users[i].latest)" });

            while(pq.length > 0 && feed.length < 10) {
                // Pop Max
                const top = pq.shift(); 
                feed.push(top);
                processedTweets.push(top.id);
                
                pushState(`Pop newest: T${top.id} (Time ${top.time})`, [9, 10], top.id, { title: "ÂèñÂá∫ÊúÄÊñ∞", text: `Âæû Heap ÂèñÂá∫ÊôÇÈñìÊúÄÂ§ßÁöÑÊé®Êñá T${top.id} Âä†ÂÖ• Feed„ÄÇ`, formula: "feed.push(pq.pop())" });

                // Push Next
                if (top.idx > 0) {
                    const nextIdx = top.idx - 1;
                    const nextTweet = users[top.uid].tweets[nextIdx];
                    pq.push({ ...nextTweet, uid: top.uid, idx: nextIdx });
                    pq.sort((a,b) => b.time - a.time); 
                    
                    pushState(`Push next from User ${top.uid}: T${nextTweet.id}`, [12, 13], nextTweet.id, { title: "Êé®ÂÖ•‰∏ã‰∏ÄÊ¢ù", text: `Â∞áË©≤Áî®Êà∂ÁöÑ‰∏ã‰∏ÄÊ¢ùËºÉËàäÊé®Êñá T${nextTweet.id} ÊîæÂÖ• Heap„ÄÇ`, formula: "pq.push(next_tweet)" });
                } else {
                    pushState(`User ${top.uid} done.`, [11], null, { title: "ÂàóË°®ËÄóÁõ°", text: `Ë©≤Áî®Êà∂ÁÑ°Êõ¥Â§öÊé®Êñá„ÄÇ`, formula: "empty" });
                }
            }
            
            pushState("Feed Generation Complete", [15], null, { title: "ÂÆåÊàê", text: "Â∑≤ÁîüÊàê Top 10 ÊúÄÊñ∞ÂãïÊÖã„ÄÇ", formula: "return feed" });

            return steps;
        }

        // --- Render ---
        const width = 300, height = 250;
        const svg = d3.select("#heap-svg");
        const gMain = d3.select("#heap-g");
        
        const zoom = d3.zoom().on("zoom", (e) => gMain.attr("transform", e.transform));
        svg.call(zoom);
        svg.call(zoom.transform, d3.zoomIdentity.translate(width/2, 30).scale(0.8));

        const treeLayout = d3.tree().nodeSize([50, 60]);

        function render(step) {
            document.getElementById('stepText').textContent = step.msg;
            if (step.explanation) {
                document.getElementById('explanation').innerHTML = `
                    <div class="expl-title">${step.explanation.title}</div>
                    <div class="expl-text">${step.explanation.text}</div>
                    <div class="expl-formula">${step.explanation.formula}</div>
                `;
            }

            // Users
            const usersList = document.getElementById('usersList');
            usersList.innerHTML = '';
            Object.values(step.users).forEach(u => {
                const row = document.createElement('div');
                row.className = 'user-row';
                
                const avatar = document.createElement('div');
                avatar.className = 'avatar';
                avatar.textContent = u.id;
                
                const preview = document.createElement('div');
                preview.className = 'tweets-preview';
                
                u.tweets.forEach(t => {
                    const mini = document.createElement('div');
                    mini.className = 'mini-tweet';
                    mini.textContent = t.id;
                    if(t.id === step.activeTid) mini.classList.add('active');
                    if(step.processedTweets.includes(t.id)) mini.classList.add('picked');
                    preview.appendChild(mini);
                });
                
                row.appendChild(avatar);
                row.appendChild(preview);
                usersList.appendChild(row);
            });

            // Feed
            const feedList = document.getElementById('feedList');
            feedList.innerHTML = '';
            step.feed.forEach(f => {
                const item = document.createElement('div');
                item.className = 'feed-item';
                item.innerHTML = `<div><b style="color:#3b82f6">U${f.uid}</b>: Tweet ${f.id}</div><div class="feed-time">T=${f.time}</div>`;
                feedList.appendChild(item);
            });

            // Heap Tree
            gMain.selectAll("*").remove();
            if(step.pq.length > 0) {
                const root = d3.hierarchy(heapToHierarchy(step.pq));
                treeLayout(root);

                const links = gMain.selectAll(".link").data(root.links());
                links.enter().append("path").attr("class", "link")
                    .attr("d", d3.linkVertical().x(d => d.x).y(d => d.y));

                const nodes = gMain.selectAll(".node-g").data(root.descendants());
                const nEnter = nodes.enter().append("g").attr("class", "node-g")
                    .attr("transform", d => `translate(${d.x}, ${d.y})`);
                
                nEnter.append("circle").attr("r", 20)
                    .attr("class", d => d.depth === 0 ? "node-circle max" : "node-circle");
                
                nEnter.append("text").attr("class", "node-text").attr("dy", 1)
                    .text(d => `T${d.data.id}`);
                
                // Show Time small below
                nEnter.append("text").attr("class", "node-text").attr("dy", 14).style("font-size", "8px").style("fill", "#fbbf24")
                    .text(d => `t=${d.data.time}`);
            }
        }

        function doPost() {
            const uid = parseInt(document.getElementById('uidInput').value);
            const tid = parseInt(document.getElementById('tidInput').value);
            
            users[uid].tweets.push({ id: tid, time: ++globalTime });
            document.getElementById('tidInput').value = tid + 1;
            
            viz = new AlgorithmVisualizer({ codeLines: codeStructure, onStepChange: render });
            viz.setSteps([{
                users: JSON.parse(JSON.stringify(users)),
                pq: [], feed: [], processedTweets: [], msg: `User ${uid} Posted Tweet ${tid}`, highlightLines:[],
                explanation: { title: "ÁôºÊé®", text: `User ${uid} Áôº‰Ωà‰∫ÜÊñ∞Êé®Êñá T${tid} (Time ${globalTime})`, formula: "tweets[u].push()" }
            }]);
        }

        function doGetFeed() {
            const uid = parseInt(document.getElementById('feedUidInput').value);
            const steps = simulateGetFeed(uid);
            
            viz = new AlgorithmVisualizer({
                codeLines: codeStructure,
                onStepChange: render
            });
            viz.setSteps(steps);
        }

        function resetViz() {
            users = { 1: {id:1, tweets:[]}, 2: {id:2, tweets:[]}, 3: {id:3, tweets:[]} };
            globalTime = 0;
            // Pre-seed
            users[1].tweets.push({id:1, time:++globalTime});
            users[2].tweets.push({id:2, time:++globalTime});
            users[3].tweets.push({id:3, time:++globalTime});
            users[2].tweets.push({id:4, time:++globalTime});
            users[3].tweets.push({id:5, time:++globalTime});
            
            viz = new AlgorithmVisualizer({ codeLines: codeStructure, onStepChange: render });
            viz.setSteps([{ users, pq:[], feed:[], processedTweets:[], msg:"Reset Complete", highlightLines:[], 
                explanation: {title:"ÈáçÁΩÆ", text:"Á≥ªÁµ±Â∑≤ÈáçÁΩÆÔºåÈ†êË®≠ User 1 ÈóúÊ≥® 2 Âíå 3„ÄÇ", formula:"reset()"}}]);
        }

        window.addEventListener('load', resetViz);
    </script>
</body>
</html>
