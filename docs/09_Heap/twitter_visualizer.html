<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Design Twitter è¨­è¨ˆæ¨ç‰¹ - è¦–è¦ºåŒ–</title>
    <link rel="stylesheet" href="../assets/visualizer/style.css">
    <style>
        .twitter-ui { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 15px 0; }
        .user-panel { background: var(--viz-bg-secondary); border-radius: 8px; padding: 12px; }
        .user-panel h4 { color: var(--viz-secondary); margin: 0 0 8px 0; font-size: 0.9rem; }
        .user-tweets { font-size: 0.8rem; color: var(--text-secondary); max-height: 80px; overflow-y: auto; }
        .tweet { background: var(--viz-primary); color: white; padding: 4px 8px; border-radius: 4px; margin: 2px 0; display: inline-block; }
        .tweet.new { background: var(--viz-success); color: #0f172a; animation: fadeIn 0.3s; }
        .followers { font-size: 0.75rem; color: var(--text-muted); margin-top: 6px; }
        .feed-panel { background: var(--viz-bg-secondary); border-radius: 8px; padding: 12px; grid-column: span 2; }
        .feed-panel h4 { color: var(--viz-success); margin: 0 0 8px 0; }
        .feed { display: flex; flex-wrap: wrap; gap: 6px; }
        .feed-tweet { background: linear-gradient(135deg, var(--viz-primary), var(--viz-secondary)); color: white; padding: 6px 10px; border-radius: 6px; font-size: 0.85rem; }
        .heap-viz { background: var(--viz-bg-secondary); border-radius: 8px; padding: 12px; grid-column: span 2; margin-top: 10px; }
        .heap-viz h4 { color: var(--viz-warning); margin: 0 0 8px 0; }
        .heap-items { display: flex; gap: 8px; flex-wrap: wrap; }
        .heap-item { background: var(--viz-warning); color: #0f172a; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body>
    <div class="main-layout">
        <div class="canvas-area">
            <div class="viz-card">
                <div class="viz-title">è¨­è¨ˆæ¨ç‰¹ï¼ˆDESIGN TWITTERï¼‰</div>
                <div class="twitter-ui" id="twitterUI"></div>
                <div class="controls" style="margin-top: 15px;">
                    <button class="viz-btn" id="prevBtn">â† ä¸Šä¸€æ­¥</button>
                    <div class="step-indicator">æ­¥é©Ÿ <span id="currentStep">0</span> / <span id="totalSteps">0</span></div>
                    <button class="viz-btn primary" id="nextBtn">ä¸‹ä¸€æ­¥ â†’</button>
                    <button class="viz-btn" onclick="resetVisualization()">â†» é‡ç½®</button>
                </div>
                <div class="state-grid">
                    <div class="state-item">
                        <div class="state-label">æ“ä½œ</div>
                        <div class="state-value" id="opDisplay" style="font-size: 0.9rem;">-</div>
                    </div>
                    <div class="state-item">
                        <div class="state-label">Heap å¤§å°</div>
                        <div class="state-value" id="heapSizeDisplay">0</div>
                    </div>
                </div>
            </div>
            <div class="viz-card">
                <div class="viz-title">æ¼”ç®—æ³•èªªæ˜</div>
                <div class="explanation" id="explanation"></div>
            </div>
        </div>
        <div class="code-area">
            <div class="viz-card" style="height: 100%; box-sizing: border-box;">
                <div class="viz-title">è³‡æ–™çµæ§‹è¨­è¨ˆ (C++)</div>
                <div class="code-panel" id="codeDisplay"></div>
            </div>
        </div>
    </div>
    <script src="../assets/visualizer/core.js"></script>
    <script>
        const codeStructure = [
            { line: 'class Twitter {', id: 0 },
            { line: '    unordered_map<int, vector<pair<int, int>>> tweets;', id: 1 },
            { line: '    unordered_map<int, unordered_set<int>> follows;', id: 2 },
            { line: '    int time = 0;', id: 3 },
            { line: '', id: 4 },
            { line: '    void postTweet(int userId, int tweetId) {', id: 5 },
            { line: '        tweets[userId].push_back({time++, tweetId});', id: 6 },
            { line: '    }', id: 7 },
            { line: '', id: 8 },
            { line: '    void follow(int followerId, int followeeId) {', id: 9 },
            { line: '        follows[followerId].insert(followeeId);', id: 10 },
            { line: '    }', id: 11 },
            { line: '', id: 12 },
            { line: '    vector<int> getNewsFeed(int userId) {', id: 13 },
            { line: '        // ä½¿ç”¨ Max Heap åˆä½µ K å€‹æ¨æ–‡åˆ—è¡¨', id: 14 },
            { line: '        priority_queue<tuple<int,int,int,int>> pq;', id: 15 },
            { line: '        // åˆä½µè‡ªå·±èˆ‡é—œæ³¨è€…çš„æ¨æ–‡', id: 16 },
            { line: '        // æ¯æ¬¡å–æ™‚é–“æœ€æ–°çš„ï¼Œæœ€å¤šå– 10 å‰‡', id: 17 },
            { line: '    }', id: 18 },
            { line: '};', id: 19 },
        ];
        
        function generateAlgorithmSteps() {
            const steps = [];
            let users = {}; // userId -> { tweets: [], following: Set }
            let timestamp = 0;
            
            // åˆå§‹åŒ–
            steps.push({
                users: {},
                feed: [],
                heap: [],
                op: 'åˆå§‹åŒ–',
                highlightLines: [0, 1, 2, 3],
                explanation: { 
                    title: 'è³‡æ–™çµæ§‹è¨­è¨ˆ', 
                    text: 'ä½¿ç”¨ä¸‰å€‹æ ¸å¿ƒè³‡æ–™çµæ§‹ï¼š<br><br>1. <strong>tweets</strong>ï¼šuserId â†’ [(time, tweetId)]<br>2. <strong>follows</strong>ï¼šuserId â†’ Set of followeeIds<br>3. <strong>time</strong>ï¼šå…¨åŸŸæ™‚é–“æˆ³è¨˜<br><br>é€™è¨­è¨ˆæ”¯æ´ O(1) çš„ç™¼æ–‡å’Œè¿½è¹¤æ“ä½œã€‚' 
                }
            });
            
            // æ“ä½œåºåˆ—
            const operations = [
                { type: 'post', user: 1, tweet: 101 },
                { type: 'post', user: 2, tweet: 201 },
                { type: 'follow', follower: 1, followee: 2 },
                { type: 'post', user: 2, tweet: 202 },
                { type: 'feed', user: 1 },
            ];
            
            for (const op of operations) {
                if (op.type === 'post') {
                    if (!users[op.user]) users[op.user] = { tweets: [], following: new Set() };
                    users[op.user].tweets.push({ time: timestamp++, id: op.tweet });
                    
                    steps.push({
                        users: JSON.parse(JSON.stringify(users, (k, v) => v instanceof Set ? [...v] : v)),
                        feed: [],
                        heap: [],
                        op: `postTweet(${op.user}, ${op.tweet})`,
                        newTweet: { user: op.user, tweet: op.tweet },
                        highlightLines: [5, 6, 7],
                        explanation: { 
                            title: `ç”¨æˆ¶ ${op.user} ç™¼æ¨æ–‡`, 
                            text: `æ¨æ–‡ ID: ${op.tweet}<br>æ™‚é–“æˆ³è¨˜: ${timestamp - 1}<br><br>å°‡ (time, tweetId) è¿½åŠ åˆ°è©²ç”¨æˆ¶çš„æ¨æ–‡åˆ—è¡¨ã€‚`,
                            formula: `tweets[${op.user}].push({${timestamp - 1}, ${op.tweet}})`
                        }
                    });
                } else if (op.type === 'follow') {
                    if (!users[op.follower]) users[op.follower] = { tweets: [], following: new Set() };
                    if (!users[op.followee]) users[op.followee] = { tweets: [], following: new Set() };
                    users[op.follower].following.add(op.followee);
                    
                    steps.push({
                        users: JSON.parse(JSON.stringify(users, (k, v) => v instanceof Set ? [...v] : v)),
                        feed: [],
                        heap: [],
                        op: `follow(${op.follower}, ${op.followee})`,
                        highlightLines: [9, 10, 11],
                        explanation: { 
                            title: `ç”¨æˆ¶ ${op.follower} è¿½è¹¤ç”¨æˆ¶ ${op.followee}`, 
                            text: `ç¾åœ¨ç”¨æˆ¶ ${op.follower} çš„å‹•æ…‹ç‰†å°‡é¡¯ç¤ºç”¨æˆ¶ ${op.followee} çš„æ¨æ–‡ã€‚`,
                            formula: `follows[${op.follower}].insert(${op.followee})`
                        }
                    });
                } else if (op.type === 'feed') {
                    // æ”¶é›†æ‰€æœ‰ç›¸é—œæ¨æ–‡
                    const allTweets = [];
                    const user = users[op.user] || { tweets: [], following: new Set() };
                    
                    // è‡ªå·±çš„æ¨æ–‡
                    for (const t of user.tweets) {
                        allTweets.push({ ...t, from: op.user });
                    }
                    // è¿½è¹¤è€…çš„æ¨æ–‡
                    for (const followeeId of (user.following || [])) {
                        const followee = users[followeeId];
                        if (followee) {
                            for (const t of followee.tweets) {
                                allTweets.push({ ...t, from: followeeId });
                            }
                        }
                    }
                    
                    // æŒ‰æ™‚é–“æ’åºï¼ˆæ–°çš„åœ¨å‰ï¼‰
                    allTweets.sort((a, b) => b.time - a.time);
                    const feed = allTweets.slice(0, 10);
                    
                    steps.push({
                        users: JSON.parse(JSON.stringify(users, (k, v) => v instanceof Set ? [...v] : v)),
                        feed: feed.map(t => `${t.id}(User${t.from})`),
                        heap: allTweets.map(t => `t=${t.time},id=${t.id}`),
                        op: `getNewsFeed(${op.user})`,
                        highlightLines: [13, 14, 15, 16, 17],
                        explanation: { 
                            title: `å–å¾—ç”¨æˆ¶ ${op.user} çš„å‹•æ…‹ç‰†`, 
                            text: `ä½¿ç”¨ <strong>Max Heap</strong> åˆä½µå¤šå€‹æ¨æ–‡ä¾†æºï¼š<br><br>1. ç”¨æˆ¶ ${op.user} è‡ªå·±çš„æ¨æ–‡<br>2. è¿½è¹¤å°è±¡çš„æ¨æ–‡<br><br>Heap æŒ‰æ™‚é–“æˆ³è¨˜æ’åºï¼Œæ¯æ¬¡å–æœ€æ–°çš„æ¨æ–‡ï¼Œæœ€å¤šå›å‚³ 10 å‰‡ã€‚<br><br>çµæœï¼š[${feed.map(t => t.id).join(', ')}]`,
                            formula: `K = é—œæ³¨è€…æ•¸é‡ + 1ï¼Œæ™‚é–“è¤‡é›œåº¦ O(10 log K)`
                        }
                    });
                }
            }
            
            return steps;
        }

        let viz;
        function init() {
            viz = new AlgorithmVisualizer({
                codeLines: codeStructure,
                onStepChange: (step) => {
                    let html = '';
                    
                    // ç”¨æˆ¶é¢æ¿
                    const userIds = Object.keys(step.users || {});
                    for (const uid of userIds) {
                        const u = step.users[uid];
                        const isNew = step.newTweet?.user == uid;
                        html += `<div class="user-panel">
                            <h4>ğŸ‘¤ ç”¨æˆ¶ ${uid}</h4>
                            <div class="user-tweets">${(u.tweets || []).map(t => 
                                `<span class="tweet${isNew && t.id === step.newTweet?.tweet ? ' new' : ''}">#${t.id}</span>`
                            ).join(' ')}</div>
                            <div class="followers">è¿½è¹¤ï¼š${(u.following || []).length > 0 ? u.following.join(', ') : 'ç„¡'}</div>
                        </div>`;
                    }
                    
                    // Feed é¢æ¿
                    if (step.feed?.length > 0) {
                        html += `<div class="feed-panel"><h4>ğŸ“° å‹•æ…‹ç‰†</h4><div class="feed">${
                            step.feed.map(t => `<span class="feed-tweet">${t}</span>`).join('')
                        }</div></div>`;
                    }
                    
                    // Heap è¦–è¦ºåŒ–
                    if (step.heap?.length > 0) {
                        html += `<div class="heap-viz"><h4>ğŸ”º Max Heapï¼ˆæŒ‰æ™‚é–“æ’åºï¼‰</h4><div class="heap-items">${
                            step.heap.map(h => `<span class="heap-item">${h}</span>`).join('')
                        }</div></div>`;
                    }
                    
                    document.getElementById('twitterUI').innerHTML = html || '<div style="text-align:center;color:var(--text-muted);">æº–å‚™é–‹å§‹...</div>';
                    document.getElementById('opDisplay').textContent = step.op || '-';
                    document.getElementById('heapSizeDisplay').textContent = step.heap?.length || 0;
                }
            });
            viz.setSteps(generateAlgorithmSteps());
        }
        
        function resetVisualization() { init(); }
        window.addEventListener('load', init);
    </script>
</body>
</html>
