<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Implement Trie (Prefix Tree) - Á≤æÁ∑ªË¶ñË¶∫Âåñ</title>
    <link rel="stylesheet" href="../assets/visualizer/style.css">
    <style>
        .visualization-area {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 50%, #1e293b 100%);
            border-radius: 16px;
            padding: 20px;
            margin: 15px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow: hidden;
        }

        /* SVG Container */
        #trie-svg {
            width: 100%; height: 400px;
            background: transparent;
            cursor: move;
        }

        /* Nodes */
        .node-circle {
            fill: #3b82f6; stroke: none;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3));
            transition: fill 0.4s ease, r 0.4s ease;
        }
        .node-circle.root { fill: #475569; }
        .node-circle.is-end { stroke: #22c55e; stroke-width: 3px; }
        .node-circle.current { fill: #fbbf24; filter: drop-shadow(0 0 8px rgba(251, 191, 36, 0.6)); }
        .node-circle.match { fill: #22c55e; }
        .node-circle.mismatch { fill: #ef4444; }

        .node-text {
            fill: white; font-family: 'Consolas', monospace; font-weight: bold; font-size: 14px;
            text-anchor: middle; dominant-baseline: middle; pointer-events: none;
        }

        /* Links */
        .link {
            stroke: #64748b; stroke-width: 2px; opacity: 0.6;
            transition: stroke 0.4s ease, stroke-width 0.4s ease;
        }
        .link.active { stroke: #fbbf24; stroke-width: 3px; opacity: 1; }
        .link.match { stroke: #22c55e; stroke-width: 3px; opacity: 1; }

        /* Operation Tag */
        .op-tag {
            background: rgba(30, 41, 59, 0.6); padding: 8px 16px; border-radius: 20px;
            color: #94a3b8; font-size: 0.9rem; margin-bottom: 10px;
        }

        /* Controls */
        .custom-input-section { background: var(--viz-card-bg); border-radius: 8px; padding: 15px; margin-bottom: 15px; border: 1px solid var(--viz-border); }
        .input-row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-bottom: 8px; }
        .input-row input { padding: 8px 12px; border-radius: 6px; border: 1px solid var(--viz-border); background: var(--viz-input-bg); color: var(--viz-text); font-family: monospace; width: 120px; }
        .input-row button { padding: 8px 16px; border-radius: 6px; background: var(--viz-primary); color: white; border: none; cursor: pointer; font-weight: 600; }
        
        .step-breakdown {
            background: rgba(30, 41, 59, 0.6);
            border-radius: 12px;
            padding: 15px 20px;
            border-left: 4px solid #3b82f6;
            margin-top: 15px;
            width: 100%; box-sizing: border-box;
        }
    </style>
</head>
<body>
    <button class="theme-toggle" onclick="AlgorithmVisualizer.toggleTheme()" title="ÂàáÊèõ‰∏ªÈ°å">üåì</button>
    <div class="main-layout">
        <div class="canvas-area">
            <div class="viz-card">
                <div class="viz-title">Trie (Â≠óÈ¶ñÊ®π) ÂØ¶‰Ωú</div>
                <div class="custom-input-section">
                    <div class="input-row">
                        <label>ÂñÆË©û:</label>
                        <input type="text" id="wordInput" value="apple" placeholder="Ëº∏ÂÖ•ÂñÆË©û" maxlength="8">
                        <button onclick="handleOp('insert')">ÊèíÂÖ• (Insert)</button>
                        <button onclick="handleOp('search')">ÊêúÂ∞ã (Search)</button>
                        <button onclick="handleOp('startsWith')">ÂâçÁ∂¥ÊêúÂ∞ã (StartsWith)</button>
                    </div>
                    <div class="input-row">
                        <button onclick="resetTrie()" style="background:var(--viz-error);">ÈáçÁΩÆÊ®π (Reset)</button>
                    </div>
                </div>

                <div class="visualization-area">
                    <div class="op-tag" id="opDisplay">Ê∫ñÂÇôÂ∞±Á∑í</div>
                    <svg id="trie-svg">
                        <g id="zoom-layer"></g> <!-- Apply Zoom/Pan here -->
                    </svg>
                </div>

                <div class="step-breakdown">
                    <div style="font-size:0.75rem; font-weight:bold; color:#64748b;">Áï∂ÂâçÊ≠•È©ü</div>
                    <div id="stepText" style="font-size:0.95rem; font-family:monospace; color:#e2e8f0;">Ready.</div>
                </div>

                <div class="controls" style="margin-top: 15px;">
                    <button class="viz-btn" id="prevBtn">‚Üê ‰∏ä‰∏ÄÊ≠•</button>
                    <div class="step-indicator">Ê≠•È©ü <span id="currentStep">0</span> / <span id="totalSteps">0</span></div>
                    <button class="viz-btn primary" id="nextBtn">‰∏ã‰∏ÄÊ≠• ‚Üí</button>
                    <button class="viz-btn play-btn" id="playBtn" onclick="viz.toggleAutoPlay()">‚ñ∂ Ëá™ÂãïÊí≠Êîæ</button>
                    <div class="speed-control">
                        <label>ÈÄüÂ∫¶:</label>
                        <select id="speedSelect" onchange="viz.setSpeed(Number(this.value))">
                            <option value="1500">0.5x</option>
                            <option value="1000" selected>1x</option>
                            <option value="500">1.5x</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="viz-card"><div class="viz-title">ÈÇèËºØËß£Èáã</div><div class="explanation" id="explanation"></div></div>
        </div>
        
        <div class="code-area">
            <div class="viz-card" style="height: 100%;">
                <div class="viz-title">C++ Code</div>
                <div class="code-panel" id="codeDisplay"></div>
            </div>
        </div>
    </div>

    <!-- D3.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="../assets/visualizer/core.js"></script>
    <script>
        // Code Structure Definition
        const codeStructure = [
            { line: 'class TrieNode {', id: 0 },
            { line: '    TrieNode* children[26];', id: 1 },
            { line: '    bool isEnd = false;', id: 2 },
            { line: '};', id: 3 },
            { line: 'void insert(string word) {', id: 4 },
            { line: '    TrieNode* curr = root;', id: 5 },
            { line: '    for (char c : word) {', id: 6 },
            { line: '        if (!curr->children[c])', id: 7 },
            { line: '            curr->children[c] = new TrieNode();', id: 8 },
            { line: '        curr = curr->children[c];', id: 9 },
            { line: '    }', id: 10 },
            { line: '    curr->isEnd = true;', id: 11 },
            { line: '}', id: 12 },
            { line: 'bool search(string word) {', id: 13 },
            { line: '    TrieNode* curr = root;', id: 14 },
            { line: '    for (char c : word) {', id: 15 },
            { line: '        if (!curr->children[c]) return false;', id: 16 },
            { line: '        curr = curr->children[c];', id: 17 },
            { line: '    }', id: 18 },
            { line: '    return curr->isEnd;', id: 19 },
            { line: '}', id: 20 },
            { line: 'bool startsWith(string prefix) {', id: 21 },
            { line: '    // Same logic but return true', id: 22 },
            { line: '    return true;', id: 23 },
            { line: '}', id: 24 }
        ];

        // --- Trie Logic Management ---
        let root = { id: 'root', char: '', children: {}, isEnd: false, x: 0, y: 0 };
        let viz;
        let idCounter = 0;

        function cloneTrie(node) {
            const newNode = { ...node, children: {} }; // shallow copy props
            for (let k in node.children) {
                newNode.children[k] = cloneTrie(node.children[k]); // deep copy children
            }
            return newNode;
        }

        function generateSteps(startRoot, op, word) {
            const steps = [];
            const newRoot = cloneTrie(startRoot); // Simulation on clone
            
            // Initial Step
            steps.push({
                root: JSON.parse(JSON.stringify(newRoot)), // Deep snapshot
                activeNodeId: 'root',
                highlightLines: op === 'insert' ? [4, 5] : op === 'search' ? [13, 14] : [21],
                msg: `${op === 'insert' ? 'ÊèíÂÖ•' : op === 'search' ? 'ÊêúÂ∞ã' : 'ÂâçÁ∂¥Ê™¢Êü•'}: "${word}"`,
                opName: op,
                focusCharIndex: -1
            });

            let curr = newRoot;
            let mismatch = false;

            for (let i = 0; i < word.length; i++) {
                const char = word[i];
                
                // Pre-move visual
                steps.push({
                    root: JSON.parse(JSON.stringify(newRoot)),
                    activeNodeId: curr.id,
                    highlightLines: op === 'insert' ? [6] : [15],
                    msg: `ËôïÁêÜÂ≠óÁ¨¶: '${char}'`,
                    opName: op,
                    focusCharIndex: i
                });

                if (!curr.children[char]) {
                    if (op === 'insert') {
                        // Create
                        curr.children[char] = { 
                            id: `node-${++idCounter}`, 
                            char: char, 
                            children: {}, 
                            isEnd: false 
                        };
                        steps.push({
                            root: JSON.parse(JSON.stringify(newRoot)),
                            activeNodeId: curr.id,
                            highlightLines: [7, 8],
                            msg: `Ë∑ØÂæë‰∏çÂ≠òÂú®ÔºåÂª∫Á´ãÊñ∞ÁØÄÈªû '${char}'`,
                            opName: op,
                            focusCharIndex: i
                        });
                    } else {
                        // Mismatch
                        mismatch = true;
                        steps.push({
                            root: JSON.parse(JSON.stringify(newRoot)),
                            activeNodeId: curr.id,
                            highlightLines: [16],
                            msg: `Êâæ‰∏çÂà∞Â≠óÁ¨¶ '${char}'ÔºåÊêúÂ∞ãÂ§±Êïó`,
                            opName: op,
                            mismatchNodeId: curr.id,
                            focusCharIndex: i
                        });
                        break;
                    }
                }

                // Move
                curr = curr.children[char];
                steps.push({
                    root: JSON.parse(JSON.stringify(newRoot)),
                    activeNodeId: curr.id,
                    highlightLines: op === 'insert' ? [9] : [17],
                    msg: `ÁßªÂãïÂà∞ÁØÄÈªû '${char}'`,
                    opName: op,
                    focusCharIndex: i
                });
            }

            // Final Result
            if (op === 'insert') {
                curr.isEnd = true;
                steps.push({
                    root: JSON.parse(JSON.stringify(newRoot)),
                    activeNodeId: curr.id,
                    highlightLines: [11, 12],
                    msg: `Ê®ôË®òÁï∂ÂâçÁØÄÈªûÁÇ∫ÂñÆË©ûÁµêÂ∞æ (isEnd = true)`,
                    opName: op,
                    focusCharIndex: word.length
                });
            } else if (!mismatch) {
                // Search or StartsWith success check
                const success = (op === 'search' ? curr.isEnd : true);
                steps.push({
                    root: JSON.parse(JSON.stringify(newRoot)),
                    activeNodeId: curr.id,
                    highlightLines: op === 'search' ? [19] : [23],
                    msg: success ? (op==='search' ? 'ÊâæÂà∞ÂñÆË©ûÔºÅ(isEnd ÁÇ∫Áúü)' : 'ÂâçÁ∂¥Â≠òÂú®ÔºÅ') : 'ÂñÆË©ûÊú™ÊâæÂà∞ (ÈõñÁÑ∂Ë∑ØÂæëÂ≠òÂú®Ôºå‰ΩÜÈùûÁµêÂ∞æ)',
                    opName: op,
                    resultSuccess: success,
                    focusCharIndex: word.length
                });
            }

            return { steps, finalRoot: newRoot };
        }

        // --- D3 Rendering ---
        const svg = d3.select("#trie-svg");
        const gLayer = d3.select("#zoom-layer");
        const zoom = d3.zoom().on("zoom", (e) => gLayer.attr("transform", e.transform));
        svg.call(zoom);

        let width = 800, height = 400;

        function render(step) {
            document.getElementById('stepText').textContent = step.msg;
            if(step.opName) document.getElementById('opDisplay').textContent = 
                `${step.opName === 'insert' ? 'ÊèíÂÖ•' : step.opName === 'search' ? 'ÊêúÂ∞ã' : 'ÂâçÁ∂¥'}: ${document.getElementById('wordInput').value}`;

            // Convert Trie to Hierarchy for D3
            const hierarchyData = d3.hierarchy(step.root, d => Object.values(d.children));
            const treeLayout = d3.tree().size([width - 100, height - 100]);
            
            // Adjust layout spacing
            treeLayout.nodeSize([50, 60]); 
            
            treeLayout(hierarchyData);

            // Center Root
            const headerOffset = 50;
            const xOffset = width/2;
            
            // Links
            const links = gLayer.selectAll(".link").data(hierarchyData.links(), d => d.target.data.id);
            links.enter().append("path").attr("class", "link")
                .merge(links)
                .attr("class", d => {
                    let cls = "link";
                    // If target is in active path (simple heuristic: activeNodeId is one of its descendants? No, exact path tracking needed)
                    // Visualizing "Active Path" in Trie is tricky without full path array in step.
                    // But activeNodeId gives us the TIP.
                    // Let's settle for simple logic: Is this link connected to active node or ancestors?
                    // We can trace up from active node in hierarchy if we find it.
                    return cls;
                })
                .transition().duration(400)
                .attr("d", d3.linkVertical()
                    .x(d => d.x + xOffset)
                    .y(d => d.y + headerOffset)
                );
            links.exit().remove();

            // Nodes
            const nodes = gLayer.selectAll(".node").data(hierarchyData.descendants(), d => d.data.id);
            const nodeEnter = nodes.enter().append("g").attr("class", "node");
            
            nodeEnter.append("circle").attr("r", 20).attr("class", "node-circle");
            nodeEnter.append("text").attr("class", "node-text").attr("dy", 1);

            const nodeUpdate = nodes.merge(nodeEnter).transition().duration(400)
                .attr("transform", d => `translate(${d.x + xOffset},${d.y + headerOffset})`);

            nodes.select(".node-circle").attr("class", d => {
                let cls = "node-circle";
                if (d.data.id === 'root') cls += " root";
                if (d.data.isEnd) cls += " is-end";
                if (d.data.id === step.activeNodeId) cls += " current";
                if (step.mismatchNodeId === d.data.id) cls += " mismatch";
                if (step.resultSuccess && d.data.id === step.activeNodeId) cls += " match";
                return cls;
            });

            nodes.select(".node-text").text(d => d.data.char);
            
            nodes.exit().remove();
        }

        // --- Interaction ---
        function handleOp(op) {
            const word = document.getElementById('wordInput').value.trim().toLowerCase();
            if (!word || !/^[a-z]+$/.test(word)) return alert("Ë´ãËº∏ÂÖ•Ëã±ÊñáÂ≠óÊØç (a-z)");

            const { steps, finalRoot } = generateSteps(root, op, word);
            
            if (op === 'insert') {
                root = finalRoot; // Commit change
            }
            
            viz.setSteps(steps);
        }

        function resetTrie() {
            root = { id: 'root', char: '', children: {}, isEnd: false };
            idCounter = 0;
            // Clear visualization
            svg.selectAll("*").remove(); 
            // Re-init gLayer
            svg.append("g").attr("id", "zoom-layer");
            // Or just init default
            viz = new AlgorithmVisualizer({
                codeLines: codeStructure,
                onStepChange: render
            });
            viz.setSteps([{root:root, msg:"Â∑≤ÈáçÁΩÆ", highlightLines:[]}]);
        }

        window.addEventListener('load', () => {
            viz = new AlgorithmVisualizer({
                codeLines: codeStructure,
                onStepChange: render
            });
            handleOp('insert'); // Demo initial insert
        });
    </script>
</body>
</html>
