<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reorder List - ç²¾ç·»è¦–è¦ºåŒ–</title>
    <link rel="stylesheet" href="../assets/visualizer/style.css">
    <style>
        .visualization-area {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 50%, #1e293b 100%);
            border-radius: 16px;
            padding: 30px 20px;
            margin: 15px 0;
        }

        .phase-indicator {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .phase {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            background: rgba(100, 116, 139, 0.2);
            color: #64748b;
            transition: all 0.3s;
        }

        .phase.active {
            background: rgba(59, 130, 246, 0.3);
            color: #60a5fa;
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.3);
        }

        .phase.done {
            background: rgba(34, 197, 94, 0.3);
            color: #22c55e;
        }

        .lists-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
        }

        .list-section {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .list-label {
            width: 100px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #64748b;
        }

        .nodes-row {
            display: flex;
            align-items: center;
            gap: 0;
        }

        .node-wrapper { display: flex; align-items: center; position: relative; }

        .node {
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.2rem;
            border-radius: 50%;
            background: linear-gradient(145deg, #3b82f6, #2563eb);
            color: white;
            position: relative;
            transition: all 0.4s;
            border: 3px solid transparent;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }

        .node.first-half {
            background: linear-gradient(145deg, #3b82f6, #2563eb);
        }

        .node.second-half {
            background: linear-gradient(145deg, #a855f7, #9333ea);
            box-shadow: 0 4px 15px rgba(168, 85, 247, 0.3);
        }

        .node.merged {
            background: linear-gradient(145deg, #22c55e, #16a34a);
            box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3);
        }

        .node.slow {
            border-color: #22c55e;
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.5);
        }

        .node.fast {
            border-color: #ef4444;
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.5);
        }

        .node.active {
            border-color: #fbbf24;
            box-shadow: 0 0 25px rgba(251, 191, 36, 0.6);
            transform: scale(1.1);
        }

        .node-pointer-label {
            position: absolute;
            bottom: -22px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.6rem;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 4px;
            white-space: nowrap;
        }

        .node-pointer-label.slow { background: #22c55e; color: #0f172a; }
        .node-pointer-label.fast { background: #ef4444; color: white; }
        .node-pointer-label.first { background: #3b82f6; color: white; }
        .node-pointer-label.second { background: #a855f7; color: white; }

        .link { width: 30px; height: 20px; display: flex; align-items: center; justify-content: center; }
        .link svg { width: 30px; height: 20px; }

        .legend-bar {
            display: flex;
            justify-content: center;
            gap: 20px;
            padding: 15px;
            background: rgba(30, 41, 59, 0.5);
            border-radius: 12px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .legend-item { display: flex; align-items: center; gap: 6px; font-size: 0.75rem; color: #94a3b8; }
        .legend-dot { width: 12px; height: 12px; border-radius: 50%; }
        .legend-dot.first { background: linear-gradient(145deg, #3b82f6, #2563eb); }
        .legend-dot.second { background: linear-gradient(145deg, #a855f7, #9333ea); }
        .legend-dot.slow { border: 2px solid #22c55e; background: transparent; }
        .legend-dot.fast { border: 2px solid #ef4444; background: transparent; }

        .step-breakdown {
            background: rgba(30, 41, 59, 0.6);
            border-radius: 12px;
            padding: 15px 20px;
            margin-top: 15px;
            border-left: 4px solid #3b82f6;
        }

        .step-breakdown-title { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: #64748b; margin-bottom: 8px; }
        .step-breakdown-text { font-size: 0.95rem; color: #e2e8f0; font-family: 'Consolas', monospace; }

        .custom-input-section { background: var(--viz-card-bg); border-radius: 8px; padding: 15px; margin-bottom: 15px; border: 1px solid var(--viz-border); }
        .input-title { font-weight: bold; margin-bottom: 10px; color: var(--viz-text); }
        .input-row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .input-row input { padding: 8px 12px; border-radius: 6px; border: 1px solid var(--viz-border); background: var(--viz-input-bg); color: var(--viz-text); font-family: monospace; flex: 1; min-width: 150px; }
        .input-row button { padding: 8px 16px; border-radius: 6px; background: var(--viz-primary); color: white; border: none; cursor: pointer; font-weight: 600; }

        .code-line.active { background: rgba(251, 191, 36, 0.15) !important; border-left: 3px solid #fbbf24 !important; }
    </style>
</head>
<body>
    <button class="theme-toggle" onclick="AlgorithmVisualizer.toggleTheme()" title="åˆ‡æ›ä¸»é¡Œ">ğŸŒ“</button>
    <div class="main-layout">
        <div class="canvas-area">
            <div class="viz-card">
                <div class="viz-title">Reorder List - Lâ‚€â†’Lâ‚™â†’Lâ‚â†’Lâ‚™â‚‹â‚â†’...</div>

                <div class="custom-input-section">
                    <div class="input-title">ğŸ® è‡ªè¨‚æ¸¬è©¦</div>
                    <div class="input-row">
                        <input type="text" id="customList" value="1,2,3,4,5">
                        <button onclick="runCustomInput()">åŸ·è¡Œ</button>
                    </div>
                </div>

                <div class="visualization-area">
                    <div class="phase-indicator">
                        <span class="phase" id="phase1">1. æ‰¾ä¸­é»</span>
                        <span class="phase" id="phase2">2. åè½‰å¾ŒåŠ</span>
                        <span class="phase" id="phase3">3. äº¤éŒ¯åˆä½µ</span>
                    </div>

                    <div class="lists-container" id="listsContainer"></div>

                    <div class="legend-bar">
                        <div class="legend-item"><div class="legend-dot first"></div>å‰åŠéƒ¨</div>
                        <div class="legend-item"><div class="legend-dot second"></div>å¾ŒåŠéƒ¨</div>
                        <div class="legend-item"><div class="legend-dot slow"></div>slow</div>
                        <div class="legend-item"><div class="legend-dot fast"></div>fast</div>
                    </div>
                </div>

                <div class="step-breakdown">
                    <div class="step-breakdown-title">Step Breakdown</div>
                    <div class="step-breakdown-text" id="stepBreakdown">é»æ“Šã€Œä¸‹ä¸€æ­¥ã€é–‹å§‹æ¼”ç®—æ³•</div>
                </div>

                <div class="controls" style="margin-top: 15px;">
                    <button class="viz-btn" id="prevBtn">â† ä¸Šä¸€æ­¥</button>
                    <div class="step-indicator">æ­¥é©Ÿ <span id="currentStep">0</span> / <span id="totalSteps">0</span></div>
                    <button class="viz-btn primary" id="nextBtn">ä¸‹ä¸€æ­¥ â†’</button>
                    <button class="viz-btn" onclick="resetVisualization()">â†» é‡ç½®</button>
                    <button class="viz-btn play-btn" id="playBtn" onclick="viz.toggleAutoPlay()">â–¶ è‡ªå‹•æ’­æ”¾</button>
                    <div class="speed-control">
                        <label>é€Ÿåº¦:</label>
                        <select id="speedSelect" onchange="viz.setSpeed(Number(this.value))">
                            <option value="2000">0.5x</option>
                            <option value="1500" selected>1x</option>
                            <option value="1000">1.5x</option>
                            <option value="500">2x</option>
                        </select>
                    </div>
                </div>

                <div class="complexity-badge">
                    <span class="label">Time:</span> O(n)
                    <span class="label" style="margin-left: 12px;">Space:</span> O(1)
                </div>
            </div>

            <div class="viz-card">
                <div class="viz-title">æ¼”ç®—æ³•èªªæ˜</div>
                <div class="explanation" id="explanation"></div>
            </div>
        </div>

        <div class="code-area">
            <div class="viz-card" style="height: 100%;">
                <div class="viz-title">æ¼”ç®—æ³• (C++)</div>
                <div class="code-panel" id="codeDisplay"></div>
            </div>
        </div>
    </div>

    <script src="../assets/visualizer/core.js"></script>
    <script>
        const codeStructure = [
            { line: 'void reorderList(ListNode* head) {', id: 0 },
            { line: '    // Step 1: Find middle', id: 1 },
            { line: '    ListNode *slow = head, *fast = head;', id: 2 },
            { line: '    while (fast->next && fast->next->next) {', id: 3 },
            { line: '        slow = slow->next;', id: 4 },
            { line: '        fast = fast->next->next;', id: 5 },
            { line: '    }', id: 6 },
            { line: '    // Step 2: Reverse second half', id: 7 },
            { line: '    ListNode* second = slow->next;', id: 8 },
            { line: '    slow->next = nullptr;', id: 9 },
            { line: '    ListNode* prev = nullptr;', id: 10 },
            { line: '    while (second) { /*reverse*/ }', id: 11 },
            { line: '    // Step 3: Merge alternately', id: 12 },
            { line: '    ListNode *first = head;', id: 13 },
            { line: '    while (second) {', id: 14 },
            { line: '        first->next = second;', id: 15 },
            { line: '        second->next = tmp1; ...', id: 16 },
            { line: '    }', id: 17 },
            { line: '}', id: 18 },
        ];

        let currentList = [1, 2, 3, 4, 5];
        let viz;

        function createArrowSVG(color = '#64748b') {
            return `<svg viewBox="0 0 30 20"><path d="M 3 10 L 22 10" stroke="${color}" stroke-width="2" fill="none"/><polygon points="22,10 16,6 16,14" fill="${color}"/></svg>`;
        }

        function generateAlgorithmSteps(list) {
            const steps = [];
            const n = list.length;

            steps.push({
                phase: 0, list: [...list], slowIdx: 0, fastIdx: 0,
                highlightLines: [0, 1, 2],
                stepText: 'slow = head; fast = head',
                explanation: { title: 'åˆå§‹åŒ–', text: `åŸå§‹éˆè¡¨ï¼š${list.join(' â†’ ')}<br><br>ä¸‰æ­¥é©Ÿï¼šæ‰¾ä¸­é» â†’ åè½‰å¾ŒåŠ â†’ äº¤éŒ¯åˆä½µ`, formula: 'ç›®æ¨™: Lâ‚€â†’Lâ‚™â†’Lâ‚â†’Lâ‚™â‚‹â‚â†’...' }
            });

            // Phase 1: Find middle
            let slow = 0, fast = 0;
            while (fast < n - 1 && fast + 1 < n - 1) {
                slow++;
                fast += 2;
                steps.push({
                    phase: 1, list: [...list], slowIdx: slow, fastIdx: Math.min(fast, n - 1),
                    highlightLines: [3, 4, 5],
                    stepText: `slow = ${list[slow]}; fast = ${list[Math.min(fast, n - 1)]}`,
                    explanation: { title: 'æ‰¾ä¸­é»', text: `slow èµ° 1 æ­¥ â†’ ${list[slow]}<br>fast èµ° 2 æ­¥ â†’ ${list[Math.min(fast, n - 1)]}`, formula: 'slow += 1; fast += 2' }
                });
            }

            const midIdx = slow;
            const firstHalf = list.slice(0, midIdx + 1);
            const secondHalf = list.slice(midIdx + 1);
            const secondReversed = [...secondHalf].reverse();

            steps.push({
                phase: 2, firstHalf: [...firstHalf], secondHalf: [...secondHalf],
                highlightLines: [7, 8, 9],
                stepText: `split at index ${midIdx}; second = slow->next`,
                explanation: { title: 'åˆ†å‰²éˆè¡¨', text: `å‰åŠéƒ¨ï¼š${firstHalf.join(' â†’ ')}<br>å¾ŒåŠéƒ¨ï¼š${secondHalf.join(' â†’ ')}`, formula: `mid = ${midIdx}` }
            });

            steps.push({
                phase: 2, firstHalf: [...firstHalf], secondHalf: [...secondReversed], reversed: true,
                highlightLines: [10, 11],
                stepText: 'reverse(second)',
                explanation: { title: 'åè½‰å¾ŒåŠéƒ¨', text: `å‰åŠéƒ¨ï¼š${firstHalf.join(' â†’ ')}<br>å¾ŒåŠéƒ¨ï¼ˆåè½‰å¾Œï¼‰ï¼š${secondReversed.join(' â†’ ')}`, formula: `${secondHalf.join('â†’')} â†’ ${secondReversed.join('â†’')}` }
            });

            // Phase 3: Merge
            const result = [];
            let f = 0, s = 0;
            while (f < firstHalf.length || s < secondReversed.length) {
                if (f < firstHalf.length) result.push({ val: firstHalf[f++], from: 'first' });
                if (s < secondReversed.length) result.push({ val: secondReversed[s++], from: 'second' });

                steps.push({
                    phase: 3, result: [...result], firstHalf, secondHalf: secondReversed, fIdx: f, sIdx: s,
                    highlightLines: [14, 15, 16],
                    stepText: `merge: ${result.map(r => r.val).join(' â†’ ')}`,
                    explanation: { title: 'äº¤éŒ¯åˆä½µ', text: `ç›®å‰çµæœï¼š${result.map(r => r.val).join(' â†’ ')}`, formula: 'firstâ†’next = second; secondâ†’next = tmp1' }
                });
            }

            steps.push({
                phase: 4, result: [...result], final: true,
                highlightLines: [18],
                stepText: 'done!',
                explanation: { title: 'ğŸ‰ å®Œæˆï¼', text: `åŸå§‹ï¼š${list.join(' â†’ ')}<br>çµæœï¼š${result.map(r => r.val).join(' â†’ ')}`, formula: 'Lâ‚€â†’Lâ‚™â†’Lâ‚â†’Lâ‚™â‚‹â‚â†’...' }
            });

            return steps;
        }

        function renderStep(step) {
            const container = document.getElementById('listsContainer');
            let html = '';

            // Update phase indicators
            ['phase1', 'phase2', 'phase3'].forEach((id, i) => {
                const el = document.getElementById(id);
                el.classList.remove('active', 'done');
                if (step.phase === i + 1) el.classList.add('active');
                else if (step.phase > i + 1 || step.final) el.classList.add('done');
            });

            if (step.phase <= 1 && step.list) {
                // Single list with slow/fast
                html = '<div class="list-section"><span class="list-label">List</span><div class="nodes-row">';
                step.list.forEach((v, i) => {
                    let cls = 'node';
                    let labels = '';
                    if (i === step.slowIdx) { cls += ' slow'; labels += '<span class="node-pointer-label slow">slow</span>'; }
                    if (i === step.fastIdx) { cls += ' fast'; labels += '<span class="node-pointer-label fast">fast</span>'; }
                    html += `<div class="node-wrapper"><div class="${cls}">${v}${labels}</div>`;
                    if (i < step.list.length - 1) html += `<div class="link">${createArrowSVG()}</div>`;
                    html += '</div>';
                });
                html += '</div></div>';
            } else if (step.phase === 2 || (step.phase === 3 && !step.final)) {
                // Two halves
                html = '<div class="list-section"><span class="list-label">å‰åŠéƒ¨</span><div class="nodes-row">';
                step.firstHalf.forEach((v, i) => {
                    html += `<div class="node-wrapper"><div class="node first-half">${v}</div>`;
                    if (i < step.firstHalf.length - 1) html += `<div class="link">${createArrowSVG('#3b82f6')}</div>`;
                    html += '</div>';
                });
                html += '</div></div>';

                html += '<div class="list-section"><span class="list-label">å¾ŒåŠéƒ¨</span><div class="nodes-row">';
                (step.secondHalf || []).forEach((v, i) => {
                    html += `<div class="node-wrapper"><div class="node second-half">${v}</div>`;
                    if (i < step.secondHalf.length - 1) html += `<div class="link">${createArrowSVG('#a855f7')}</div>`;
                    html += '</div>';
                });
                html += '</div></div>';

                if (step.result) {
                    html += '<div class="list-section"><span class="list-label">çµæœ</span><div class="nodes-row">';
                    step.result.forEach((r, i) => {
                        const cls = r.from === 'first' ? 'node first-half' : 'node second-half';
                        html += `<div class="node-wrapper"><div class="${cls}">${r.val}</div>`;
                        if (i < step.result.length - 1) html += `<div class="link">${createArrowSVG('#22c55e')}</div>`;
                        html += '</div>';
                    });
                    html += '</div></div>';
                }
            } else if (step.final) {
                html = '<div class="list-section"><span class="list-label">çµæœ</span><div class="nodes-row">';
                step.result.forEach((r, i) => {
                    html += `<div class="node-wrapper"><div class="node merged">${r.val}</div>`;
                    if (i < step.result.length - 1) html += `<div class="link">${createArrowSVG('#22c55e')}</div>`;
                    html += '</div>';
                });
                html += '</div></div>';
            }

            container.innerHTML = html;
            document.getElementById('stepBreakdown').textContent = step.stepText || '';
        }

        function init(list = currentList) {
            currentList = list;
            viz = new AlgorithmVisualizer({
                codeLines: codeStructure,
                onStepChange: (step) => renderStep(step)
            });
            viz.setSteps(generateAlgorithmSteps(list));
        }

        function runCustomInput() {
            const list = document.getElementById('customList').value.split(',').map(s => parseInt(s.trim())).filter(n => !isNaN(n));
            if (list.length < 2 || list.length > 10) { alert('è«‹è¼¸å…¥ 2-10 å€‹ç¯€é»'); return; }
            init(list);
        }

        function resetVisualization() { init(currentList); }
        window.addEventListener('load', () => init());
    </script>
</body>
</html>
