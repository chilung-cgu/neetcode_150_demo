<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Copy List with Random Pointer - ç²¾ç·»è¦–è¦ºåŒ–</title>
    <link rel="stylesheet" href="../assets/visualizer/style.css">
    <style>
        .visualization-area {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 50%, #1e293b 100%);
            border-radius: 16px;
            padding: 30px 20px;
            margin: 15px 0;
            min-height: 350px;
        }

        .lists-container {
            display: flex;
            flex-direction: column;
            gap: 40px;
            align-items: center;
            position: relative;
        }

        .list-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .list-label {
            font-size: 0.8rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            padding: 4px 12px;
            border-radius: 12px;
        }

        .list-label.original {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
        }

        .list-label.copy {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }

        .nodes-row {
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
        }

        .node-wrapper {
            display: flex;
            align-items: center;
            position: relative;
        }

        .node {
            width: 60px;
            height: 60px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            border-radius: 50%;
            color: white;
            position: relative;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 3px solid transparent;
        }

        .node.original {
            background: linear-gradient(145deg, #3b82f6, #2563eb);
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }

        .node.copy {
            background: linear-gradient(145deg, #22c55e, #16a34a);
            box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3);
        }

        .node.copy.pending {
            background: linear-gradient(145deg, #475569, #334155);
            opacity: 0.5;
        }

        .node.active {
            border-color: #fbbf24;
            box-shadow: 0 0 25px rgba(251, 191, 36, 0.6), 0 0 50px rgba(251, 191, 36, 0.3);
            transform: scale(1.1);
        }

        .node .val {
            font-size: 1.2rem;
        }

        .node .random-indicator {
            font-size: 0.6rem;
            opacity: 0.8;
            margin-top: 2px;
        }

        .node-index {
            position: absolute;
            top: -18px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.6rem;
            color: #64748b;
            font-weight: 600;
        }

        /* Next é€£çµç®­é ­ */
        .next-link {
            width: 24px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .next-link svg { width: 24px; height: 20px; }

        /* Random æŒ‡æ¨™ç®­é ­å®¹å™¨ */
        .random-arrows-container {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
            top: 0;
            left: 0;
        }

        /* HashMap è¦–è¦ºåŒ– */
        .hashmap-panel {
            background: rgba(30, 41, 59, 0.8);
            border-radius: 12px;
            padding: 15px 20px;
            margin-top: 20px;
            border: 1px solid rgba(100, 116, 139, 0.3);
        }

        .hashmap-title {
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #64748b;
            margin-bottom: 10px;
        }

        .hashmap-entries {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .hashmap-entry {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 8px;
            font-size: 0.8rem;
            font-family: 'Consolas', monospace;
            transition: all 0.3s;
        }

        .hashmap-entry.active {
            background: rgba(251, 191, 36, 0.2);
            border: 1px solid #fbbf24;
        }

        .hashmap-entry .old-node {
            color: #60a5fa;
            font-weight: 600;
        }

        .hashmap-entry .arrow {
            color: #64748b;
        }

        .hashmap-entry .new-node {
            color: #22c55e;
            font-weight: 600;
        }

        /* é€£ç·šè¦–è¦ºåŒ– */
        .mapping-line {
            stroke: rgba(168, 85, 247, 0.4);
            stroke-width: 2;
            stroke-dasharray: 4;
            fill: none;
        }

        .mapping-line.active {
            stroke: #fbbf24;
            stroke-width: 3;
            stroke-dasharray: none;
        }

        /* åœ–ä¾‹ */
        .legend-bar {
            display: flex;
            justify-content: center;
            gap: 25px;
            padding: 15px;
            background: rgba(30, 41, 59, 0.5);
            border-radius: 12px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .legend-item { display: flex; align-items: center; gap: 8px; font-size: 0.8rem; color: #94a3b8; }
        .legend-dot { width: 14px; height: 14px; border-radius: 50%; }
        .legend-dot.original { background: linear-gradient(145deg, #3b82f6, #2563eb); }
        .legend-dot.copy { background: linear-gradient(145deg, #22c55e, #16a34a); }
        .legend-line { width: 20px; height: 3px; }
        .legend-line.next { background: #64748b; }
        .legend-line.random { background: #a855f7; border-radius: 2px; }

        /* Step Breakdown */
        .step-breakdown {
            background: rgba(30, 41, 59, 0.6);
            border-radius: 12px;
            padding: 15px 20px;
            margin-top: 15px;
            border-left: 4px solid #3b82f6;
        }

        .step-breakdown-title { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: #64748b; margin-bottom: 8px; }
        .step-breakdown-text { font-size: 0.95rem; color: #e2e8f0; font-family: 'Consolas', monospace; line-height: 1.6; }

        /* Phase indicator */
        .phase-indicator {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .phase {
            padding: 6px 14px;
            border-radius: 16px;
            font-size: 0.75rem;
            font-weight: 600;
            background: rgba(100, 116, 139, 0.2);
            color: #64748b;
            transition: all 0.3s;
        }

        .phase.active {
            background: rgba(59, 130, 246, 0.3);
            color: #60a5fa;
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.3);
        }

        .phase.done {
            background: rgba(34, 197, 94, 0.3);
            color: #22c55e;
        }

        /* è‡ªè¨‚è¼¸å…¥ */
        .custom-input-section { background: var(--viz-card-bg); border-radius: 8px; padding: 15px; margin-bottom: 15px; border: 1px solid var(--viz-border); }
        .input-title { font-weight: bold; margin-bottom: 10px; color: var(--viz-text); }
        .input-row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-bottom: 8px; }
        .input-row label { min-width: 80px; font-size: 0.85rem; }
        .input-row input { padding: 8px 12px; border-radius: 6px; border: 1px solid var(--viz-border); background: var(--viz-input-bg); color: var(--viz-text); font-family: monospace; flex: 1; min-width: 100px; }
        .input-row button { padding: 8px 16px; border-radius: 6px; background: var(--viz-primary); color: white; border: none; cursor: pointer; font-weight: 600; }
        .input-hint { font-size: 0.75rem; color: var(--viz-text-muted); margin-top: 5px; }

        .code-line.active { background: rgba(251, 191, 36, 0.15) !important; border-left: 3px solid #fbbf24 !important; }
    </style>
</head>
<body>
    <button class="theme-toggle" onclick="AlgorithmVisualizer.toggleTheme()" title="åˆ‡æ›ä¸»é¡Œ">ğŸŒ“</button>
    <div class="main-layout">
        <div class="canvas-area">
            <div class="viz-card">
                <div class="viz-title">Copy List with Random Pointer - HashMap æ·±æ‹·è²</div>

                <div class="custom-input-section">
                    <div class="input-title">ğŸ® è‡ªè¨‚æ¸¬è©¦</div>
                    <div class="input-row">
                        <label>ç¯€é»å€¼:</label>
                        <input type="text" id="customValues" value="7,13,11,10,1">
                    </div>
                    <div class="input-row">
                        <label>random æŒ‡å‘:</label>
                        <input type="text" id="customRandoms" value="-1,0,4,2,0">
                        <button onclick="runCustomInput()">åŸ·è¡Œ</button>
                    </div>
                    <div class="input-hint">random: -1 = null, 0~n-1 = æŒ‡å‘è©²ç´¢å¼•çš„ç¯€é»</div>
                </div>

                <div class="visualization-area">
                    <div class="phase-indicator">
                        <span class="phase" id="phase1">1. å»ºç«‹ç¯€é»</span>
                        <span class="phase" id="phase2">2. é€£æ¥æŒ‡æ¨™</span>
                    </div>

                    <div class="lists-container" id="listsContainer">
                        <svg id="mappingSvg" style="position: absolute; width: 100%; height: 100%; pointer-events: none;"></svg>
                    </div>

                    <div class="hashmap-panel">
                        <div class="hashmap-title">HashMap: old â†’ new</div>
                        <div class="hashmap-entries" id="hashmapEntries"></div>
                    </div>

                    <div class="legend-bar">
                        <div class="legend-item"><div class="legend-dot original"></div>åŸå§‹ç¯€é»</div>
                        <div class="legend-item"><div class="legend-dot copy"></div>è¤‡è£½ç¯€é»</div>
                        <div class="legend-item"><div class="legend-line next"></div>next æŒ‡æ¨™</div>
                        <div class="legend-item"><div class="legend-line random" style="background: #a855f7;"></div>random æŒ‡æ¨™</div>
                    </div>
                </div>

                <div class="step-breakdown">
                    <div class="step-breakdown-title">Step Breakdown</div>
                    <div class="step-breakdown-text" id="stepBreakdown">é»æ“Šã€Œä¸‹ä¸€æ­¥ã€é–‹å§‹æ¼”ç®—æ³•</div>
                </div>

                <div class="controls" style="margin-top: 15px;">
                    <button class="viz-btn" id="prevBtn">â† ä¸Šä¸€æ­¥</button>
                    <div class="step-indicator">æ­¥é©Ÿ <span id="currentStep">0</span> / <span id="totalSteps">0</span></div>
                    <button class="viz-btn primary" id="nextBtn">ä¸‹ä¸€æ­¥ â†’</button>
                    <button class="viz-btn" onclick="resetVisualization()">â†» é‡ç½®</button>
                    <button class="viz-btn play-btn" id="playBtn" onclick="viz.toggleAutoPlay()">â–¶ è‡ªå‹•æ’­æ”¾</button>
                    <div class="speed-control">
                        <label>é€Ÿåº¦:</label>
                        <select id="speedSelect" onchange="viz.setSpeed(Number(this.value))">
                            <option value="2000">0.5x</option>
                            <option value="1500" selected>1x</option>
                            <option value="1000">1.5x</option>
                            <option value="500">2x</option>
                        </select>
                    </div>
                </div>

                <div class="complexity-badge">
                    <span class="label">Time:</span> O(n)
                    <span class="label" style="margin-left: 12px;">Space:</span> O(n)
                </div>
            </div>

            <div class="viz-card">
                <div class="viz-title">æ¼”ç®—æ³•èªªæ˜</div>
                <div class="explanation" id="explanation"></div>
            </div>
        </div>

        <div class="code-area">
            <div class="viz-card" style="height: 100%;">
                <div class="viz-title">HashMap è§£æ³• (C++)</div>
                <div class="code-panel" id="codeDisplay"></div>
            </div>
        </div>
    </div>

    <script src="../assets/visualizer/core.js"></script>
    <script>
        const codeStructure = [
            { line: 'Node* copyRandomList(Node* head) {', id: 0 },
            { line: '    unordered_map<Node*, Node*> oldToNew;', id: 1 },
            { line: '', id: 2 },
            { line: '    // Pass 1: å»ºç«‹æ‰€æœ‰æ–°ç¯€é»', id: 3 },
            { line: '    Node* curr = head;', id: 4 },
            { line: '    while (curr) {', id: 5 },
            { line: '        oldToNew[curr] = new Node(curr->val);', id: 6 },
            { line: '        curr = curr->next;', id: 7 },
            { line: '    }', id: 8 },
            { line: '', id: 9 },
            { line: '    // Pass 2: é€£æ¥ next å’Œ random', id: 10 },
            { line: '    curr = head;', id: 11 },
            { line: '    while (curr) {', id: 12 },
            { line: '        oldToNew[curr]->next = oldToNew[curr->next];', id: 13 },
            { line: '        oldToNew[curr]->random = oldToNew[curr->random];', id: 14 },
            { line: '        curr = curr->next;', id: 15 },
            { line: '    }', id: 16 },
            { line: '    return oldToNew[head];', id: 17 },
            { line: '}', id: 18 },
        ];

        let currentNodes = [
            { val: 7, random: null },
            { val: 13, random: 0 },
            { val: 11, random: 4 },
            { val: 10, random: 2 },
            { val: 1, random: 0 }
        ];
        let viz;

        function createArrowSVG(color = '#64748b') {
            return `<svg viewBox="0 0 24 20"><path d="M 2 10 L 18 10" stroke="${color}" stroke-width="2" fill="none"/><polygon points="18,10 12,6 12,14" fill="${color}"/></svg>`;
        }

        function generateAlgorithmSteps(nodes) {
            const steps = [];
            const n = nodes.length;

            // åˆå§‹åŒ–
            steps.push({
                phase: 0,
                createdCount: 0,
                connectedCount: 0,
                currentIdx: -1,
                highlightLines: [0, 1],
                stepText: 'oldToNew = {}',
                explanation: {
                    title: 'åˆå§‹åŒ– HashMap',
                    text: `åŸå§‹éˆè¡¨æœ‰ ${n} å€‹ç¯€é»<br>æ¯å€‹ç¯€é»æœ‰ val, next, random ä¸‰å€‹å±¬æ€§<br><br>HashMap ç”¨ä¾†è¨˜éŒ„ï¼šèˆŠç¯€é» â†’ æ–°ç¯€é»`,
                    formula: 'unordered_map<Node*, Node*> oldToNew'
                }
            });

            // Pass 1: å»ºç«‹æ‰€æœ‰æ–°ç¯€é»
            for (let i = 0; i < n; i++) {
                const node = nodes[i];
                const randomTarget = node.random !== null ? nodes[node.random].val : 'null';

                steps.push({
                    phase: 1,
                    createdCount: i + 1,
                    connectedCount: 0,
                    currentIdx: i,
                    highlightLines: [5, 6, 7],
                    stepText: `oldToNew[old_${i}] = new Node(${node.val})`,
                    explanation: {
                        title: `Pass 1: å»ºç«‹ç¯€é» ${i}`,
                        text: `åŸå§‹ç¯€é»: val=${node.val}, randomâ†’${randomTarget}<br><br>å»ºç«‹è¤‡è£½ç¯€é»ï¼Œæš«ä¸è¨­å®šæŒ‡æ¨™<br>åŠ å…¥ HashMap: old_${i} â†’ new_${i}`,
                        formula: `oldToNew[${node.val}] = new Node(${node.val})`
                    }
                });
            }

            // Pass 1 å®Œæˆ
            steps.push({
                phase: 1,
                createdCount: n,
                connectedCount: 0,
                currentIdx: -1,
                pass1Done: true,
                highlightLines: [8, 10, 11],
                stepText: 'Pass 1 å®Œæˆï¼é–‹å§‹ Pass 2',
                explanation: {
                    title: 'Pass 1 å®Œæˆ',
                    text: `å·²å»ºç«‹å…¨éƒ¨ ${n} å€‹è¤‡è£½ç¯€é»<br>HashMap å¤§å° = ${n}<br><br>æ¥ä¸‹ä¾†åˆ©ç”¨ HashMap é€£æ¥ next å’Œ random`,
                    formula: 'HashMap ready for pointer lookup'
                }
            });

            // Pass 2: é€£æ¥æŒ‡æ¨™
            for (let i = 0; i < n; i++) {
                const node = nodes[i];
                const nextIdx = i < n - 1 ? i + 1 : 'null';
                const nextVal = i < n - 1 ? nodes[i + 1].val : 'null';
                const randomIdx = node.random;
                const randomVal = randomIdx !== null ? nodes[randomIdx].val : 'null';

                steps.push({
                    phase: 2,
                    createdCount: n,
                    connectedCount: i + 1,
                    currentIdx: i,
                    highlightLines: [12, 13, 14, 15],
                    stepText: `new_${i}->next = new_${nextIdx}; new_${i}->random = new_${randomIdx !== null ? randomIdx : 'null'}`,
                    explanation: {
                        title: `Pass 2: é€£æ¥ç¯€é» ${i} çš„æŒ‡æ¨™`,
                        text: `<code>oldToNew[old_${i}]->next = oldToNew[old_${nextIdx}]</code><br>â†’ new_${i}.next = new_${nextIdx} (${nextVal})<br><br><code>oldToNew[old_${i}]->random = oldToNew[old_${randomIdx !== null ? randomIdx : 'null'}]</code><br>â†’ new_${i}.random = new_${randomIdx !== null ? randomIdx : 'null'} (${randomVal})`,
                        formula: `nextâ†’${nextVal}, randomâ†’${randomVal}`
                    }
                });
            }

            // å®Œæˆ
            steps.push({
                phase: 3,
                createdCount: n,
                connectedCount: n,
                currentIdx: -1,
                final: true,
                highlightLines: [17],
                stepText: 'return oldToNew[head]',
                explanation: {
                    title: 'ğŸ‰ æ·±æ‹·è²å®Œæˆï¼',
                    text: `æˆåŠŸè¤‡è£½æ•´å€‹éˆè¡¨ï¼ŒåŒ…å«æ‰€æœ‰ random æŒ‡æ¨™<br><br>Time: O(n) - å…©æ¬¡éæ­·<br>Space: O(n) - HashMap ç©ºé–“`,
                    formula: 'return oldToNew[head]'
                }
            });

            return steps;
        }

        function renderStep(step) {
            const container = document.getElementById('listsContainer');
            const n = currentNodes.length;

            // æ›´æ–° Phase indicators
            ['phase1', 'phase2'].forEach((id, i) => {
                const el = document.getElementById(id);
                el.classList.remove('active', 'done');
                if (step.phase === i + 1) el.classList.add('active');
                else if (step.phase > i + 1 || step.final) el.classList.add('done');
            });

            let html = '<svg id="mappingSvg" style="position: absolute; width: 100%; height: 100%; pointer-events: none;"></svg>';

            // åŸå§‹éˆè¡¨
            html += '<div class="list-section"><span class="list-label original">Original</span><div class="nodes-row">';
            currentNodes.forEach((node, i) => {
                let cls = 'node original';
                if (step.currentIdx === i) cls += ' active';
                const randomLabel = node.random !== null ? `â†—${node.random}` : 'â†—âˆ…';

                html += '<div class="node-wrapper">';
                html += `<div class="node-index">[${i}]</div>`;
                html += `<div class="${cls}"><span class="val">${node.val}</span><span class="random-indicator">${randomLabel}</span></div>`;
                if (i < n - 1) html += `<div class="next-link">${createArrowSVG('#64748b')}</div>`;
                html += '</div>';
            });
            html += '</div></div>';

            // è¤‡è£½éˆè¡¨
            const showCopy = step.createdCount > 0;
            if (showCopy) {
                html += '<div class="list-section"><span class="list-label copy">Copy</span><div class="nodes-row">';
                for (let i = 0; i < n; i++) {
                    const node = currentNodes[i];
                    const isCreated = i < step.createdCount;
                    const isConnected = step.phase >= 2 && i < step.connectedCount;
                    let cls = 'node copy';
                    if (!isCreated) cls += ' pending';
                    if (step.currentIdx === i && step.phase === 2) cls += ' active';

                    const randomLabel = isConnected && node.random !== null ? `â†—${node.random}` : 'â†—?';

                    html += '<div class="node-wrapper">';
                    html += `<div class="node-index">[${i}']</div>`;
                    html += `<div class="${cls}"><span class="val">${isCreated ? node.val + "'" : '?'}</span><span class="random-indicator">${isCreated ? randomLabel : ''}</span></div>`;
                    if (i < n - 1 && isCreated) {
                        const nextConnected = isConnected && i + 1 <= step.connectedCount;
                        html += `<div class="next-link">${createArrowSVG(nextConnected ? '#22c55e' : '#475569')}</div>`;
                    } else if (i < n - 1) {
                        html += '<div class="next-link" style="opacity: 0.3;">' + createArrowSVG('#475569') + '</div>';
                    }
                    html += '</div>';
                }
                html += '</div></div>';
            }

            container.innerHTML = html;

            // æ›´æ–° HashMap é¡¯ç¤º
            let mapHtml = '';
            for (let i = 0; i < step.createdCount; i++) {
                const isActive = step.currentIdx === i;
                mapHtml += `<div class="hashmap-entry ${isActive ? 'active' : ''}">
                    <span class="old-node">old_${i}</span>
                    <span class="arrow">â†’</span>
                    <span class="new-node">new_${i}</span>
                </div>`;
            }
            document.getElementById('hashmapEntries').innerHTML = mapHtml || '<span style="color: #64748b;">ç©º</span>';

            // Step breakdown
            document.getElementById('stepBreakdown').innerHTML = step.stepText || '';
        }

        function init(nodes = currentNodes) {
            currentNodes = nodes;
            viz = new AlgorithmVisualizer({
                codeLines: codeStructure,
                onStepChange: (step) => renderStep(step)
            });
            viz.setSteps(generateAlgorithmSteps(nodes));
        }

        function runCustomInput() {
            const values = document.getElementById('customValues').value.split(',').map(s => parseInt(s.trim())).filter(x => !isNaN(x));
            const randoms = document.getElementById('customRandoms').value.split(',').map(s => parseInt(s.trim()));

            if (values.length < 1 || values.length > 8) {
                alert('è«‹è¼¸å…¥ 1-8 å€‹ç¯€é»');
                return;
            }

            const nodes = values.map((val, i) => ({
                val,
                random: randoms[i] >= 0 && randoms[i] < values.length ? randoms[i] : null
            }));
            init(nodes);
        }

        function resetVisualization() { init(currentNodes); }
        window.addEventListener('load', () => init());
    </script>
</body>
</html>
