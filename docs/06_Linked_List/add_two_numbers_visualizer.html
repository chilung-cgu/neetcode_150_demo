<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Two Numbers - D3 ç²¾ç·»è¦–è¦ºåŒ–</title>
    <link rel="stylesheet" href="../assets/visualizer/style.css">
    <style>
        .visualization-area {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 50%, #1e293b 100%);
            border-radius: 16px;
            padding: 20px;
            margin: 15px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 500px;
        }
        
        #viz-svg { width: 100%; height: 400px; }

        .node-circle { stroke-width: 3px; transition: all 0.3s; fill: #334155; stroke: #64748b; }
        .node-circle.l1 { fill: #3b82f6; stroke: #2563eb; }
        .node-circle.l2 { fill: #a855f7; stroke: #9333ea; }
        .node-circle.res { fill: #22c55e; stroke: #16a34a; }
        .node-circle.carry { fill: #f97316; stroke: #c2410c; stroke-width: 0; }
        
        .node-text { fill: white; font-weight: bold; font-family: monospace; font-size: 14px; text-anchor: middle; dominant-baseline: middle; pointer-events: none; }
        .carry-text { fill: white; font-size: 10px; font-weight: bold; }

        .link { fill: none; stroke: #64748b; stroke-width: 2px; marker-end: url(#arrow); transition: all 0.5s; opacity: 0.6; }
        
        /* Math Panel */
        .math-box { 
            background: rgba(15, 23, 42, 0.8); border: 1px solid #475569; border-radius: 8px; 
            padding: 10px; display: flex; gap: 10px; font-family: monospace; font-size: 1.2em; color: white;
            align-items: center; justify-content: center; min-width: 200px; min-height: 40px;
        }
        .digit-l1 { color: #60a5fa; }
        .digit-l2 { color: #a855f7; }
        .digit-carry { color: #f97316; }
        .digit-sum { color: #22c55e; }

        /* Controls */
        .custom-input-section { background: var(--viz-card-bg); border-radius: 8px; padding: 15px; border: 1px solid var(--viz-border); }
        .input-row { display: flex; gap: 10px; align-items: center; }
        .input-row input { padding: 8px; border-radius: 6px; border: 1px solid var(--viz-border); background: var(--viz-input-bg); color: var(--viz-text); font-family: monospace; width: 100px; }
        .input-row button { padding: 8px 16px; border-radius: 6px; background: var(--viz-primary); color: white; border: none; cursor: pointer; }

        .step-breakdown { background: rgba(30, 41, 59, 0.6); border-radius: 12px; border-left: 4px solid #3b82f6; padding: 15px 20px; margin-top: 15px; width: 100%; box-sizing: border-box; }
    </style>
</head>
<body>
    <button class="theme-toggle" onclick="AlgorithmVisualizer.toggleTheme()" title="åˆ‡æ›ä¸»é¡Œ">ğŸŒ“</button>
    <div class="main-layout">
        <div class="canvas-area">
            <div class="viz-card">
                <div class="viz-title">Add Two Numbers (Reverse Order)</div>
                <div class="custom-input-section">
                    <div class="input-row">
                        <label>Num 1:</label>
                        <input type="number" id="n1Input" value="342">
                        <label>Num 2:</label>
                        <input type="number" id="n2Input" value="465">
                        <button onclick="runVisualizer()">ç›¸åŠ </button>
                    </div>
                    <div style="font-size:0.8rem; color:#64748b; margin-top:5px;">* è¼¸å…¥ 342 ä»£è¡¨ 2 -> 4 -> 3</div>
                </div>

                <div class="visualization-area">
                    <div class="math-box" id="mathDisplay">
                        <span style="opacity:0.5">Wait to start...</span>
                    </div>
                    <svg id="viz-svg">
                        <defs>
                            <marker id="arrow" markerWidth="10" markerHeight="10" refX="22" refY="3" orient="auto">
                                <path d="M0,0 L0,6 L9,3 z" fill="#64748b" />
                            </marker>
                        </defs>
                        <g id="main-group" transform="translate(50, 50)"></g>
                        <g id="carry-group" transform="translate(50, 50)"></g>
                    </svg>
                </div>

                <div class="step-breakdown">
                    <div style="font-size:0.75rem; font-weight:bold; color:#64748b;">ç•¶å‰æ­¥é©Ÿ</div>
                    <div id="stepText" style="font-size:0.95rem; font-family:monospace; color:#e2e8f0;">Ready.</div>
                </div>

                <div class="controls" style="margin-top: 15px;">
                    <button class="viz-btn" id="prevBtn">â† ä¸Šä¸€æ­¥</button>
                    <div class="step-indicator">æ­¥é©Ÿ <span id="currentStep">0</span> / <span id="totalSteps">0</span></div>
                    <button class="viz-btn primary" id="nextBtn">ä¸‹ä¸€æ­¥ â†’</button>
                    <button class="viz-btn" onclick="runVisualizer()">â†» é‡ç½®</button>
                    <button class="viz-btn play-btn" id="playBtn" onclick="viz.toggleAutoPlay()">â–¶ è‡ªå‹•æ’­æ”¾</button>
                    <div class="speed-control">
                        <label>é€Ÿåº¦:</label>
                        <select id="speedSelect" onchange="viz.setSpeed(Number(this.value))">
                            <option value="1500">0.5x</option>
                            <option value="1000" selected>1x</option>
                            <option value="500">1.5x</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="viz-card"><div class="viz-title">é‚è¼¯è§£é‡‹</div><div class="explanation" id="explanation"></div></div>
        </div>
        <div class="code-area">
            <div class="viz-card" style="height: 100%;">
                <div class="viz-title">C++ Code</div>
                <div class="code-panel" id="codeDisplay"></div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="../assets/visualizer/core.js"></script>
    <script>
        const codeStructure = [
            { line: 'ListNode* addTwoNumbers(l1, l2) {', id: 0 },
            { line: '    ListNode dummy(0);', id: 1 },
            { line: '    ListNode* curr = &dummy;', id: 2 },
            { line: '    int carry = 0;', id: 3 },
            { line: '    while(l1 || l2 || carry) {', id: 4 },
            { line: '        int v1 = l1 ? l1->val : 0;', id: 5 },
            { line: '        int v2 = l2 ? l2->val : 0;', id: 6 },
            { line: '        int sum = v1 + v2 + carry;', id: 7 },
            { line: '        carry = sum / 10;', id: 8 },
            { line: '        curr->next = new ListNode(sum % 10);', id: 9 },
            { line: '        curr = curr->next;', id: 10 },
            { line: '        if(l1) l1 = l1->next;', id: 11 },
            { line: '        if(l2) l2 = l2->next;', id: 12 },
            { line: '    }', id: 13 },
            { line: '    return dummy.next;', id: 14 },
            { line: '}', id: 15 }
        ];

        let viz;

        function simulate(n1Str, n2Str) {
            const steps = [];
            // Convert numbers to reversed digit arrays
            // 342 -> [2, 4, 3]
            const arr1 = n1Str.split('').reverse().map(d=>parseInt(d));
            const arr2 = n2Str.split('').reverse().map(d=>parseInt(d));
            
            // Build base nodes
            const nodes1 = arr1.map((v, i) => ({id: `l1-${i}`, val: v, type: 'l1', idx: i}));
            const nodes2 = arr2.map((v, i) => ({id: `l2-${i}`, val: v, type: 'l2', idx: i}));
            
            const resNodes = [];
            let dummy = {id: 'dummy', val: 0, type: 'dummy'};
            // Track pointer indices
            let ptr1 = 0;
            let ptr2 = 0;
            let carry = 0;
            
            const pushState = (msg, hl, active={v1:0, v2:0, sum:0, carry:0}, explanation=null) => {
                steps.push({
                    nodes1: JSON.parse(JSON.stringify(nodes1)),
                    nodes2: JSON.parse(JSON.stringify(nodes2)),
                    resNodes: JSON.parse(JSON.stringify(resNodes)),
                    ptr1, ptr2, carry,
                    mathState: active,
                    msg, highlightLines: hl,
                    explanation
                });
            };

            pushState("Init: Pointers at head, carry=0", [1, 2, 3], {v1:0,v2:0,sum:0,carry:0}, {
                title: 'åˆå§‹åŒ–',
                text: 'åˆå§‹åŒ–å…©å€‹æŒ‡é‡åˆ†åˆ¥æŒ‡å‘å…©å€‹éˆè¡¨çš„é ­éƒ¨ (å€‹ä½æ•¸)ï¼Œé€²ä½ (carry) ç‚º 0ã€‚',
                formula: 'carry = 0'
            });

            while(ptr1 < nodes1.length || ptr2 < nodes2.length || carry > 0) {
                const v1 = ptr1 < nodes1.length ? nodes1[ptr1].val : 0;
                const v2 = ptr2 < nodes2.length ? nodes2[ptr2].val : 0;
                
                pushState(`Read digits: ${v1} and ${v2}`, [5, 6], {v1, v2, sum: '?', carry}, {
                    title: 'è®€å–ä½æ•¸',
                    text: `å¾ L1 è®€å– ${v1}ï¼Œå¾ L2 è®€å– ${v2}ã€‚å¦‚æœéˆè¡¨å·²ç©ºå‰‡è¦–ç‚º 0ã€‚`,
                    formula: `v1=${v1}, v2=${v2}`
                });

                const sum = v1 + v2 + carry;
                
                pushState(`Calculate Sum: ${v1} + ${v2} + ${carry} = ${sum}`, [7], {v1, v2, sum, carry}, {
                    title: 'è¨ˆç®—ç¸½å’Œ',
                    text: `ç¸½å’Œ = v1 + v2 + carryã€‚<br>${v1} + ${v2} + ${carry} = ${sum}`,
                    formula: `sum = ${sum}`
                });

                const newCarry = Math.floor(sum / 10);
                const digit = sum % 10;
                
                const prevSum = sum;
                
                pushState(`New Digit: ${sum}%10 = ${digit}, Carry: ${sum}/10 = ${newCarry}`, [8, 9], {v1, v2, sum: prevSum, carry, digit, newCarry}, {
                    title: 'è¨ˆç®—é€²ä½èˆ‡çµæœä½',
                    text: `çµæœä½ = ç¸½å’Œ % 10 = ${digit}ã€‚<br>æ–°é€²ä½ = ç¸½å’Œ / 10 = ${newCarry}ã€‚`,
                    formula: `digit=${digit}, carry=${newCarry}`
                });

                // Add node
                resNodes.push({id: `res-${resNodes.length}`, val: digit, type: 'res', idx: resNodes.length});
                carry = newCarry;
                
                pushState(`Append ${digit} to result`, [9, 10], {v1, v2, sum: prevSum, carry, digit, newCarry}, {
                        title: 'æ·»åŠ çµæœç¯€é»',
                        text: `å°‡ ${digit} åŠ å…¥çµæœéˆè¡¨ï¼Œä¸¦ç§»å‹• curr æŒ‡é‡ã€‚æº–å‚™è™•ç†ä¸‹ä¸€ä½ã€‚`,
                        formula: 'curr->next = new Node(sum % 10)'
                });

                if(ptr1 < nodes1.length) ptr1++;
                if(ptr2 < nodes2.length) ptr2++;
            }

            pushState("Done", [14], {v1:0,v2:0,sum:0,carry:0}, {
                title: 'å®Œæˆ',
                text: 'æ‰€æœ‰ä½æ•¸åŠé€²ä½è™•ç†å®Œç•¢ï¼Œè¿”å›çµæœéˆè¡¨ã€‚',
                formula: 'return dummy.next'
            });

            return steps;
        }

        const svg = d3.select("#viz-svg");
        const gMain = d3.select("#main-group");
        const gCarry = d3.select("#carry-group");

        function render(step) {
            document.getElementById('stepText').textContent = step.msg;
            
            // Math Display
            const m = step.mathState;
            let mathHtml = ``;
            if (m.sum !== undefined) {
               mathHtml += `<span class="digit-l1">${m.v1}</span> + <span class="digit-l2">${m.v2}</span>`;
               if(m.carry !== undefined) mathHtml += ` + <span class="digit-carry">(${m.carry})</span>`;
               mathHtml += ` = <span class="digit-sum">${m.sum}</span>`;
            }
            document.getElementById('mathDisplay').innerHTML = mathHtml;

            const SPACING = 70;
            const START_X = 50;
            
            const allNodes = [];
            
            // Layout L1 (Top)
            step.nodes1.forEach(n => {
                allNodes.push({ ...n, x: START_X + n.idx * SPACING, y: 0 });
            });
            // Layout L2 (Middle)
            step.nodes2.forEach(n => {
                allNodes.push({ ...n, x: START_X + n.idx * SPACING, y: 100 });
            });
            // Layout Res (Bottom)
            step.resNodes.forEach(n => {
                allNodes.push({ ...n, x: START_X + n.idx * SPACING, y: 200 });
            });

            // Links (Separate chains)
            const links = [];
            // L1 chain
            for(let i=0; i<step.nodes1.length-1; i++) links.push({s: step.nodes1[i].id, t: step.nodes1[i+1].id});
            for(let i=0; i<step.nodes2.length-1; i++) links.push({s: step.nodes2[i].id, t: step.nodes2[i+1].id});
            for(let i=0; i<step.resNodes.length-1; i++) links.push({s: step.resNodes[i].id, t: step.resNodes[i+1].id});
            
            // Helper map
            const nodeMap = new Map(allNodes.map(n => [n.id, n]));

            const lSel = gMain.selectAll(".link").data(links);
            lSel.enter().append("path").attr("class", "link")
                .merge(lSel)
                .transition().duration(500)
                .attr("d", d => {
                    const s = nodeMap.get(d.s);
                    const t = nodeMap.get(d.t);
                    return `M ${s.x},${s.y} L ${t.x},${t.y}`;
                });
            lSel.exit().remove();

            // Nodes
            const nSel = gMain.selectAll(".node-g").data(allNodes, d => d.id);
            const nEnter = nSel.enter().append("g").attr("class", "node-g");
            nEnter.append("circle").attr("r", 20).attr("class", "node-circle");
            nEnter.append("text").attr("class", "node-text").attr("dy", 1);
            
            // Labels for rows
            if(step.nodes1.length>0 && !window.labelsDrawn) {
                // Drawing labels dynamically in Enter is tricky if data updates.
                // Just keep static if possible.
            }

            const nUpdate = nSel.merge(nEnter).transition().duration(500)
                .attr("transform", d => `translate(${d.x}, ${d.y})`);
                
            nUpdate.select("circle").attr("class", d => {
                let c = "node-circle";
                if(d.type === 'l1') c+= " l1";
                if(d.type === 'l2') c+= " l2";
                if(d.type === 'res') c+= " res";
                
                // Highlight active processing
                if((d.type==='l1' && d.idx === step.ptr1) || (d.type==='l2' && d.idx === step.ptr2)) {
                    // Could add highlight class...
                }
                return c;
            })
            // Highlight stroke width for active
            .style("stroke-width", d => {
               if((d.type==='l1' && d.idx === step.ptr1) || (d.type==='l2' && d.idx === step.ptr2)) return 5;
               return 3; 
            });

            nUpdate.select("text").text(d => d.val);
            nSel.exit().remove();
            
            // Carry Bubble Visualization
            // Position carry above next calculation point
            // Next calculation is at max(ptr1, ptr2)
            const nextIdx = Math.max(step.ptr1, step.ptr2); // rough visual position
            // But carry propagates to next slot.
            // step.carry is the carry to be used for [ptr1, ptr2].
            // Wait, step.carry AFTER calculation (at end of loop) is for next iteration.
            
            // Just draw carry if > 0
            gCarry.selectAll("*").remove();
            if(step.carry > 0) {
                const cx = START_X + nextIdx * SPACING;
                const cy = -30; // Above L1
                gCarry.append("circle").attr("cx", cx).attr("cy", cy).attr("r", 12).attr("class", "node-circle carry");
                gCarry.append("text").attr("x", cx).attr("y", cy).attr("dy", 4).text(step.carry).attr("class", "carry-text").attr("text-anchor", "middle");
                gCarry.append("text").attr("x", cx).attr("y", cy-15).text("Carry").attr("fill", "#f97316").attr("font-size", "10px").attr("text-anchor", "middle");
            }
        }

        function runVisualizer() {
            const v1 = document.getElementById('n1Input').value;
            const v2 = document.getElementById('n2Input').value;
            
            viz = new AlgorithmVisualizer({
                codeLines: codeStructure,
                onStepChange: render
            });
            viz.setSteps(simulate(v1, v2));
        }

        window.addEventListener('load', runVisualizer);
    </script>
</body>
</html>
