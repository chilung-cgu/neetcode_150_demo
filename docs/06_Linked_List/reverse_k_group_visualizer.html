<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reverse Nodes in K-Group - ç²¾ç·»è¦–è¦ºåŒ–</title>
    <link rel="stylesheet" href="../assets/visualizer/style.css">
    <style>
        /* ========== é«˜ç²¾ç·»åº¦ Linked List è¦–è¦ºåŒ–æ¨£å¼ ========== */
        
        /* ä¸»è¦–è¦ºåŒ–å€å®¹å™¨ */
        .visualization-area {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 50%, #1e293b 100%);
            border-radius: 16px;
            padding: 30px 20px;
            margin: 15px 0;
            position: relative;
            overflow: hidden;
        }

        .visualization-area::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(ellipse at center, rgba(59, 130, 246, 0.08) 0%, transparent 70%);
            pointer-events: none;
        }

        /* Linked List å®¹å™¨ */
        .linked-list-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 1;
        }

        /* ç¯€é»è¡Œ */
        .nodes-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0;
            padding: 40px 20px 20px;
        }

        /* ç¯€é»å¤–åŒ…è£ */
        .node-wrapper {
            display: flex;
            align-items: center;
            position: relative;
        }

        /* åœ“å½¢ç¯€é» - Gemini é¢¨æ ¼ */
        .node {
            width: 56px;
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.3rem;
            border-radius: 50%;
            background: linear-gradient(145deg, #3b82f6, #2563eb);
            color: white;
            position: relative;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3),
                        inset 0 2px 4px rgba(255, 255, 255, 0.1);
            border: 3px solid transparent;
        }

        /* Dummy ç¯€é»ç‰¹æ®Šæ¨£å¼ */
        .node.dummy {
            background: linear-gradient(145deg, #475569, #334155);
            box-shadow: 0 4px 15px rgba(71, 85, 105, 0.3);
            font-size: 0.85rem;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        /* ç¯€é»ä¸Šæ–¹æ¨™ç±¤ */
        .node-label {
            position: absolute;
            top: -28px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #94a3b8;
            white-space: nowrap;
        }

        .node.dummy .node-label {
            color: #94a3b8;
        }

        /* ç¾¤çµ„é¡è‰² */
        .node.group-a {
            background: linear-gradient(145deg, #22c55e, #16a34a);
            box-shadow: 0 4px 15px rgba(34, 197, 94, 0.4);
        }

        .node.group-b {
            background: linear-gradient(145deg, #8b5cf6, #7c3aed);
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
        }

        .node.remaining {
            background: linear-gradient(145deg, #64748b, #475569);
            box-shadow: 0 4px 15px rgba(100, 116, 139, 0.3);
        }

        /* ç•¶å‰æ“ä½œç¯€é» - ç™¼å…‰æ•ˆæœ */
        .node.active {
            border-color: #fbbf24;
            box-shadow: 0 0 25px rgba(251, 191, 36, 0.6),
                        0 0 50px rgba(251, 191, 36, 0.3),
                        inset 0 2px 4px rgba(255, 255, 255, 0.2);
            transform: scale(1.08);
        }

        .node.reversing {
            animation: glow-pulse 0.6s ease-in-out infinite alternate;
        }

        @keyframes glow-pulse {
            from {
                box-shadow: 0 0 25px rgba(239, 68, 68, 0.6),
                            0 0 50px rgba(239, 68, 68, 0.3);
            }
            to {
                box-shadow: 0 0 35px rgba(239, 68, 68, 0.8),
                            0 0 70px rgba(239, 68, 68, 0.4);
                transform: scale(1.12);
            }
        }

        /* é€£æ¥ç·š - æ›²ç·šç®­é ­ */
        .link {
            width: 40px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .link svg {
            width: 40px;
            height: 24px;
        }

        .link .arrow-line {
            stroke: #64748b;
            stroke-width: 2;
            fill: none;
            transition: all 0.3s ease;
        }

        .link .arrow-head {
            fill: #64748b;
            transition: all 0.3s ease;
        }

        .link.reversed .arrow-line {
            stroke: #22c55e;
        }

        .link.reversed .arrow-head {
            fill: #22c55e;
        }

        .link.reversing .arrow-line {
            stroke: #ef4444;
            animation: link-flash 0.3s ease-in-out infinite alternate;
        }

        .link.reversing .arrow-head {
            fill: #ef4444;
        }

        @keyframes link-flash {
            from { opacity: 1; }
            to { opacity: 0.5; }
        }

        .link.null {
            width: 70px;
        }

        .link.null::after {
            content: 'null';
            position: absolute;
            right: 0;
            font-size: 0.8rem;
            color: #64748b;
            font-style: italic;
        }

        /* Pointer æ¨™ç±¤ - æµ®å‹•åœ¨ä¸Šæ–¹ */
        .pointer-indicators {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .pointer-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            opacity: 0.5;
            transition: all 0.3s ease;
        }

        .pointer-indicator.active {
            opacity: 1;
        }

        .pointer-indicator.groupPrev {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .pointer-indicator.kth {
            background: rgba(168, 85, 247, 0.2);
            color: #a855f7;
            border: 1px solid rgba(168, 85, 247, 0.3);
        }

        .pointer-indicator.curr {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
            border: 1px solid rgba(251, 191, 36, 0.3);
        }

        .pointer-indicator.prev {
            background: rgba(249, 115, 22, 0.2);
            color: #f97316;
            border: 1px solid rgba(249, 115, 22, 0.3);
        }

        .pointer-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .pointer-indicator.groupPrev .pointer-dot { background: #22c55e; }
        .pointer-indicator.kth .pointer-dot { background: #a855f7; }
        .pointer-indicator.curr .pointer-dot { background: #fbbf24; }
        .pointer-indicator.prev .pointer-dot { background: #f97316; }

        /* ç¯€é»ä¸‹æ–¹çš„ pointer åç¨±æ¨™ç±¤ */
        .node-pointer-label {
            position: absolute;
            bottom: -24px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.65rem;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 4px;
            white-space: nowrap;
        }

        .node-pointer-label.groupPrev {
            background: #22c55e;
            color: #0f172a;
        }

        .node-pointer-label.kth {
            background: #a855f7;
            color: white;
        }

        .node-pointer-label.curr {
            background: #fbbf24;
            color: #0f172a;
        }

        .node-pointer-label.prev {
            background: #f97316;
            color: white;
        }

        /* åœ–ä¾‹ - Gemini é¢¨æ ¼ */
        .legend-bar {
            display: flex;
            justify-content: center;
            gap: 25px;
            padding: 15px;
            background: rgba(30, 41, 59, 0.5);
            border-radius: 12px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8rem;
            color: #94a3b8;
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .legend-dot.node { background: linear-gradient(145deg, #3b82f6, #2563eb); }
        .legend-dot.group-prev { background: linear-gradient(145deg, #22c55e, #16a34a); }
        .legend-dot.current-group { 
            background: #fbbf24; 
            box-shadow: 0 0 8px rgba(251, 191, 36, 0.6);
        }
        .legend-dot.next-pointer { background: linear-gradient(145deg, #8b5cf6, #7c3aed); }

        /* Step Breakdown å€åŸŸ */
        .step-breakdown {
            background: rgba(30, 41, 59, 0.6);
            border-radius: 12px;
            padding: 15px 20px;
            margin-top: 15px;
            border-left: 4px solid #3b82f6;
        }

        .step-breakdown-title {
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #64748b;
            margin-bottom: 8px;
        }

        .step-breakdown-text {
            font-size: 0.95rem;
            color: #e2e8f0;
            line-height: 1.5;
        }

        .step-breakdown-text code {
            background: rgba(59, 130, 246, 0.2);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Consolas', monospace;
            color: #60a5fa;
        }

        /* è‡ªè¨‚è¼¸å…¥å€ */
        .custom-input-section {
            background: var(--viz-card-bg);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid var(--viz-border);
        }

        .input-title { font-weight: bold; margin-bottom: 10px; color: var(--viz-text); }
        .input-row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .input-row input {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid var(--viz-border);
            background: var(--viz-input-bg);
            color: var(--viz-text);
            font-family: monospace;
        }
        .input-row button {
            padding: 8px 16px;
            border-radius: 6px;
            background: var(--viz-primary);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        .input-row button:hover { 
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }
        .input-hint { font-size: 0.8rem; color: var(--viz-text-muted); margin-top: 5px; }

        /* ç‹€æ…‹é¢æ¿ */
        .pointer-state-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 15px;
            padding: 12px;
            background: var(--viz-bg-secondary);
            border-radius: 8px;
        }

        .pointer-state {
            text-align: center;
            padding: 8px;
            border-radius: 6px;
        }

        .pointer-state .label {
            font-size: 0.7rem;
            color: var(--viz-text-muted);
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .pointer-state .value {
            font-weight: bold;
            font-family: 'Consolas', monospace;
            font-size: 1.1rem;
        }

        .pointer-state.groupPrev { background: rgba(34, 197, 94, 0.1); }
        .pointer-state.groupPrev .value { color: #22c55e; }
        .pointer-state.kth { background: rgba(168, 85, 247, 0.1); }
        .pointer-state.kth .value { color: #a855f7; }
        .pointer-state.curr { background: rgba(251, 191, 36, 0.1); }
        .pointer-state.curr .value { color: #fbbf24; }
        .pointer-state.prev { background: rgba(249, 115, 22, 0.1); }
        .pointer-state.prev .value { color: #f97316; }

        /* ç¨‹å¼ç¢¼é«˜äº®å¢å¼· */
        .code-line.active {
            background: rgba(251, 191, 36, 0.15) !important;
            border-left: 3px solid #fbbf24 !important;
        }
    </style>
</head>
<body>
    <button class="theme-toggle" onclick="AlgorithmVisualizer.toggleTheme()" title="åˆ‡æ›ä¸»é¡Œ">ğŸŒ“</button>
    <div class="main-layout">
        <div class="canvas-area">
            <div class="viz-card">
                <div class="viz-title">K å€‹ä¸€çµ„ç¿»è½‰éˆè¡¨ - Pointer è¦–è¦ºåŒ–</div>

                <div class="custom-input-section">
                    <div class="input-title">ğŸ® è‡ªè¨‚æ¸¬è©¦</div>
                    <div class="input-row">
                        <input type="text" id="customList" placeholder="ç¯€é»å€¼" value="1,2,3,4,5" style="width: 150px;">
                        <label>k =</label>
                        <input type="number" id="customK" value="2" min="1" style="width: 60px;">
                        <button onclick="runCustomInput()">åŸ·è¡Œ</button>
                    </div>
                    <div class="input-hint">æ¯ k å€‹ç¯€é»ç¿»è½‰ä¸€æ¬¡ï¼Œä¸è¶³ k å€‹çš„ä¿æŒåŸæ¨£</div>
                </div>

                <!-- ä¸»è¦–è¦ºåŒ–å€åŸŸ - Gemini é¢¨æ ¼ -->
                <div class="visualization-area">
                    <div class="linked-list-container">
                        <div class="pointer-indicators" id="pointerIndicators">
                            <div class="pointer-indicator groupPrev"><div class="pointer-dot"></div>Group Prev</div>
                            <div class="pointer-indicator kth"><div class="pointer-dot"></div>Kth</div>
                            <div class="pointer-indicator curr"><div class="pointer-dot"></div>Current</div>
                            <div class="pointer-indicator prev"><div class="pointer-dot"></div>Prev</div>
                        </div>
                        <div class="nodes-row" id="nodesRow"></div>
                    </div>

                    <div class="legend-bar">
                        <div class="legend-item"><div class="legend-dot node"></div>Node</div>
                        <div class="legend-item"><div class="legend-dot group-prev"></div>Group Prev</div>
                        <div class="legend-item"><div class="legend-dot current-group"></div>Current Group</div>
                        <div class="legend-item"><div class="legend-dot next-pointer"></div>Next Pointer</div>
                    </div>
                </div>

                <div class="step-breakdown">
                    <div class="step-breakdown-title">Step Breakdown</div>
                    <div class="step-breakdown-text" id="stepBreakdown">é»æ“Šã€Œä¸‹ä¸€æ­¥ã€é–‹å§‹æ¼”ç®—æ³•</div>
                </div>

                <div class="pointer-state-panel">
                    <div class="pointer-state groupPrev">
                        <div class="label">groupPrev</div>
                        <div class="value" id="groupPrevVal">dummy</div>
                    </div>
                    <div class="pointer-state kth">
                        <div class="label">kth</div>
                        <div class="value" id="kthVal">-</div>
                    </div>
                    <div class="pointer-state prev">
                        <div class="label">prev</div>
                        <div class="value" id="prevVal">-</div>
                    </div>
                    <div class="pointer-state curr">
                        <div class="label">curr</div>
                        <div class="value" id="currVal">-</div>
                    </div>
                </div>

                <div class="controls" style="margin-top: 15px;">
                    <button class="viz-btn" id="prevBtn">â† ä¸Šä¸€æ­¥</button>
                    <div class="step-indicator">æ­¥é©Ÿ <span id="currentStep">0</span> / <span id="totalSteps">0</span></div>
                    <button class="viz-btn primary" id="nextBtn">ä¸‹ä¸€æ­¥ â†’</button>
                    <button class="viz-btn" onclick="resetVisualization()">â†» é‡ç½®</button>
                    <button class="viz-btn play-btn" id="playBtn" onclick="viz.toggleAutoPlay()">â–¶ è‡ªå‹•æ’­æ”¾</button>
                    <div class="speed-control">
                        <label>é€Ÿåº¦:</label>
                        <select id="speedSelect" onchange="viz.setSpeed(Number(this.value))">
                            <option value="2000">0.5x</option>
                            <option value="1500" selected>1x</option>
                            <option value="1000">1.5x</option>
                            <option value="500">2x</option>
                        </select>
                    </div>
                </div>

                <div class="complexity-badge">
                    <span class="label">Time:</span> O(n)
                    <span class="label" style="margin-left: 12px;">Space:</span> O(1)
                </div>
            </div>

            <div class="viz-card">
                <div class="viz-title">æ¼”ç®—æ³•èªªæ˜</div>
                <div class="explanation" id="explanation"></div>
            </div>
        </div>

        <div class="code-area">
            <div class="viz-card" style="height: 100%;">
                <div class="viz-title">æ¼”ç®—æ³• (C++)</div>
                <div class="code-panel" id="codeDisplay"></div>
            </div>
        </div>
    </div>

    <script src="../assets/visualizer/core.js"></script>
    <script>
        // ========== ç¨‹å¼ç¢¼çµæ§‹ ==========
        const codeStructure = [
            { line: 'ListNode* reverseKGroup(ListNode* head, int k) {', id: 0 },
            { line: '    ListNode dummy(0); dummy.next = head;', id: 1 },
            { line: '    ListNode* groupPrev = &dummy;', id: 2 },
            { line: '', id: 3 },
            { line: '    while (true) {', id: 4 },
            { line: '        // æ‰¾åˆ°ç¬¬ k å€‹ç¯€é»', id: 5 },
            { line: '        ListNode* kth = getKth(groupPrev, k);', id: 6 },
            { line: '        if (!kth) break;', id: 7 },
            { line: '', id: 8 },
            { line: '        ListNode* groupNext = kth->next;', id: 9 },
            { line: '', id: 10 },
            { line: '        // åè½‰ [groupPrev->next, kth]', id: 11 },
            { line: '        ListNode* prev = groupNext;', id: 12 },
            { line: '        ListNode* curr = groupPrev->next;', id: 13 },
            { line: '        while (curr != groupNext) {', id: 14 },
            { line: '            ListNode* tmp = curr->next;', id: 15 },
            { line: '            curr->next = prev;', id: 16 },
            { line: '            prev = curr;', id: 17 },
            { line: '            curr = tmp;', id: 18 },
            { line: '        }', id: 19 },
            { line: '', id: 20 },
            { line: '        ListNode* tmp = groupPrev->next;', id: 21 },
            { line: '        groupPrev->next = kth;', id: 22 },
            { line: '        groupPrev = tmp;', id: 23 },
            { line: '    }', id: 24 },
            { line: '    return dummy.next;', id: 25 },
            { line: '}', id: 26 },
        ];

        // ========== å…¨åŸŸè®Šæ•¸ ==========
        let currentList = [1, 2, 3, 4, 5];
        let currentK = 2;
        let viz;

        // ========== SVG ç®­é ­ç”Ÿæˆ ==========
        function createArrowSVG(direction = 'forward', state = 'normal') {
            const color = state === 'reversed' ? '#22c55e' : state === 'reversing' ? '#ef4444' : '#64748b';
            const animClass = state === 'reversing' ? 'reversing' : '';
            
            if (direction === 'forward') {
                return `
                    <svg viewBox="0 0 40 24" class="${animClass}">
                        <path class="arrow-line" d="M 5 12 Q 20 12 30 12" style="stroke: ${color}"/>
                        <polygon class="arrow-head" points="30,12 24,8 24,16" style="fill: ${color}"/>
                    </svg>
                `;
            } else {
                return `
                    <svg viewBox="0 0 40 24" class="${animClass}">
                        <path class="arrow-line" d="M 35 12 Q 20 12 10 12" style="stroke: ${color}"/>
                        <polygon class="arrow-head" points="10,12 16,8 16,16" style="fill: ${color}"/>
                    </svg>
                `;
            }
        }

        // ========== ç”¢ç”Ÿæ¼”ç®—æ³•æ­¥é©Ÿï¼ˆç²¾ç´°ç‰ˆï¼‰ ==========
        function generateAlgorithmSteps(list, k) {
            const steps = [];
            const n = list.length;
            const numGroups = Math.floor(n / k);
            const remaining = n % k;

            // ç¯€é»ç‹€æ…‹
            let nodes = list.map((v, i) => ({
                value: v,
                linkDir: 'forward',
                linkState: 'normal',
                groupId: -1
            }));

            // åˆå§‹åŒ–
            steps.push({
                nodes: JSON.parse(JSON.stringify(nodes)),
                pointers: { groupPrev: -1, kth: null, prev: null, curr: null },
                highlightLines: [0, 1, 2],
                stepText: `Initialize dummy node pointing to head.`,
                explanation: {
                    title: 'åˆå§‹åŒ–',
                    text: `å»ºç«‹ <code>dummy</code> ç¯€é»ï¼Œ<code>groupPrev</code> æŒ‡å‘ <code>dummy</code>ã€‚<br><br>éˆè¡¨ï¼šdummy â†’ ${list.join(' â†’ ')} â†’ null<br>k = ${k}`,
                    formula: `å…± ${numGroups} å€‹å®Œæ•´ç¾¤çµ„${remaining > 0 ? `ï¼Œå‰©é¤˜ ${remaining} å€‹ç¯€é»ä¸ç¿»è½‰` : ''}`
                }
            });

            let groupPrevIdx = -1;

            for (let g = 0; g < numGroups; g++) {
                const groupStart = g * k;
                const groupEnd = groupStart + k - 1;

                // æ‰¾ kth
                steps.push({
                    nodes: JSON.parse(JSON.stringify(nodes)),
                    pointers: { groupPrev: groupPrevIdx, kth: groupEnd, prev: null, curr: null },
                    highlightLines: [5, 6],
                    stepText: `Finding kth node: walk ${k} steps from groupPrev.`,
                    explanation: {
                        title: `ç¬¬ ${g + 1} çµ„ï¼šæ‰¾ kth`,
                        text: `å¾ <code>groupPrev</code> é–‹å§‹ï¼Œå‘å‰èµ° ${k} æ­¥æ‰¾åˆ° <code>kth</code>ã€‚<br><br><code>kth</code> æŒ‡å‘ç¯€é» <strong>${list[groupEnd]}</strong>`,
                        formula: `kth = nodes[${groupEnd}] = ${list[groupEnd]}`
                    }
                });

                // æª¢æŸ¥ kth
                steps.push({
                    nodes: JSON.parse(JSON.stringify(nodes)),
                    pointers: { groupPrev: groupPrevIdx, kth: groupEnd, prev: null, curr: null },
                    highlightLines: [7],
                    stepText: `kth = ${list[groupEnd]} â‰  null â†’ continue.`,
                    explanation: {
                        title: `ç¬¬ ${g + 1} çµ„ï¼šæª¢æŸ¥ kth`,
                        text: `<code>kth = ${list[groupEnd]}</code> â‰  nullï¼Œæœ‰è¶³å¤  ${k} å€‹ç¯€é»ã€‚`,
                        formula: `kth = ${list[groupEnd]} âœ“`
                    }
                });

                // è¨­å®š groupNext
                const groupNextIdx = groupEnd < n - 1 ? groupEnd + 1 : null;
                steps.push({
                    nodes: JSON.parse(JSON.stringify(nodes)),
                    pointers: { groupPrev: groupPrevIdx, kth: groupEnd, prev: null, curr: null, groupNext: groupNextIdx },
                    highlightLines: [9],
                    stepText: `groupNext = kth->next = ${groupNextIdx !== null ? list[groupNextIdx] : 'null'}`,
                    explanation: {
                        title: `ç¬¬ ${g + 1} çµ„ï¼šè¨˜ä½ groupNext`,
                        text: `<code>groupNext = kthâ†’next = ${groupNextIdx !== null ? list[groupNextIdx] : 'null'}</code>`,
                        formula: `groupNext = ${groupNextIdx !== null ? list[groupNextIdx] : 'null'}`
                    }
                });

                // åˆå§‹åŒ–åè½‰
                steps.push({
                    nodes: JSON.parse(JSON.stringify(nodes)),
                    pointers: { groupPrev: groupPrevIdx, kth: groupEnd, prev: groupNextIdx, curr: groupStart },
                    highlightLines: [12, 13],
                    stepText: `Initialize: prev = groupNext, curr = groupPrev->next`,
                    explanation: {
                        title: `ç¬¬ ${g + 1} çµ„ï¼šé–‹å§‹åè½‰`,
                        text: `æº–å‚™åè½‰ [${list[groupStart]} ~ ${list[groupEnd]}]<br><br><code>prev = groupNext = ${groupNextIdx !== null ? list[groupNextIdx] : 'null'}</code><br><code>curr = groupPrevâ†’next = ${list[groupStart]}</code>`,
                        formula: `åè½‰ç¯„åœï¼šindices ${groupStart}~${groupEnd}`
                    }
                });

                // åè½‰è¿´åœˆ
                let prevIdx = groupNextIdx;
                let currIdx = groupStart;

                while (currIdx !== null && currIdx <= groupEnd) {
                    const currVal = list[currIdx];
                    const nextIdx = currIdx < n - 1 ? currIdx + 1 : null;
                    const nextVal = nextIdx !== null && nextIdx <= groupEnd ? list[nextIdx] : (groupNextIdx !== null ? list[groupNextIdx] : 'null');

                    // tmp = curr->next
                    steps.push({
                        nodes: JSON.parse(JSON.stringify(nodes)),
                        pointers: { groupPrev: groupPrevIdx, kth: groupEnd, prev: prevIdx, curr: currIdx },
                        activeNode: currIdx,
                        highlightLines: [14, 15],
                        stepText: `tmp = curr->next = ${nextVal}`,
                        explanation: {
                            title: `åè½‰ï¼šä¿å­˜ next`,
                            text: `<code>curr = ${currVal}</code><br><code>tmp = currâ†’next = ${nextVal}</code>`,
                            formula: `tmp = ${nextVal}`
                        }
                    });

                    // curr->next = prev (åè½‰)
                    let nodesSnapshot = JSON.parse(JSON.stringify(nodes));
                    nodesSnapshot[currIdx].linkState = 'reversing';

                    const prevDisplayVal = prevIdx !== null ? (prevIdx >= 0 && prevIdx < n ? list[prevIdx] : 'groupNext') : 'null';

                    steps.push({
                        nodes: nodesSnapshot,
                        pointers: { groupPrev: groupPrevIdx, kth: groupEnd, prev: prevIdx, curr: currIdx },
                        activeNode: currIdx,
                        reversing: true,
                        highlightLines: [16],
                        stepText: `curr->next = prev; // ${currVal}â†’${prevDisplayVal}`,
                        explanation: {
                            title: `åè½‰ï¼šæ”¹è®ŠæŒ‡å‘`,
                            text: `<code>${currVal}â†’next</code> åŸæœ¬æŒ‡å‘ ${nextVal}<br>ç¾åœ¨æ”¹ç‚ºæŒ‡å‘ <strong>${prevDisplayVal}</strong>`,
                            formula: `${currVal}â†’next = ${prevDisplayVal}`
                        }
                    });

                    // æ›´æ–°ç‹€æ…‹
                    nodes[currIdx].linkDir = 'backward';
                    nodes[currIdx].linkState = 'reversed';

                    // prev = curr; curr = tmp
                    const newPrev = currIdx;
                    const newCurr = nextIdx !== null && nextIdx <= groupEnd ? nextIdx : null;

                    steps.push({
                        nodes: JSON.parse(JSON.stringify(nodes)),
                        pointers: { groupPrev: groupPrevIdx, kth: groupEnd, prev: newPrev, curr: newCurr },
                        highlightLines: [17, 18],
                        stepText: `prev = ${currVal}; curr = ${newCurr !== null ? list[newCurr] : 'groupNext'}`,
                        explanation: {
                            title: `åè½‰ï¼šç§»å‹•æŒ‡æ¨™`,
                            text: `<code>prev</code> ç§»å‹•åˆ° ${currVal}<br><code>curr</code> ç§»å‹•åˆ° ${newCurr !== null ? list[newCurr] : (groupNextIdx !== null ? list[groupNextIdx] : 'null')}`,
                            formula: `prev = ${currVal}; curr = ${newCurr !== null ? list[newCurr] : 'groupNext'}`
                        }
                    });

                    prevIdx = newPrev;
                    currIdx = newCurr;
                }

                // æ¨™è¨˜ç¾¤çµ„å®Œæˆ
                for (let i = groupStart; i <= groupEnd; i++) {
                    nodes[i].groupId = g;
                }

                // æ›´æ–°é€£æ¥
                steps.push({
                    nodes: JSON.parse(JSON.stringify(nodes)),
                    pointers: { groupPrev: groupPrevIdx, kth: groupEnd, prev: groupEnd, curr: null },
                    highlightLines: [21, 22, 23],
                    stepText: `Link: groupPrev->next = kth; groupPrev = original first`,
                    explanation: {
                        title: `ç¬¬ ${g + 1} çµ„ï¼šå®Œæˆé€£æ¥`,
                        text: `åè½‰å®Œæˆï¼<br><br><code>groupPrevâ†’next</code> ç¾åœ¨æŒ‡å‘æ–°çš„é ­ (${list[groupEnd]})<br><code>groupPrev</code> ç§»å‹•åˆ°é€™çµ„çš„å°¾å·´ (${list[groupStart]})`,
                        formula: `groupPrev = ${list[groupStart]}`
                    }
                });

                groupPrevIdx = groupStart;
            }

            // å‰©é¤˜ç¯€é»
            if (remaining > 0) {
                const remainStart = numGroups * k;
                steps.push({
                    nodes: JSON.parse(JSON.stringify(nodes)),
                    pointers: { groupPrev: groupPrevIdx, kth: null, prev: null, curr: null },
                    highlightLines: [6, 7],
                    stepText: `kth = null â†’ not enough nodes, keep original order.`,
                    explanation: {
                        title: 'è™•ç†å‰©é¤˜ç¯€é»',
                        text: `å‰©é¤˜ ${remaining} å€‹ç¯€é» [${list.slice(remainStart).join(', ')}]<br><br>ä¸è¶³ k = ${k} å€‹ï¼Œä¿æŒåŸé †åºã€‚`,
                        formula: `remaining = ${remaining} < k = ${k}`
                    }
                });

                for (let i = remainStart; i < n; i++) {
                    nodes[i].groupId = -2;
                }
            }

            // æœ€çµ‚çµæœ
            let finalOrder = [];
            for (let g = 0; g < numGroups; g++) {
                const start = g * k;
                const end = start + k;
                for (let i = end - 1; i >= start; i--) {
                    finalOrder.push(list[i]);
                }
            }
            for (let i = numGroups * k; i < n; i++) {
                finalOrder.push(list[i]);
            }

            steps.push({
                nodes: JSON.parse(JSON.stringify(nodes)),
                pointers: { groupPrev: groupPrevIdx, kth: null, prev: null, curr: null },
                highlightLines: [25],
                final: true,
                stepText: `Complete! Return dummy.next`,
                explanation: {
                    title: 'ğŸ‰ å®Œæˆï¼',
                    text: `åŸå§‹ï¼š${list.join(' â†’ ')}<br>çµæœï¼š${finalOrder.join(' â†’ ')}<br><br>å…±åè½‰ ${numGroups} çµ„`,
                    formula: `Time: O(n), Space: O(1)`
                }
            });

            return steps;
        }

        // ========== æ¸²æŸ“å‡½æ•¸ ==========
        function renderLinkedList(step) {
            const nodesRow = document.getElementById('nodesRow');
            const { nodes, pointers, activeNode, reversing, final } = step;

            let html = '';

            // Dummy ç¯€é»
            const isDummyGroupPrev = pointers.groupPrev === -1;
            html += '<div class="node-wrapper">';
            html += `<div class="node dummy ${isDummyGroupPrev ? 'active' : ''}">`;
            html += '<span class="node-label">DUMMY</span>';
            html += 'D';
            if (isDummyGroupPrev) {
                html += '<span class="node-pointer-label groupPrev">groupPrev</span>';
            }
            html += '</div>';
            html += `<div class="link">${createArrowSVG('forward', 'normal')}</div>`;
            html += '</div>';

            // å¯¦éš›ç¯€é»
            nodes.forEach((node, i) => {
                let nodeClass = 'node';

                // ç¾¤çµ„é¡è‰²
                if (node.groupId >= 0) {
                    nodeClass += node.groupId % 2 === 0 ? ' group-a' : ' group-b';
                } else if (node.groupId === -2) {
                    nodeClass += ' remaining';
                }

                // é«˜äº®
                if (activeNode === i) {
                    nodeClass += ' active';
                    if (reversing) nodeClass += ' reversing';
                }

                html += '<div class="node-wrapper">';
                html += `<div class="${nodeClass}">`;
                html += node.value;

                // Pointer æ¨™ç±¤
                let pointerLabels = [];
                if (pointers.groupPrev === i) pointerLabels.push('<span class="node-pointer-label groupPrev">groupPrev</span>');
                if (pointers.kth === i) pointerLabels.push('<span class="node-pointer-label kth">kth</span>');
                if (pointers.curr === i) pointerLabels.push('<span class="node-pointer-label curr">curr</span>');
                if (pointers.prev === i) pointerLabels.push('<span class="node-pointer-label prev">prev</span>');

                if (pointerLabels.length > 0) {
                    html += pointerLabels.join('');
                }

                html += '</div>';

                // é€£çµ
                if (i < nodes.length - 1) {
                    const dir = node.linkDir === 'backward' ? 'backward' : 'forward';
                    const state = node.linkState || 'normal';
                    html += `<div class="link">${createArrowSVG(dir, state)}</div>`;
                } else {
                    html += '<div class="link null">';
                    html += createArrowSVG('forward', 'normal');
                    html += '</div>';
                }
                html += '</div>';
            });

            nodesRow.innerHTML = html;

            // æ›´æ–° Pointer Indicators
            document.querySelectorAll('.pointer-indicator').forEach(el => el.classList.remove('active'));
            if (pointers.groupPrev !== undefined && pointers.groupPrev !== null) {
                document.querySelector('.pointer-indicator.groupPrev')?.classList.add('active');
            }
            if (pointers.kth !== undefined && pointers.kth !== null) {
                document.querySelector('.pointer-indicator.kth')?.classList.add('active');
            }
            if (pointers.curr !== undefined && pointers.curr !== null) {
                document.querySelector('.pointer-indicator.curr')?.classList.add('active');
            }
            if (pointers.prev !== undefined && pointers.prev !== null) {
                document.querySelector('.pointer-indicator.prev')?.classList.add('active');
            }

            // æ›´æ–°ç‹€æ…‹é¢æ¿
            const getDisplayValue = (idx) => {
                if (idx === -1) return 'dummy';
                if (idx === null || idx === undefined) return '-';
                if (idx >= 0 && idx < currentList.length) return currentList[idx];
                return 'next';
            };

            document.getElementById('groupPrevVal').textContent = getDisplayValue(pointers.groupPrev);
            document.getElementById('kthVal').textContent = getDisplayValue(pointers.kth);
            document.getElementById('prevVal').textContent = getDisplayValue(pointers.prev);
            document.getElementById('currVal').textContent = getDisplayValue(pointers.curr);

            // æ›´æ–° Step Breakdown
            document.getElementById('stepBreakdown').textContent = step.stepText || '';
        }

        // ========== åˆå§‹åŒ–èˆ‡æ§åˆ¶ ==========
        function init(list = currentList, k = currentK) {
            currentList = list;
            currentK = k;

            const steps = generateAlgorithmSteps(list, k);

            viz = new AlgorithmVisualizer({
                codeLines: codeStructure,
                onStepChange: (step) => {
                    renderLinkedList(step);
                }
            });

            viz.setSteps(steps);
        }

        function runCustomInput() {
            const input = document.getElementById('customList').value;
            const k = parseInt(document.getElementById('customK').value);
            const list = input.split(',').map(x => parseInt(x.trim())).filter(x => !isNaN(x));

            if (list.length < 1) {
                alert('è«‹è¼¸å…¥è‡³å°‘ 1 å€‹ç¯€é»');
                return;
            }
            if (k < 1) {
                alert('k å¿…é ˆè‡³å°‘ç‚º 1');
                return;
            }
            if (list.length > 10) {
                alert('ç‚ºäº†è¦–è¦ºæ•ˆæœï¼Œæœ€å¤šæ”¯æ´ 10 å€‹ç¯€é»');
                return;
            }

            init(list, k);
        }

        function resetVisualization() {
            init(currentList, currentK);
        }

        window.addEventListener('load', () => init());
    </script>
</body>
</html>
