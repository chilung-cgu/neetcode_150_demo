<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LRU Cache - ç²¾ç·»è¦–è¦ºåŒ–</title>
    <link rel="stylesheet" href="../assets/visualizer/style.css">
    <style>
        .visualization-area {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 50%, #1e293b 100%);
            border-radius: 16px;
            padding: 30px 20px;
            margin: 15px 0;
        }

        /* é›™å‘éˆè¡¨ */
        .doubly-linked-list {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0;
            padding: 30px 10px;
            margin: 20px 0;
            background: rgba(30, 41, 59, 0.5);
            border-radius: 12px;
            overflow-x: auto;
        }

        .node {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-width: 65px;
            height: 65px;
            border-radius: 12px;
            font-weight: 700;
            color: white;
            position: relative;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .node.dummy {
            background: rgba(100, 116, 139, 0.3);
            border: 2px dashed #64748b;
            font-size: 0.7rem;
            color: #64748b;
        }

        .node.cache {
            background: linear-gradient(145deg, #3b82f6, #2563eb);
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }

        .node.cache .key { font-size: 1.1rem; }
        .node.cache .val { font-size: 0.75rem; opacity: 0.8; }

        .node.new {
            background: linear-gradient(145deg, #22c55e, #16a34a);
            box-shadow: 0 0 25px rgba(34, 197, 94, 0.5);
            animation: slide-in 0.4s ease-out;
        }

        .node.accessed {
            background: linear-gradient(145deg, #fbbf24, #f59e0b);
            box-shadow: 0 0 25px rgba(251, 191, 36, 0.5);
        }

        .node.evicted {
            background: linear-gradient(145deg, #ef4444, #dc2626);
            box-shadow: 0 0 25px rgba(239, 68, 68, 0.5);
            animation: fade-out 0.4s ease-out forwards;
        }

        @keyframes slide-in {
            from { transform: translateY(-20px) scale(0.8); opacity: 0; }
            to { transform: translateY(0) scale(1); opacity: 1; }
        }

        @keyframes fade-out {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.5); }
        }

        /* é›™å‘ç®­é ­ */
        .arrows {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 35px;
            color: #64748b;
            font-size: 0.9rem;
        }

        .arrows .forward { transform: translateY(-3px); }
        .arrows .backward { transform: translateY(3px); }

        /* æ¨™ç±¤ */
        .list-labels {
            display: flex;
            justify-content: space-between;
            padding: 0 20px;
            margin-bottom: 5px;
        }

        .list-label {
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 4px 10px;
            border-radius: 10px;
        }

        .list-label.lru {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .list-label.mru {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }

        /* HashMap è¦–è¦ºåŒ– */
        .hashmap-panel {
            background: rgba(30, 41, 59, 0.6);
            border-radius: 12px;
            padding: 15px 20px;
            margin: 15px 0;
            border: 1px solid rgba(100, 116, 139, 0.3);
        }

        .hashmap-title {
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #64748b;
            margin-bottom: 10px;
        }

        .hashmap-entries {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .hashmap-entry {
            padding: 6px 12px;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 8px;
            font-size: 0.8rem;
            font-family: 'Consolas', monospace;
            color: #94a3b8;
        }

        .hashmap-entry.highlight {
            background: rgba(251, 191, 36, 0.2);
            border: 1px solid #fbbf24;
            color: #fbbf24;
        }

        /* æ“ä½œé¡¯ç¤º */
        .operation-display {
            text-align: center;
            margin: 15px 0;
        }

        .operation {
            display: inline-block;
            padding: 12px 25px;
            border-radius: 30px;
            font-size: 1.1rem;
            font-weight: 700;
            font-family: 'Consolas', monospace;
        }

        .operation.get {
            background: linear-gradient(145deg, rgba(251, 191, 36, 0.2), rgba(251, 191, 36, 0.1));
            color: #fbbf24;
            border: 2px solid rgba(251, 191, 36, 0.3);
        }

        .operation.put {
            background: linear-gradient(145deg, rgba(34, 197, 94, 0.2), rgba(34, 197, 94, 0.1));
            color: #22c55e;
            border: 2px solid rgba(34, 197, 94, 0.3);
        }

        .operation.evict {
            background: linear-gradient(145deg, rgba(239, 68, 68, 0.2), rgba(239, 68, 68, 0.1));
            color: #ef4444;
            border: 2px solid rgba(239, 68, 68, 0.3);
        }

        /* åœ–ä¾‹ */
        .legend-bar {
            display: flex;
            justify-content: center;
            gap: 20px;
            padding: 15px;
            background: rgba(30, 41, 59, 0.5);
            border-radius: 12px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .legend-item { display: flex; align-items: center; gap: 6px; font-size: 0.75rem; color: #94a3b8; }
        .legend-dot { width: 14px; height: 14px; border-radius: 6px; }
        .legend-dot.cache { background: linear-gradient(145deg, #3b82f6, #2563eb); }
        .legend-dot.new { background: linear-gradient(145deg, #22c55e, #16a34a); }
        .legend-dot.accessed { background: linear-gradient(145deg, #fbbf24, #f59e0b); }
        .legend-dot.evicted { background: linear-gradient(145deg, #ef4444, #dc2626); }

        /* Step Breakdown */
        .step-breakdown {
            background: rgba(30, 41, 59, 0.6);
            border-radius: 12px;
            padding: 15px 20px;
            margin-top: 15px;
            border-left: 4px solid #3b82f6;
        }

        .step-breakdown-title { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: #64748b; margin-bottom: 8px; }
        .step-breakdown-text { font-size: 0.95rem; color: #e2e8f0; font-family: 'Consolas', monospace; }

        /* ç‹€æ…‹é¢æ¿ */
        .state-panel {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 15px 0;
        }

        .state-item {
            text-align: center;
            padding: 10px 20px;
            background: rgba(100, 116, 139, 0.1);
            border-radius: 10px;
        }

        .state-item .label {
            font-size: 0.7rem;
            color: #64748b;
            text-transform: uppercase;
        }

        .state-item .value {
            font-size: 1.3rem;
            font-weight: 700;
            color: #e2e8f0;
        }

        /* è‡ªè¨‚è¼¸å…¥ */
        .custom-input-section { background: var(--viz-card-bg); border-radius: 8px; padding: 15px; margin-bottom: 15px; border: 1px solid var(--viz-border); }
        .input-title { font-weight: bold; margin-bottom: 10px; color: var(--viz-text); }
        .input-row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-bottom: 8px; }
        .input-row label { font-size: 0.85rem; }
        .input-row input { padding: 8px 12px; border-radius: 6px; border: 1px solid var(--viz-border); background: var(--viz-input-bg); color: var(--viz-text); font-family: monospace; width: 60px; }
        .input-row button { padding: 8px 16px; border-radius: 6px; color: white; border: none; cursor: pointer; font-weight: 600; }
        .input-row button.put { background: #22c55e; }
        .input-row button.get { background: #fbbf24; color: #0f172a; }
        .input-row button.reset { background: #64748b; }

        .code-line.active { background: rgba(251, 191, 36, 0.15) !important; border-left: 3px solid #fbbf24 !important; }
    </style>
</head>
<body>
    <button class="theme-toggle" onclick="AlgorithmVisualizer.toggleTheme()" title="åˆ‡æ›ä¸»é¡Œ">ğŸŒ“</button>
    <div class="main-layout">
        <div class="canvas-area">
            <div class="viz-card">
                <div class="viz-title">LRU Cache - HashMap + é›™å‘éˆè¡¨</div>

                <div class="custom-input-section">
                    <div class="input-title">ğŸ® äº’å‹•æ¸¬è©¦</div>
                    <div class="input-row">
                        <label>å®¹é‡:</label>
                        <input type="number" id="capacityInput" value="3" min="1" max="5">
                        <button class="reset" onclick="resetWithCapacity()">é‡è¨­</button>
                    </div>
                    <div class="input-row">
                        <label>Key:</label>
                        <input type="number" id="keyInput" value="1">
                        <label>Value:</label>
                        <input type="number" id="valueInput" value="100">
                        <button class="put" onclick="doPut()">Put</button>
                        <button class="get" onclick="doGet()">Get</button>
                    </div>
                </div>

                <div class="visualization-area">
                    <div class="operation-display" id="operationDisplay">
                        <span class="operation">LRUCache(3)</span>
                    </div>

                    <div class="list-labels">
                        <span class="list-label lru">â† LRU (æœ€ä¹…æœªç”¨)</span>
                        <span class="list-label mru">MRU (æœ€è¿‘ä½¿ç”¨) â†’</span>
                    </div>

                    <div class="doubly-linked-list" id="linkedListDisplay">
                        <div class="node dummy">HEAD</div>
                        <div class="arrows"><span class="forward">â†’</span><span class="backward">â†</span></div>
                        <div class="node dummy">TAIL</div>
                    </div>

                    <div class="hashmap-panel">
                        <div class="hashmap-title">HashMap: key â†’ Node*</div>
                        <div class="hashmap-entries" id="hashmapDisplay">
                            <span style="color: #64748b;">ç©º</span>
                        </div>
                    </div>

                    <div class="state-panel">
                        <div class="state-item">
                            <div class="label">å®¹é‡</div>
                            <div class="value" id="capacityVal">3</div>
                        </div>
                        <div class="state-item">
                            <div class="label">ç›®å‰å¤§å°</div>
                            <div class="value" id="sizeVal">0</div>
                        </div>
                    </div>

                    <div class="legend-bar">
                        <div class="legend-item"><div class="legend-dot cache"></div>å¿«å–ç¯€é»</div>
                        <div class="legend-item"><div class="legend-dot new"></div>æ–°æ’å…¥</div>
                        <div class="legend-item"><div class="legend-dot accessed"></div>è¢«å­˜å–</div>
                        <div class="legend-item"><div class="legend-dot evicted"></div>è¢«é©…é€</div>
                    </div>
                </div>

                <div class="step-breakdown">
                    <div class="step-breakdown-title">Step Breakdown</div>
                    <div class="step-breakdown-text" id="stepBreakdown">é»æ“Šã€Œä¸‹ä¸€æ­¥ã€é–‹å§‹æ¼”ç®—æ³•ç¤ºç¯„</div>
                </div>

                <div class="controls" style="margin-top: 15px;">
                    <button class="viz-btn" id="prevBtn">â† ä¸Šä¸€æ­¥</button>
                    <div class="step-indicator">æ­¥é©Ÿ <span id="currentStep">0</span> / <span id="totalSteps">0</span></div>
                    <button class="viz-btn primary" id="nextBtn">ä¸‹ä¸€æ­¥ â†’</button>
                    <button class="viz-btn" onclick="resetVisualization()">â†» é‡ç½®</button>
                    <button class="viz-btn play-btn" id="playBtn" onclick="viz.toggleAutoPlay()">â–¶ è‡ªå‹•æ’­æ”¾</button>
                    <div class="speed-control">
                        <label>é€Ÿåº¦:</label>
                        <select id="speedSelect" onchange="viz.setSpeed(Number(this.value))">
                            <option value="2000">0.5x</option>
                            <option value="1500" selected>1x</option>
                            <option value="1000">1.5x</option>
                            <option value="500">2x</option>
                        </select>
                    </div>
                </div>

                <div class="complexity-badge">
                    <span class="label">Time:</span> O(1) get/put
                    <span class="label" style="margin-left: 12px;">Space:</span> O(capacity)
                </div>
            </div>

            <div class="viz-card">
                <div class="viz-title">æ¼”ç®—æ³•èªªæ˜</div>
                <div class="explanation" id="explanation"></div>
            </div>
        </div>

        <div class="code-area">
            <div class="viz-card" style="height: 100%;">
                <div class="viz-title">è³‡æ–™çµæ§‹ (C++)</div>
                <div class="code-panel" id="codeDisplay"></div>
            </div>
        </div>
    </div>

    <script src="../assets/visualizer/core.js"></script>
    <script>
        const codeStructure = [
            { line: 'class LRUCache {', id: 0 },
            { line: '    struct Node { int key, val; Node *prev, *next; };', id: 1 },
            { line: '    int capacity;', id: 2 },
            { line: '    unordered_map<int, Node*> map;', id: 3 },
            { line: '    Node *head, *tail; // dummy nodes', id: 4 },
            { line: '', id: 5 },
            { line: '    void remove(Node* n) { // O(1)', id: 6 },
            { line: '        n->prev->next = n->next;', id: 7 },
            { line: '        n->next->prev = n->prev;', id: 8 },
            { line: '    }', id: 9 },
            { line: '    void insertAtMRU(Node* n) { // O(1)', id: 10 },
            { line: '        n->prev = tail->prev;', id: 11 },
            { line: '        n->next = tail;', id: 12 },
            { line: '        tail->prev->next = n;', id: 13 },
            { line: '        tail->prev = n;', id: 14 },
            { line: '    }', id: 15 },
            { line: '', id: 16 },
            { line: '    int get(int key) {', id: 17 },
            { line: '        if (!map.count(key)) return -1;', id: 18 },
            { line: '        remove(map[key]); insertAtMRU(map[key]);', id: 19 },
            { line: '        return map[key]->val;', id: 20 },
            { line: '    }', id: 21 },
            { line: '    void put(int key, int val) {', id: 22 },
            { line: '        if (map.count(key)) remove(map[key]);', id: 23 },
            { line: '        Node* n = new Node{key, val};', id: 24 },
            { line: '        map[key] = n; insertAtMRU(n);', id: 25 },
            { line: '        if (map.size() > capacity) {', id: 26 },
            { line: '            Node* lru = head->next;', id: 27 },
            { line: '            remove(lru); map.erase(lru->key);', id: 28 },
            { line: '        }', id: 29 },
            { line: '    }', id: 30 },
            { line: '};', id: 31 },
        ];

        let capacity = 3;
        let cache = []; // [{k, v, state}] left=LRU, right=MRU
        let viz;

        function generateDemoSteps() {
            const steps = [];

            // åˆå§‹åŒ–
            steps.push({
                cache: [], op: 'LRUCache(3)', opType: 'init',
                highlightLines: [0, 1, 2, 3, 4],
                stepText: 'head â†” tail',
                explanation: {
                    title: 'åˆå§‹åŒ– LRU Cache',
                    text: `å®¹é‡ = 3<br><br>ä½¿ç”¨ HashMap æä¾› O(1) æŸ¥æ‰¾<br>ä½¿ç”¨é›™å‘éˆè¡¨ç¶­è­· LRU é †åº<br><br>head = LRU ç«¯, tail = MRU ç«¯`,
                    formula: 'get() = O(1), put() = O(1)'
                }
            });

            // put(1, 100)
            steps.push({
                cache: [{k: 1, v: 100, state: 'new'}], op: 'put(1, 100)', opType: 'put',
                highlightLines: [22, 24, 25],
                stepText: 'insert {1:100} at MRU',
                explanation: { title: 'put(1, 100)', text: 'æ’å…¥ key=1, value=100<br>æ”¾åˆ° MRU ç«¯ï¼ˆæœ€å³é‚Šï¼‰', formula: 'insertAtMRU({1, 100})' }
            });

            // put(2, 200)
            steps.push({
                cache: [{k: 1, v: 100}, {k: 2, v: 200, state: 'new'}], op: 'put(2, 200)', opType: 'put',
                highlightLines: [22, 24, 25],
                stepText: 'insert {2:200} at MRU',
                explanation: { title: 'put(2, 200)', text: 'æ’å…¥ key=2<br>1 è¢«æ¨åˆ° LRU ç«¯', formula: 'insertAtMRU({2, 200})' }
            });

            // put(3, 300)
            steps.push({
                cache: [{k: 1, v: 100}, {k: 2, v: 200}, {k: 3, v: 300, state: 'new'}], op: 'put(3, 300)', opType: 'put',
                highlightLines: [22, 24, 25],
                stepText: 'insert {3:300} at MRU',
                explanation: { title: 'put(3, 300)', text: 'æ’å…¥ key=3<br>å®¹é‡å·²æ»¿ (3/3)', formula: 'insertAtMRU({3, 300})' }
            });

            // get(1)
            steps.push({
                cache: [{k: 2, v: 200}, {k: 3, v: 300}, {k: 1, v: 100, state: 'accessed'}], op: 'get(1) â†’ 100', opType: 'get',
                highlightKey: 1,
                highlightLines: [17, 18, 19, 20],
                stepText: 'remove(1), insertAtMRU(1)',
                explanation: { title: 'get(1) â†’ 100', text: 'æ‰¾åˆ° key=1<br>ç§»åˆ° MRU ç«¯<br>å›å‚³ value=100', formula: 'remove(); insertAtMRU()' }
            });

            // put(4, 400) - evict key=2
            steps.push({
                cache: [{k: 2, v: 200, state: 'evicted'}, {k: 3, v: 300}, {k: 1, v: 100}], op: 'put(4, 400) â†’ é©…é€ key=2', opType: 'evict',
                evictedKey: 2,
                highlightLines: [26, 27, 28],
                stepText: 'capacity exceeded â†’ remove LRU',
                explanation: { title: 'put(4, 400)', text: 'å®¹é‡å·²æ»¿ï¼<br>é©…é€ LRU ç¯€é» (key=2)<br>ç„¶å¾Œæ’å…¥æ–°ç¯€é»', formula: 'remove(head->next)' }
            });

            steps.push({
                cache: [{k: 3, v: 300}, {k: 1, v: 100}, {k: 4, v: 400, state: 'new'}], op: 'put(4, 400)', opType: 'put',
                highlightLines: [24, 25],
                stepText: 'insert {4:400} at MRU',
                explanation: { title: 'æ’å…¥ key=4', text: 'key=2 å·²è¢«é©…é€<br>key=4 æˆç‚ºæ–°çš„ MRU', formula: 'insertAtMRU({4, 400})' }
            });

            // get(2) - not found
            steps.push({
                cache: [{k: 3, v: 300}, {k: 1, v: 100}, {k: 4, v: 400}], op: 'get(2) â†’ -1', opType: 'get',
                highlightLines: [17, 18],
                stepText: '!map.count(2) â†’ return -1',
                explanation: { title: 'get(2) â†’ -1', text: 'key=2 å·²è¢«é©…é€<br>å›å‚³ -1', formula: 'return -1' }
            });

            return steps;
        }

        function renderStep(step) {
            const { cache: c, op, opType, evictedKey, highlightKey } = step;

            // Operation display
            const opEl = document.getElementById('operationDisplay');
            opEl.innerHTML = `<span class="operation ${opType}">${op}</span>`;

            // Doubly Linked List
            let listHtml = '<div class="node dummy">HEAD</div>';

            if (c && c.length > 0) {
                c.forEach((item, i) => {
                    listHtml += '<div class="arrows"><span class="forward">â†’</span><span class="backward">â†</span></div>';
                    let cls = 'node cache';
                    if (item.state) cls += ` ${item.state}`;
                    listHtml += `<div class="${cls}"><span class="key">k=${item.k}</span><span class="val">v=${item.v}</span></div>`;
                });
            }

            listHtml += '<div class="arrows"><span class="forward">â†’</span><span class="backward">â†</span></div>';
            listHtml += '<div class="node dummy">TAIL</div>';

            document.getElementById('linkedListDisplay').innerHTML = listHtml;

            // HashMap
            const validCache = (c || []).filter(item => item.state !== 'evicted');
            let mapHtml = '';
            if (validCache.length > 0) {
                validCache.forEach(item => {
                    const isHighlight = item.k === highlightKey;
                    mapHtml += `<span class="hashmap-entry ${isHighlight ? 'highlight' : ''}">${item.k} â†’ Node*</span>`;
                });
            } else {
                mapHtml = '<span style="color: #64748b;">ç©º</span>';
            }
            document.getElementById('hashmapDisplay').innerHTML = mapHtml;

            // State
            document.getElementById('sizeVal').textContent = validCache.length;
            document.getElementById('stepBreakdown').textContent = step.stepText || '';
        }

        function init() {
            cache = [];
            document.getElementById('capacityVal').textContent = capacity;

            viz = new AlgorithmVisualizer({
                codeLines: codeStructure,
                onStepChange: (step) => renderStep(step)
            });

            viz.setSteps(generateDemoSteps());
        }

        function resetWithCapacity() {
            capacity = parseInt(document.getElementById('capacityInput').value) || 3;
            document.getElementById('capacityVal').textContent = capacity;
            cache = [];
            init();
        }

        function doPut() {
            const key = parseInt(document.getElementById('keyInput').value);
            const value = parseInt(document.getElementById('valueInput').value);
            // Interactive mode - add to current cache
            const idx = cache.findIndex(item => item.k === key);
            if (idx >= 0) cache.splice(idx, 1);

            let evicted = null;
            if (cache.length >= capacity) {
                evicted = cache.shift();
            }

            cache.push({k: key, v: value, state: 'new'});
            renderStep({cache: [...cache], op: `put(${key}, ${value})${evicted ? ' â†’ é©…é€ k=' + evicted.k : ''}`, opType: evicted ? 'evict' : 'put'});
            setTimeout(() => cache.forEach(item => item.state = null), 500);
        }

        function doGet() {
            const key = parseInt(document.getElementById('keyInput').value);
            const idx = cache.findIndex(item => item.k === key);

            if (idx === -1) {
                renderStep({cache: [...cache], op: `get(${key}) â†’ -1`, opType: 'get'});
            } else {
                const item = cache.splice(idx, 1)[0];
                item.state = 'accessed';
                cache.push(item);
                renderStep({cache: [...cache], op: `get(${key}) â†’ ${item.v}`, opType: 'get', highlightKey: key});
                setTimeout(() => item.state = null, 500);
            }
        }

        function resetVisualization() { cache = []; init(); }
        window.addEventListener('load', () => init());
    </script>
</body>
</html>
