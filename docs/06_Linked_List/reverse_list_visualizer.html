<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reverse Linked List - ç²¾ç·»è¦–è¦ºåŒ–</title>
    <link rel="stylesheet" href="../assets/visualizer/style.css">
    <style>
        /* ========== Gemini Dynamic View ç­‰ç´šæ¨£å¼ ========== */
        
        .visualization-area {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 50%, #1e293b 100%);
            border-radius: 16px;
            padding: 30px 20px;
            margin: 15px 0;
            position: relative;
            overflow: hidden;
        }

        .visualization-area::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: radial-gradient(ellipse at center, rgba(59, 130, 246, 0.08) 0%, transparent 70%);
            pointer-events: none;
        }

        .linked-list-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 1;
        }

        .nodes-row {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px 20px 30px;
        }

        .node-wrapper {
            display: flex;
            align-items: center;
            position: relative;
        }

        /* åœ“å½¢ç¯€é» */
        .node {
            width: 56px;
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.3rem;
            border-radius: 50%;
            background: linear-gradient(145deg, #3b82f6, #2563eb);
            color: white;
            position: relative;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3),
                        inset 0 2px 4px rgba(255, 255, 255, 0.1);
            border: 3px solid transparent;
        }

        /* Pointer é¡è‰²ç·¨ç¢¼ */
        .node.prev-node {
            background: linear-gradient(145deg, #22c55e, #16a34a);
            box-shadow: 0 4px 15px rgba(34, 197, 94, 0.4);
        }

        .node.curr-node {
            background: linear-gradient(145deg, #eab308, #ca8a04);
            box-shadow: 0 4px 15px rgba(234, 179, 8, 0.4);
        }

        .node.next-node {
            background: linear-gradient(145deg, #f97316, #ea580c);
            box-shadow: 0 4px 15px rgba(249, 115, 22, 0.4);
        }

        .node.reversed {
            background: linear-gradient(145deg, #22c55e, #16a34a);
            box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3);
        }

        .node.active {
            border-color: #fbbf24;
            box-shadow: 0 0 25px rgba(251, 191, 36, 0.6),
                        0 0 50px rgba(251, 191, 36, 0.3);
            transform: scale(1.08);
        }

        .node.reversing {
            animation: glow-pulse 0.6s ease-in-out infinite alternate;
        }

        @keyframes glow-pulse {
            from { box-shadow: 0 0 25px rgba(239, 68, 68, 0.6), 0 0 50px rgba(239, 68, 68, 0.3); }
            to { box-shadow: 0 0 35px rgba(239, 68, 68, 0.8), 0 0 70px rgba(239, 68, 68, 0.4); transform: scale(1.12); }
        }

        /* Pointer æ¨™ç±¤ */
        .node-pointer-label {
            position: absolute;
            bottom: -26px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.7rem;
            font-weight: 700;
            padding: 3px 8px;
            border-radius: 4px;
            white-space: nowrap;
        }

        .node-pointer-label.prev { background: #22c55e; color: #0f172a; }
        .node-pointer-label.curr { background: #eab308; color: #0f172a; }
        .node-pointer-label.next { background: #f97316; color: white; }

        /* SVG ç®­é ­ */
        .link {
            width: 40px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .link svg { width: 40px; height: 24px; }
        .link.null { width: 70px; }
        .link.null::after {
            content: 'null';
            position: absolute;
            right: 0;
            font-size: 0.8rem;
            color: #64748b;
            font-style: italic;
        }

        /* Pointer Indicators */
        .pointer-indicators {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .pointer-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            opacity: 0.5;
            transition: all 0.3s ease;
        }

        .pointer-indicator.active { opacity: 1; }
        .pointer-indicator.prev { background: rgba(34, 197, 94, 0.2); color: #22c55e; border: 1px solid rgba(34, 197, 94, 0.3); }
        .pointer-indicator.curr { background: rgba(234, 179, 8, 0.2); color: #eab308; border: 1px solid rgba(234, 179, 8, 0.3); }
        .pointer-indicator.next { background: rgba(249, 115, 22, 0.2); color: #f97316; border: 1px solid rgba(249, 115, 22, 0.3); }

        .pointer-dot { width: 8px; height: 8px; border-radius: 50%; }
        .pointer-indicator.prev .pointer-dot { background: #22c55e; }
        .pointer-indicator.curr .pointer-dot { background: #eab308; }
        .pointer-indicator.next .pointer-dot { background: #f97316; }

        /* Legend */
        .legend-bar {
            display: flex;
            justify-content: center;
            gap: 25px;
            padding: 15px;
            background: rgba(30, 41, 59, 0.5);
            border-radius: 12px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .legend-item { display: flex; align-items: center; gap: 8px; font-size: 0.8rem; color: #94a3b8; }
        .legend-dot { width: 12px; height: 12px; border-radius: 50%; }
        .legend-dot.original { background: linear-gradient(145deg, #3b82f6, #2563eb); }
        .legend-dot.reversed { background: linear-gradient(145deg, #22c55e, #16a34a); }
        .legend-dot.active { background: #eab308; box-shadow: 0 0 8px rgba(234, 179, 8, 0.6); }

        /* Step Breakdown */
        .step-breakdown {
            background: rgba(30, 41, 59, 0.6);
            border-radius: 12px;
            padding: 15px 20px;
            margin-top: 15px;
            border-left: 4px solid #3b82f6;
        }

        .step-breakdown-title {
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #64748b;
            margin-bottom: 8px;
        }

        .step-breakdown-text {
            font-size: 0.95rem;
            color: #e2e8f0;
            line-height: 1.5;
            font-family: 'Consolas', monospace;
        }

        /* Pointer State Panel */
        .pointer-state-panel {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
            padding: 12px;
            background: var(--viz-bg-secondary);
            border-radius: 8px;
        }

        .pointer-state {
            text-align: center;
            padding: 8px;
            border-radius: 6px;
        }

        .pointer-state .label {
            font-size: 0.7rem;
            color: var(--viz-text-muted);
            margin-bottom: 4px;
            text-transform: uppercase;
        }

        .pointer-state .value {
            font-weight: bold;
            font-family: 'Consolas', monospace;
            font-size: 1.1rem;
        }

        .pointer-state.prev { background: rgba(34, 197, 94, 0.1); }
        .pointer-state.prev .value { color: #22c55e; }
        .pointer-state.curr { background: rgba(234, 179, 8, 0.1); }
        .pointer-state.curr .value { color: #eab308; }
        .pointer-state.next { background: rgba(249, 115, 22, 0.1); }
        .pointer-state.next .value { color: #f97316; }

        /* Custom Input */
        .custom-input-section {
            background: var(--viz-card-bg);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid var(--viz-border);
        }

        .input-title { font-weight: bold; margin-bottom: 10px; color: var(--viz-text); }
        .input-row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .input-row input {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid var(--viz-border);
            background: var(--viz-input-bg);
            color: var(--viz-text);
            font-family: monospace;
            flex: 1;
            min-width: 150px;
        }
        .input-row button {
            padding: 8px 16px;
            border-radius: 6px;
            background: var(--viz-primary);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
        }

        .code-line.active { background: rgba(251, 191, 36, 0.15) !important; border-left: 3px solid #fbbf24 !important; }
    </style>
</head>
<body>
    <button class="theme-toggle" onclick="AlgorithmVisualizer.toggleTheme()" title="åˆ‡æ›ä¸»é¡Œ">ğŸŒ“</button>
    <div class="main-layout">
        <div class="canvas-area">
            <div class="viz-card">
                <div class="viz-title">åè½‰éˆçµä¸²åˆ— - Pointer è¦–è¦ºåŒ–</div>

                <div class="custom-input-section">
                    <div class="input-title">ğŸ® è‡ªè¨‚æ¸¬è©¦</div>
                    <div class="input-row">
                        <input type="text" id="customNodes" placeholder="ç¯€é»å€¼" value="1,2,3,4,5">
                        <button onclick="runCustomInput()">åŸ·è¡Œ</button>
                    </div>
                </div>

                <div class="visualization-area">
                    <div class="linked-list-container">
                        <div class="pointer-indicators" id="pointerIndicators">
                            <div class="pointer-indicator prev"><div class="pointer-dot"></div>prev</div>
                            <div class="pointer-indicator curr"><div class="pointer-dot"></div>curr</div>
                            <div class="pointer-indicator next"><div class="pointer-dot"></div>next</div>
                        </div>
                        <div class="nodes-row" id="nodesRow"></div>
                    </div>

                    <div class="legend-bar">
                        <div class="legend-item"><div class="legend-dot original"></div>æœªåè½‰</div>
                        <div class="legend-item"><div class="legend-dot reversed"></div>å·²åè½‰</div>
                        <div class="legend-item"><div class="legend-dot active"></div>ç•¶å‰æ“ä½œ</div>
                    </div>
                </div>

                <div class="step-breakdown">
                    <div class="step-breakdown-title">Step Breakdown</div>
                    <div class="step-breakdown-text" id="stepBreakdown">é»æ“Šã€Œä¸‹ä¸€æ­¥ã€é–‹å§‹æ¼”ç®—æ³•</div>
                </div>

                <div class="pointer-state-panel">
                    <div class="pointer-state prev">
                        <div class="label">prev</div>
                        <div class="value" id="prevVal">null</div>
                    </div>
                    <div class="pointer-state curr">
                        <div class="label">curr</div>
                        <div class="value" id="currVal">1</div>
                    </div>
                    <div class="pointer-state next">
                        <div class="label">next</div>
                        <div class="value" id="nextVal">2</div>
                    </div>
                </div>

                <div class="controls" style="margin-top: 15px;">
                    <button class="viz-btn" id="prevBtn">â† ä¸Šä¸€æ­¥</button>
                    <div class="step-indicator">æ­¥é©Ÿ <span id="currentStep">0</span> / <span id="totalSteps">0</span></div>
                    <button class="viz-btn primary" id="nextBtn">ä¸‹ä¸€æ­¥ â†’</button>
                    <button class="viz-btn" onclick="resetVisualization()">â†» é‡ç½®</button>
                    <button class="viz-btn play-btn" id="playBtn" onclick="viz.toggleAutoPlay()">â–¶ è‡ªå‹•æ’­æ”¾</button>
                    <div class="speed-control">
                        <label>é€Ÿåº¦:</label>
                        <select id="speedSelect" onchange="viz.setSpeed(Number(this.value))">
                            <option value="2000">0.5x</option>
                            <option value="1500" selected>1x</option>
                            <option value="1000">1.5x</option>
                            <option value="500">2x</option>
                        </select>
                    </div>
                </div>

                <div class="complexity-badge">
                    <span class="label">Time:</span> O(n)
                    <span class="label" style="margin-left: 12px;">Space:</span> O(1)
                </div>
            </div>

            <div class="viz-card">
                <div class="viz-title">æ¼”ç®—æ³•èªªæ˜</div>
                <div class="explanation" id="explanation"></div>
            </div>
        </div>

        <div class="code-area">
            <div class="viz-card" style="height: 100%;">
                <div class="viz-title">æ¼”ç®—æ³• (C++)</div>
                <div class="code-panel" id="codeDisplay"></div>
            </div>
        </div>
    </div>

    <script src="../assets/visualizer/core.js"></script>
    <script>
        const codeStructure = [
            { line: 'ListNode* reverseList(ListNode* head) {', id: 0 },
            { line: '    ListNode* prev = nullptr;', id: 1 },
            { line: '    ListNode* curr = head;', id: 2 },
            { line: '', id: 3 },
            { line: '    while (curr != nullptr) {', id: 4 },
            { line: '        ListNode* next = curr->next;', id: 5 },
            { line: '        curr->next = prev;  // åè½‰', id: 6 },
            { line: '        prev = curr;', id: 7 },
            { line: '        curr = next;', id: 8 },
            { line: '    }', id: 9 },
            { line: '    return prev;', id: 10 },
            { line: '}', id: 11 },
        ];

        let currentNodes = [1, 2, 3, 4, 5];
        let viz;

        function createArrowSVG(state = 'normal') {
            const colors = { normal: '#64748b', reversed: '#22c55e', reversing: '#ef4444' };
            const color = colors[state] || colors.normal;
            return `<svg viewBox="0 0 40 24">
                <path d="M 5 12 Q 20 12 30 12" stroke="${color}" stroke-width="2" fill="none"/>
                <polygon points="30,12 24,8 24,16" fill="${color}"/>
            </svg>`;
        }

        function generateAlgorithmSteps(nodes) {
            const steps = [];
            const n = nodes.length;
            let linkStates = nodes.map(() => 'normal');

            // åˆå§‹åŒ–
            steps.push({
                nodes: [...nodes],
                pointers: { prev: null, curr: 0, next: n > 1 ? 1 : null },
                linkStates: [...linkStates],
                highlightLines: [0, 1, 2],
                stepText: 'prev = nullptr; curr = head',
                explanation: {
                    title: 'åˆå§‹åŒ–',
                    text: `éˆè¡¨ï¼š${nodes.join(' â†’ ')} â†’ null<br><br><code>prev = null</code><br><code>curr = head (${nodes[0]})</code>`,
                    formula: 'prev = nullptr; curr = head'
                }
            });

            for (let i = 0; i < n; i++) {
                const currVal = nodes[i];
                const nextIdx = i < n - 1 ? i + 1 : null;
                const nextVal = nextIdx !== null ? nodes[nextIdx] : 'null';
                const prevVal = i > 0 ? nodes[i - 1] : 'null';

                // Step: next = curr->next
                steps.push({
                    nodes: [...nodes],
                    pointers: { prev: i > 0 ? i - 1 : null, curr: i, next: nextIdx },
                    linkStates: [...linkStates],
                    activeNode: i,
                    highlightLines: [4, 5],
                    stepText: `next = curr->next = ${nextVal}`,
                    explanation: {
                        title: `ç¯€é» ${currVal}ï¼šä¿å­˜ next`,
                        text: `<code>next = currâ†’next = ${nextVal}</code><br><br>å…ˆä¿å­˜ nextï¼Œå› ç‚ºç­‰ä¸‹æœƒä¿®æ”¹ currâ†’next`,
                        formula: `next = ${nextVal}`
                    }
                });

                // Step: curr->next = prev (åè½‰)
                let newLinkStates = [...linkStates];
                newLinkStates[i] = 'reversing';

                steps.push({
                    nodes: [...nodes],
                    pointers: { prev: i > 0 ? i - 1 : null, curr: i, next: nextIdx },
                    linkStates: newLinkStates,
                    activeNode: i,
                    reversing: true,
                    highlightLines: [6],
                    stepText: `curr->next = prev; // ${currVal}â†’${prevVal}`,
                    explanation: {
                        title: `ç¯€é» ${currVal}ï¼šåè½‰æŒ‡å‘`,
                        text: `<code>${currVal}â†’next</code> åŸæœ¬æŒ‡å‘ ${nextVal}<br>ç¾åœ¨æ”¹ç‚ºæŒ‡å‘ <strong>${prevVal}</strong>`,
                        formula: `${currVal}â†’next = ${prevVal}`
                    }
                });

                linkStates[i] = 'reversed';

                // Step: prev = curr; curr = next
                steps.push({
                    nodes: [...nodes],
                    pointers: { prev: i, curr: nextIdx, next: nextIdx !== null && nextIdx < n - 1 ? nextIdx + 1 : null },
                    linkStates: [...linkStates],
                    highlightLines: [7, 8],
                    stepText: `prev = ${currVal}; curr = ${nextVal}`,
                    explanation: {
                        title: 'ç§»å‹•æŒ‡æ¨™',
                        text: `<code>prev = curr = ${currVal}</code><br><code>curr = next = ${nextVal}</code>`,
                        formula: `prev = ${currVal}; curr = ${nextVal}`
                    }
                });
            }

            // å®Œæˆ
            steps.push({
                nodes: [...nodes].reverse(),
                pointers: { prev: 0, curr: null, next: null },
                linkStates: nodes.map(() => 'reversed'),
                final: true,
                highlightLines: [10],
                stepText: `return prev = ${nodes[n - 1]}`,
                explanation: {
                    title: 'ğŸ‰ å®Œæˆï¼',
                    text: `åŸå§‹ï¼š${nodes.join(' â†’ ')}<br>çµæœï¼š${[...nodes].reverse().join(' â†’ ')}<br><br>å›å‚³ <code>prev</code> ä½œç‚ºæ–°çš„ head`,
                    formula: `return prev = ${nodes[n - 1]}`
                }
            });

            return steps;
        }

        function renderLinkedList(step) {
            const nodesRow = document.getElementById('nodesRow');
            const { nodes, pointers, linkStates, activeNode, reversing, final } = step;

            let html = '';
            const displayNodes = final ? step.nodes : currentNodes;

            displayNodes.forEach((val, i) => {
                let nodeClass = 'node';

                // åè½‰ç‹€æ…‹é¡è‰²
                const originalIdx = final ? currentNodes.length - 1 - i : i;
                if (!final && linkStates[i] === 'reversed') {
                    nodeClass += ' reversed';
                }

                // ç•¶å‰æ“ä½œ
                if (activeNode === i) {
                    nodeClass += ' active';
                    if (reversing) nodeClass += ' reversing';
                }

                html += '<div class="node-wrapper">';
                html += `<div class="${nodeClass}">`;
                html += val;

                // Pointer æ¨™ç±¤
                let labels = [];
                if (!final) {
                    if (pointers.prev === i) labels.push('<span class="node-pointer-label prev">prev</span>');
                    if (pointers.curr === i) labels.push('<span class="node-pointer-label curr">curr</span>');
                    if (pointers.next === i) labels.push('<span class="node-pointer-label next">next</span>');
                }
                html += labels.join('');
                html += '</div>';

                // é€£çµ
                if (i < displayNodes.length - 1) {
                    const state = final ? 'reversed' : (linkStates[i] || 'normal');
                    html += `<div class="link">${createArrowSVG(state)}</div>`;
                } else {
                    html += `<div class="link null">${createArrowSVG('normal')}</div>`;
                }
                html += '</div>';
            });

            nodesRow.innerHTML = html;

            // Update indicators
            document.querySelectorAll('.pointer-indicator').forEach(el => el.classList.remove('active'));
            if (pointers.prev !== null) document.querySelector('.pointer-indicator.prev')?.classList.add('active');
            if (pointers.curr !== null) document.querySelector('.pointer-indicator.curr')?.classList.add('active');
            if (pointers.next !== null) document.querySelector('.pointer-indicator.next')?.classList.add('active');

            // Update state panel
            const getVal = (idx) => idx !== null && idx >= 0 && idx < currentNodes.length ? currentNodes[idx] : 'null';
            document.getElementById('prevVal').textContent = getVal(pointers.prev);
            document.getElementById('currVal').textContent = getVal(pointers.curr);
            document.getElementById('nextVal').textContent = getVal(pointers.next);

            // Update step breakdown
            document.getElementById('stepBreakdown').textContent = step.stepText || '';
        }

        function init(nodes = currentNodes) {
            currentNodes = nodes;
            const steps = generateAlgorithmSteps(nodes);

            viz = new AlgorithmVisualizer({
                codeLines: codeStructure,
                onStepChange: (step) => renderLinkedList(step)
            });

            viz.setSteps(steps);
        }

        function runCustomInput() {
            const nodes = document.getElementById('customNodes').value
                .split(',').map(s => parseInt(s.trim())).filter(n => !isNaN(n));
            if (nodes.length < 1 || nodes.length > 8) {
                alert('è«‹è¼¸å…¥ 1-8 å€‹ç¯€é»å€¼');
                return;
            }
            init(nodes);
        }

        function resetVisualization() { init(currentNodes); }
        window.addEventListener('load', () => init());
    </script>
</body>
</html>
