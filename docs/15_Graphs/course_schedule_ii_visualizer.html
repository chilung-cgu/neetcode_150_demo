<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Course Schedule II - è¦–è¦ºåŒ–</title>
    <link rel="stylesheet" href="../assets/visualizer/style.css">
    <style>
        .custom-input-section { background: var(--viz-card-bg); border-radius: 8px; padding: 15px; margin-bottom: 15px; border: 1px solid var(--viz-border); }
        .input-row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .input-row button { padding: 8px 16px; border-radius: 6px; background: var(--viz-primary); color: white; border: none; cursor: pointer; }

        .graph-container { display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; margin: 20px 0; }
        .node { 
            width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; 
            font-weight: bold; border-radius: 50%; background: var(--viz-primary); color: white; 
            font-size: 1.1rem; transition: all 0.3s; border: 2px solid transparent;
        }
        .node.visited { background: var(--viz-success); color: #0f172a; }
        .node.current { border-color: white; background: var(--viz-warning); color: #0f172a; transform: scale(1.1); }

        .result-container { 
            display: flex; gap: 8px; justify-content: center; margin: 15px 0; padding: 15px; 
            background: var(--viz-bg-secondary); border-radius: 8px; min-height: 50px; align-items: center;
        }
        .result-label { color: var(--viz-text-muted); margin-right: 10px; }
        .result-item { 
            width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; 
            font-weight: bold; border-radius: 50%; background: var(--viz-success); color: #0f172a;
        }
        .result-arrow { color: var(--viz-text-muted); }

        .indegree-display { 
            display: flex; gap: 10px; justify-content: center; margin: 10px 0; flex-wrap: wrap;
            padding: 10px; background: var(--viz-bg-secondary); border-radius: 8px;
        }
        .indegree-item { padding: 5px 10px; border-radius: 4px; font-size: 0.85rem; background: var(--viz-bg-primary); }
    </style>
</head>
<body>
    <button class="theme-toggle" onclick="AlgorithmVisualizer.toggleTheme()" title="åˆ‡æ›ä¸»é¡Œ">ğŸŒ“</button>
    <div class="main-layout">
        <div class="canvas-area">
            <div class="viz-card">
                <div class="viz-title">èª²ç¨‹è¡¨ II (Course Schedule II)</div>
                <div class="custom-input-section">
                    <div style="font-weight:bold; margin-bottom:5px;">ğŸ® è‡ªè¨‚æ¸¬è©¦</div>
                    <div class="input-row">
                        <button onclick="setExample(1)">ç¯„ä¾‹1 (4èª²ç¨‹)</button>
                        <button onclick="setExample(2)">ç¯„ä¾‹2 (æœ‰ç’°)</button>
                        <button onclick="resetVisualization()">â†» é‡ç½®</button>
                    </div>
                </div>
                
                <div class="graph-container" id="graphDisplay"></div>
                
                <div style="text-align: center; color: var(--viz-text-muted); font-size: 0.85rem;">å…¥åº¦ (In-degree)</div>
                <div class="indegree-display" id="indegreeDisplay"></div>
                
                <div style="text-align: center; color: var(--viz-text-muted); margin-top: 10px;">ä¿®èª²é †åº</div>
                <div class="result-container" id="resultDisplay"></div>

                <div class="controls" style="margin-top: 15px;">
                    <button class="viz-btn" id="prevBtn">â† ä¸Šä¸€æ­¥</button>
                    <div class="step-indicator">æ­¥é©Ÿ <span id="currentStep">0</span> / <span id="totalSteps">0</span></div>
                    <button class="viz-btn primary" id="nextBtn">ä¸‹ä¸€æ­¥ â†’</button>
                    <div class="speed-control">
                        <label>é€Ÿåº¦:</label>
                        <select id="speedSelect" onchange="viz.setSpeed(Number(this.value))">
                            <option value="1500">1x</option>
                            <option value="800">2x</option>
                        </select>
                    </div>
                </div>
                
                <div class="complexity-badge">
                    <span class="label">Time:</span> O(V+E)
                    <span class="label" style="margin-left: 12px;">Space:</span> O(V+E)
                </div>
            </div>
            <div class="viz-card"><div class="viz-title">æ¼”ç®—æ³•èªªæ˜</div><div class="explanation" id="explanation"></div></div>
        </div>
        <div class="code-area">
            <div class="viz-card" style="height: 100%;">
                <div class="viz-title">æ¼”ç®—æ³• (C++)</div>
                <div class="code-panel" id="codeDisplay"></div>
            </div>
        </div>
    </div>
    <script src="../assets/visualizer/core.js"></script>
    <script>
        const codeStructure = [
            { line: 'vector<int> findOrder(int numCourses, prerequisites) {', id: 0 },
            { line: '    vector<int> inDegree(numCourses, 0);', id: 1 },
            { line: '    vector<vector<int>> graph(numCourses);', id: 2 },
            { line: '    for (auto& p : prerequisites) {', id: 3 },
            { line: '        graph[p[1]].push_back(p[0]);', id: 4 },
            { line: '        inDegree[p[0]]++;', id: 5 },
            { line: '    }', id: 6 },
            { line: '    queue<int> q;', id: 7 },
            { line: '    for (int i = 0; i < numCourses; i++)', id: 8 },
            { line: '        if (inDegree[i] == 0) q.push(i);', id: 9 },
            { line: '    vector<int> order;', id: 10 },
            { line: '    while (!q.empty()) {', id: 11 },
            { line: '        int course = q.front(); q.pop();', id: 12 },
            { line: '        order.push_back(course);', id: 13 },
            { line: '        for (int next : graph[course]) {', id: 14 },
            { line: '            if (--inDegree[next] == 0) q.push(next);', id: 15 },
            { line: '        }', id: 16 },
            { line: '    }', id: 17 },
            { line: '    return order.size() == numCourses ? order : {};', id: 18 },
            { line: '}', id: 19 },
        ];
        
        const examples = {
            1: { n: 4, prereqs: [[1,0],[2,0],[3,1],[3,2]], desc: '0â†’{1,2}â†’3' },
            2: { n: 3, prereqs: [[0,1],[1,2],[2,0]], desc: 'ç’°: 0â†’1â†’2â†’0' }
        };
        
        let currentExample = examples[1];

        function setExample(n) {
            currentExample = examples[n];
            init();
        }

        function generateAlgorithmSteps(numCourses, prereqs) {
            const steps = [];
            const inDegree = Array(numCourses).fill(0);
            const graph = Array(numCourses).fill(null).map(() => []);
            
            for (const [a, b] of prereqs) {
                graph[b].push(a);
                inDegree[a]++;
            }
            
            const prereqStr = prereqs.map(p => `${p[1]}â†’${p[0]}`).join(', ');
            
            steps.push({
                visited: [], order: [], inDegree: [...inDegree], current: null,
                highlightLines: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10],
                explanation: { 
                    title: 'åˆå§‹åŒ–', 
                    text: `${numCourses} é–€èª²ç¨‹<br>å…ˆä¿®: ${prereqStr || 'ç„¡'}<br>å…¥åº¦ 0 çš„èª²ç¨‹å¯ä»¥å…ˆä¿®`,
                    formula: 'setup'
                }
            });

            const queue = [];
            for (let i = 0; i < numCourses; i++) {
                if (inDegree[i] === 0) queue.push(i);
            }
            
            const order = [];
            const visited = [];

            while (queue.length > 0) {
                const course = queue.shift();
                order.push(course);
                visited.push(course);
                
                steps.push({
                    visited: [...visited], order: [...order], inDegree: [...inDegree], current: course,
                    highlightLines: [11, 12, 13],
                    explanation: { 
                        title: `ä¿®èª²ç¨‹ ${course}`, 
                        text: `å…¥åº¦ = 0ï¼Œå¯ä»¥ä¿®<br>åŠ å…¥é †åº`,
                        formula: `order += ${course}`
                    }
                });

                for (const next of graph[course]) {
                    inDegree[next]--;
                    if (inDegree[next] === 0) {
                        queue.push(next);
                        
                        steps.push({
                            visited: [...visited], order: [...order], inDegree: [...inDegree], current: course,
                            highlightLines: [14, 15],
                            explanation: { 
                                title: `æ›´æ–°èª²ç¨‹ ${next}`, 
                                text: `å…¥åº¦ -1 = ${inDegree[next]}<br>ç¾åœ¨å¯ä»¥ä¿®äº†ï¼`,
                                formula: `inDegree[${next}] = 0`
                            }
                        });
                    }
                }
            }

            const success = order.length === numCourses;
            steps.push({
                visited, order, inDegree, final: true, success,
                highlightLines: [18],
                explanation: { 
                    title: success ? 'å®Œæˆ!' : 'å¤±æ•—!', 
                    text: success 
                        ? `ä¿®èª²é †åº: [${order.join(', ')}]`
                        : `ç„¡æ³•å®Œæˆæ‰€æœ‰èª²ç¨‹<br>å­˜åœ¨å¾ªç’°ä¾è³´`,
                    formula: success ? `return [${order.join(',')}]` : 'return []'
                }
            });

            return steps;
        }

        let viz;
        function init() {
            const { n, prereqs } = currentExample;
            
            viz = new AlgorithmVisualizer({
                codeLines: codeStructure,
                onStepChange: (step) => {
                    // Nodes
                    let html = '';
                    for (let i = 0; i < n; i++) {
                        let cls = 'node';
                        if (step.visited?.includes(i)) cls += ' visited';
                        if (i === step.current) cls += ' current';
                        html += `<div class="${cls}">${i}</div>`;
                    }
                    document.getElementById('graphDisplay').innerHTML = html;
                    
                    // In-degree
                    document.getElementById('indegreeDisplay').innerHTML = 
                        (step.inDegree || []).map((deg, i) => 
                            `<span class="indegree-item">${i}: ${deg}</span>`
                        ).join('');
                    
                    // Result
                    const order = step.order || [];
                    if (order.length > 0) {
                        document.getElementById('resultDisplay').innerHTML = 
                            '<span class="result-label">é †åº:</span>' +
                            order.map((c, i) => 
                                `<div class="result-item">${c}</div>${i < order.length - 1 ? '<span class="result-arrow">â†’</span>' : ''}`
                            ).join('');
                    } else {
                        document.getElementById('resultDisplay').innerHTML = 
                            '<span style="color: var(--viz-text-muted)">ç­‰å¾…...</span>';
                    }
                }
            });
            viz.setSteps(generateAlgorithmSteps(n, prereqs));
        }
        
        function resetVisualization() { init(); }
        window.addEventListener('load', init);
    </script>
</body>
</html>
