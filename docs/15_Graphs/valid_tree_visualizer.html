<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Graph Valid Tree - è¦–è¦ºåŒ–</title>
    <link rel="stylesheet" href="../assets/visualizer/style.css">
    <style>
        .custom-input-section { background: var(--viz-card-bg); border-radius: 8px; padding: 15px; margin-bottom: 15px; border: 1px solid var(--viz-border); }
        .input-row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .input-row button { padding: 8px 16px; border-radius: 6px; background: var(--viz-primary); color: white; border: none; cursor: pointer; }

        .graph-container { display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; margin: 20px 0; }
        .node { 
            width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; 
            font-weight: bold; border-radius: 50%; background: var(--viz-primary); color: white;
            transition: all 0.3s;
        }
        .node.connected { background: var(--viz-success); color: #0f172a; }

        .edges-container { display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; margin: 10px 0; }
        .edge { padding: 6px 12px; background: var(--viz-bg-secondary); border-radius: 4px; font-size: 0.85rem; transition: all 0.3s; }
        .edge.processing { background: var(--viz-warning); color: #0f172a; }
        .edge.added { background: var(--viz-success); color: #0f172a; }

        .conditions-container { 
            padding: 15px; background: var(--viz-bg-secondary); border-radius: 8px; margin: 15px 0;
        }
        .condition { display: flex; align-items: center; gap: 10px; margin: 8px 0; font-size: 0.95rem; }
        .condition-icon { font-size: 1.2rem; width: 30px; text-align: center; }
    </style>
</head>
<body>
    <button class="theme-toggle" onclick="AlgorithmVisualizer.toggleTheme()" title="åˆ‡æ›ä¸»é¡Œ">ğŸŒ“</button>
    <div class="main-layout">
        <div class="canvas-area">
            <div class="viz-card">
                <div class="viz-title">åœ–æ˜¯å¦ç‚ºæ¨¹ (Graph Valid Tree)</div>
                <div class="custom-input-section">
                    <div style="font-weight:bold; margin-bottom:5px;">ğŸ® è‡ªè¨‚æ¸¬è©¦</div>
                    <div class="input-row">
                        <button onclick="setExample(1)">ç¯„ä¾‹1 (æ˜¯æ¨¹)</button>
                        <button onclick="setExample(2)">ç¯„ä¾‹2 (æœ‰ç’°)</button>
                        <button onclick="setExample(3)">ç¯„ä¾‹3 (ä¸é€£é€š)</button>
                        <button onclick="resetVisualization()">â†» é‡ç½®</button>
                    </div>
                </div>
                
                <div class="graph-container" id="graphDisplay"></div>
                
                <div style="text-align: center; color: var(--viz-text-muted);">é‚Š</div>
                <div class="edges-container" id="edgesDisplay"></div>
                
                <div class="conditions-container" id="conditionsDisplay"></div>

                <div class="controls" style="margin-top: 15px;">
                    <button class="viz-btn" id="prevBtn">â† ä¸Šä¸€æ­¥</button>
                    <div class="step-indicator">æ­¥é©Ÿ <span id="currentStep">0</span> / <span id="totalSteps">0</span></div>
                    <button class="viz-btn primary" id="nextBtn">ä¸‹ä¸€æ­¥ â†’</button>
                    <div class="speed-control">
                        <label>é€Ÿåº¦:</label>
                        <select id="speedSelect" onchange="viz.setSpeed(Number(this.value))">
                            <option value="1500">1x</option>
                            <option value="800">2x</option>
                        </select>
                    </div>
                </div>
                
                <div class="complexity-badge">
                    <span class="label">Time:</span> O(nÂ·Î±(n)) â‰ˆ O(n)
                    <span class="label" style="margin-left: 12px;">Space:</span> O(n)
                </div>
                <div class="state-grid">
                    <div class="state-item"><div class="state-label">çµæœ</div><div class="state-value" id="resultDisplay">-</div></div>
                </div>
            </div>
            <div class="viz-card"><div class="viz-title">æ¼”ç®—æ³•èªªæ˜</div><div class="explanation" id="explanation"></div></div>
        </div>
        <div class="code-area">
            <div class="viz-card" style="height: 100%;">
                <div class="viz-title">æ¼”ç®—æ³• (C++)</div>
                <div class="code-panel" id="codeDisplay"></div>
            </div>
        </div>
    </div>
    <script src="../assets/visualizer/core.js"></script>
    <script>
        const codeStructure = [
            { line: 'bool validTree(int n, vector<vector<int>>& edges) {', id: 0 },
            { line: '    // æ¨¹çš„æ¢ä»¶:', id: 1 },
            { line: '    // 1. é‚Šæ•¸ = n - 1', id: 2 },
            { line: '    // 2. ç„¡ç’° (Union-Find æª¢æ¸¬)', id: 3 },
            { line: '    if (edges.size() != n - 1) return false;', id: 4 },
            { line: '    vector<int> parent(n);', id: 5 },
            { line: '    iota(parent.begin(), parent.end(), 0);', id: 6 },
            { line: '    for (auto& e : edges) {', id: 7 },
            { line: '        int p1 = find(e[0]), p2 = find(e[1]);', id: 8 },
            { line: '        if (p1 == p2) return false;', id: 9 },
            { line: '        parent[p1] = p2;', id: 10 },
            { line: '    }', id: 11 },
            { line: '    return true;', id: 12 },
            { line: '}', id: 13 },
        ];
        
        const examples = {
            1: { n: 5, edges: [[0,1],[0,2],[0,3],[1,4]], desc: 'æœ‰æ•ˆæ¨¹' },
            2: { n: 5, edges: [[0,1],[1,2],[2,3],[1,3],[1,4]], desc: 'æœ‰ç’° (5é‚Š)' },
            3: { n: 4, edges: [[0,1],[2,3]], desc: 'ä¸é€£é€š (2é‚Š)' }
        };
        
        let currentExample = examples[1];

        function setExample(n) {
            currentExample = examples[n];
            init();
        }

        function generateAlgorithmSteps(n, edges) {
            const steps = [];
            
            // Check edge count
            const edgeCountOk = edges.length === n - 1;
            
            steps.push({
                connected: [], processedEdges: [],
                cond1: null, cond2: null,
                highlightLines: [0, 1, 2, 3, 4],
                explanation: { 
                    title: 'åˆå§‹åŒ–', 
                    text: `n = ${n}, é‚Šæ•¸ = ${edges.length}<br><br>æ¨¹çš„æ¢ä»¶:<br>1. é‚Šæ•¸ = n-1 = ${n-1}<br>2. ç„¡ç’°`,
                    formula: 'setup'
                }
            });

            steps.push({
                connected: [], processedEdges: [],
                cond1: edgeCountOk, cond2: null,
                highlightLines: [4],
                explanation: { 
                    title: 'æª¢æŸ¥é‚Šæ•¸', 
                    text: `é‚Šæ•¸ = ${edges.length}, n-1 = ${n-1}<br>${edgeCountOk ? 'âœ“ ç¬¦åˆ' : 'âœ— ä¸ç¬¦åˆ'}`,
                    formula: edgeCountOk ? 'pass' : 'return false'
                }
            });

            if (!edgeCountOk) {
                steps.push({
                    connected: [], processedEdges: [],
                    cond1: false, cond2: null, result: false, final: true,
                    highlightLines: [4],
                    explanation: { title: 'ä¸æ˜¯æ¨¹!', text: 'é‚Šæ•¸ â‰  n-1', formula: 'return false' }
                });
                return steps;
            }

            // Union-Find
            const parent = Array.from({ length: n }, (_, i) => i);
            function find(x) {
                if (parent[x] !== x) parent[x] = find(parent[x]);
                return parent[x];
            }

            let hasCycle = false;
            const processedEdges = [];
            const connected = new Set();

            for (let i = 0; i < edges.length && !hasCycle; i++) {
                const [a, b] = edges[i];
                const p1 = find(a), p2 = find(b);
                
                if (p1 === p2) {
                    hasCycle = true;
                    steps.push({
                        connected: [...connected], processedEdges: [...processedEdges, i],
                        cond1: true, cond2: false, cycleEdge: i,
                        highlightLines: [8, 9],
                        explanation: { 
                            title: `é‚Š [${a},${b}] - ç’°!`, 
                            text: `find(${a}) = find(${b}) = ${p1}<br>å·²ç¶“é€£é€šï¼Œå½¢æˆç’°!`,
                            formula: 'return false'
                        }
                    });
                } else {
                    parent[p1] = p2;
                    connected.add(a);
                    connected.add(b);
                    processedEdges.push(i);
                    
                    steps.push({
                        connected: [...connected], processedEdges: [...processedEdges],
                        cond1: true, cond2: null, currentEdge: i,
                        highlightLines: [7, 8, 10],
                        explanation: { 
                            title: `é‚Š [${a},${b}]`, 
                            text: `find(${a})=${p1}, find(${b})=${p2}<br>ä¸åŒé›†åˆï¼Œåˆä½µ`,
                            formula: `union(${a},${b})`
                        }
                    });
                }
            }

            const isTree = !hasCycle;
            steps.push({
                connected: [...connected], processedEdges,
                cond1: true, cond2: !hasCycle, result: isTree, final: true,
                highlightLines: isTree ? [12] : [9],
                explanation: { 
                    title: isTree ? 'æ˜¯æœ‰æ•ˆæ¨¹!' : 'ä¸æ˜¯æ¨¹!', 
                    text: isTree ? 'æ»¿è¶³æ‰€æœ‰æ¢ä»¶' : 'å­˜åœ¨ç’°',
                    formula: `return ${isTree}`
                }
            });

            return steps;
        }

        let viz;
        function init() {
            const { n, edges } = currentExample;
            
            viz = new AlgorithmVisualizer({
                codeLines: codeStructure,
                onStepChange: (step) => {
                    // Nodes
                    document.getElementById('graphDisplay').innerHTML = 
                        Array.from({ length: n }, (_, i) => {
                            const cls = step.connected?.includes(i) ? 'node connected' : 'node';
                            return `<div class="${cls}">${i}</div>`;
                        }).join('');
                    
                    // Edges
                    document.getElementById('edgesDisplay').innerHTML = 
                        edges.map((e, i) => {
                            let cls = 'edge';
                            if (step.processedEdges?.includes(i)) cls += ' added';
                            if (step.currentEdge === i) cls += ' processing';
                            if (step.cycleEdge === i) cls = 'edge processing';
                            return `<span class="${cls}">[${e[0]},${e[1]}]</span>`;
                        }).join('');
                    
                    // Conditions
                    const c1 = step.cond1, c2 = step.cond2;
                    document.getElementById('conditionsDisplay').innerHTML = `
                        <div class="condition">
                            <span class="condition-icon">${c1 === true ? 'âœ…' : (c1 === false ? 'âŒ' : 'â³')}</span>
                            é‚Šæ•¸ = n - 1 (${edges.length} = ${n - 1}?)
                        </div>
                        <div class="condition">
                            <span class="condition-icon">${c2 === true ? 'âœ…' : (c2 === false ? 'âŒ' : 'â³')}</span>
                            ç„¡ç’°ä¸”å…¨é€£é€š
                        </div>
                    `;
                    
                    // Result
                    if (step.result !== undefined) {
                        document.getElementById('resultDisplay').textContent = step.result ? 'True âœ“' : 'False âœ—';
                        document.getElementById('resultDisplay').style.color = step.result ? 'var(--viz-success)' : 'var(--viz-error)';
                    } else {
                        document.getElementById('resultDisplay').textContent = '-';
                        document.getElementById('resultDisplay').style.color = 'inherit';
                    }
                }
            });
            viz.setSteps(generateAlgorithmSteps(n, edges));
        }
        
        function resetVisualization() { init(); }
        window.addEventListener('load', init);
    </script>
</body>
</html>
