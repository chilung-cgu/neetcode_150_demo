<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minimum Interval Query - è¦–è¦ºåŒ–</title>
    <link rel="stylesheet" href="../assets/visualizer/style.css">
    <style>
        .custom-input-section { background: var(--viz-card-bg); border-radius: 8px; padding: 15px; margin-bottom: 15px; border: 1px solid var(--viz-border); }
        .input-row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-bottom: 8px; }
        .input-row input { padding: 8px 12px; border-radius: 6px; border: 1px solid var(--viz-border); background: var(--viz-input-bg); color: var(--viz-text); font-family: monospace; }
        .input-row button { padding: 8px 16px; border-radius: 6px; background: var(--viz-primary); color: white; border: none; cursor: pointer; }

        .intervals-container { display: flex; flex-direction: column; gap: 5px; margin: 20px 0; }
        .interval { 
            height: 24px; border-radius: 4px; display: flex; align-items: center; justify-content: center; 
            font-family: monospace; font-size: 0.75rem; color: white; background: var(--viz-primary);
            transition: all 0.3s; border: 2px solid transparent;
        }
        .interval.highlight { background: var(--viz-success); color: #0f172a; border-color: white; }
        
        .queries-container { display: flex; gap: 8px; justify-content: center; margin: 15px 0; flex-wrap: wrap; }
        .query { 
            padding: 8px 14px; border-radius: 6px; font-family: monospace; 
            background: var(--viz-bg-secondary); transition: all 0.3s;
        }
        .query.current { background: var(--viz-warning); color: #0f172a; font-weight: bold; }
        .query.done { background: var(--viz-success); color: #0f172a; }
    </style>
</head>
<body>
    <button class="theme-toggle" onclick="AlgorithmVisualizer.toggleTheme()" title="åˆ‡æ›ä¸»é¡Œ">ğŸŒ“</button>
    <div class="main-layout">
        <div class="canvas-area">
            <div class="viz-card">
                <div class="viz-title">æœ€å°å€é–“æŸ¥è©¢ (Minimum Interval Query)</div>
                <div class="custom-input-section">
                    <div style="font-weight:bold; margin-bottom:5px;">ğŸ® è‡ªè¨‚æ¸¬è©¦</div>
                    <div class="input-row">
                        <label>å€é–“:</label>
                        <input type="text" id="intervalsInput" value="1,4;2,4;3,6;4,4" style="width: 140px;">
                        <label>æŸ¥è©¢:</label>
                        <input type="text" id="queriesInput" value="2,3,4,5" style="width: 100px;">
                        <button onclick="runCustomInput()">åŸ·è¡Œ</button>
                    </div>
                </div>
                
                <div class="intervals-container" id="intervalsDisplay"></div>
                
                <div style="text-align: center; color: var(--viz-text-muted); font-size: 0.9rem;">æŸ¥è©¢:</div>
                <div class="queries-container" id="queriesDisplay"></div>

                <div class="controls" style="margin-top: 15px;">
                    <button class="viz-btn" id="prevBtn">â† ä¸Šä¸€æ­¥</button>
                    <div class="step-indicator">æ­¥é©Ÿ <span id="currentStep">0</span> / <span id="totalSteps">0</span></div>
                    <button class="viz-btn primary" id="nextBtn">ä¸‹ä¸€æ­¥ â†’</button>
                    <button class="viz-btn" onclick="resetVisualization()">â†» é‡ç½®</button>
                    <div class="speed-control">
                        <label>é€Ÿåº¦:</label>
                        <select id="speedSelect" onchange="viz.setSpeed(Number(this.value))">
                            <option value="1500">1x</option>
                            <option value="500">2x</option>
                        </select>
                    </div>
                </div>
                
                <div class="complexity-badge">
                    <span class="label">Time:</span> O((n+q) log n)
                    <span class="label" style="margin-left: 12px;">Space:</span> O(n+q)
                </div>
            </div>
            <div class="viz-card"><div class="viz-title">æ¼”ç®—æ³•èªªæ˜</div><div class="explanation" id="explanation"></div></div>
        </div>
        <div class="code-area">
            <div class="viz-card" style="height: 100%;">
                <div class="viz-title">æ¼”ç®—æ³• (C++)</div>
                <div class="code-panel" id="codeDisplay"></div>
            </div>
        </div>
    </div>
    <script src="../assets/visualizer/core.js"></script>
    <script>
        const codeStructure = [
            { line: 'vector<int> minInterval(intervals, queries) {', id: 0 },
            { line: '    sort(intervals by start);', id: 1 },
            { line: '    // Sort queries with original indices', id: 2 },
            { line: '    priority_queue<pair<int,int>, vec, greater<>> minHeap;', id: 3 },
            { line: '    for each query q (sorted):', id: 4 },
            { line: '        // Add intervals with start <= q', id: 5 },
            { line: '        // Remove intervals with end < q', id: 6 },
            { line: '        // Answer = minHeap.top().first (smallest size)', id: 7 },
            { line: '    return result (original order);', id: 8 },
            { line: '}', id: 9 },
        ];
        
        let currentIntervals = [[1, 4], [2, 4], [3, 6], [4, 4]];
        let currentQueries = [2, 3, 4, 5];

        function runCustomInput() {
            const iStr = document.getElementById('intervalsInput').value;
            const qStr = document.getElementById('queriesInput').value;
            
            const intervals = iStr.split(';').map(s => s.split(',').map(x => parseInt(x.trim()))).filter(a => a.length === 2 && !isNaN(a[0]));
            const queries = qStr.split(',').map(x => parseInt(x.trim())).filter(x => !isNaN(x));
            
            if (intervals.length < 1 || intervals.length > 6 || queries.length < 1 || queries.length > 6) {
                alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„å€é–“ (1-6å€‹) å’ŒæŸ¥è©¢ (1-6å€‹)');
                return;
            }
            currentIntervals = intervals;
            currentQueries = queries;
            init();
        }

        function generateAlgorithmSteps(intervals, queries) {
            const steps = [];
            const sorted = [...intervals].sort((a, b) => a[0] - b[0]);
            const answers = [];
            
            steps.push({
                currentQuery: -1, answers: [], highlightIntervals: [],
                highlightLines: [0, 1, 2, 3],
                explanation: { title: 'åˆå§‹åŒ–', text: `å€é–“æŒ‰èµ·å§‹æ’åº<br>æŸ¥è©¢ä¹Ÿæ’åºï¼Œè¨˜ä½åŸå§‹ç´¢å¼•`, formula: 'setup' }
            });

            // Sort queries with indices
            const sortedQueries = queries.map((q, i) => [q, i]).sort((a, b) => a[0] - b[0]);
            
            for (const [q, origIdx] of sortedQueries) {
                // Find all intervals that contain query
                const containing = [];
                for (let i = 0; i < intervals.length; i++) {
                    if (intervals[i][0] <= q && intervals[i][1] >= q) {
                        containing.push(i);
                    }
                }
                
                // Find minimum size
                let minSize = -1;
                let minIdx = -1;
                for (const idx of containing) {
                    const size = intervals[idx][1] - intervals[idx][0] + 1;
                    if (minSize === -1 || size < minSize) {
                        minSize = size;
                        minIdx = idx;
                    }
                }
                
                answers[origIdx] = minSize;
                
                steps.push({
                    currentQuery: origIdx, answers: [...answers], 
                    highlightIntervals: containing, bestInterval: minIdx,
                    highlightLines: [4, 5, 6, 7],
                    explanation: { 
                        title: `æŸ¥è©¢ ${q}`, 
                        text: containing.length > 0 
                            ? `åŒ…å« ${q} çš„å€é–“æœ‰ ${containing.length} å€‹<br>æœ€å°å€é–“å¤§å° = ${minSize}`
                            : `ç„¡å€é–“åŒ…å« ${q}<br>ç­”æ¡ˆ = -1`,
                        formula: `answer = ${minSize}`
                    }
                });
            }

            steps.push({
                currentQuery: -1, answers, final: true,
                highlightLines: [8],
                explanation: { title: 'å®Œæˆ!', text: `çµæœ: [${answers.join(', ')}]`, formula: `return [${answers.join(', ')}]` }
            });

            return steps;
        }

        let viz;
        function init() {
            viz = new AlgorithmVisualizer({
                codeLines: codeStructure,
                onStepChange: (step) => {
                    const maxVal = Math.max(...currentIntervals.flat(), ...currentQueries) + 1;
                    const scale = 300 / maxVal;
                    
                    // Intervals
                    let html = '';
                    currentIntervals.forEach((int, i) => {
                        const width = (int[1] - int[0] + 1) * scale;
                        const left = (int[0] - 1) * scale;
                        const isHighlight = step.highlightIntervals?.includes(i);
                        const isBest = step.bestInterval === i;
                        
                        let cls = 'interval';
                        if (isHighlight) cls += ' highlight';
                        
                        html += `<div class="${cls}" style="margin-left:${left}px;width:${width}px;${isBest ? 'border-color:var(--viz-warning);' : ''}">[${int[0]},${int[1]}] size=${int[1] - int[0] + 1}</div>`;
                    });
                    document.getElementById('intervalsDisplay').innerHTML = html;

                    // Queries
                    document.getElementById('queriesDisplay').innerHTML = currentQueries.map((q, i) => {
                        let cls = 'query';
                        if (step.currentQuery === i) cls += ' current';
                        else if (step.answers?.[i] !== undefined) cls += ' done';
                        
                        const ans = step.answers?.[i];
                        return `<span class="${cls}">${q}${ans !== undefined ? ' â†’ ' + ans : ''}</span>`;
                    }).join('');
                }
            });
            viz.setSteps(generateAlgorithmSteps(currentIntervals, currentQueries));
        }
        
        function resetVisualization() { init(); }
        window.addEventListener('load', init);
    </script>
</body>
</html>
